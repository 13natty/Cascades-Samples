<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- scoreloopintegration.qdoc -->
  <title>Cascades : Scoreloop Integration Example</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt-based BB10 API Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
<li><a href="http://qt.nokia.com/doc/4.7/all-examples.html">Examples</a></li>
<li>Scoreloop Integration Example</li>
    </ul>
  </div>
</div>
<div class="content mainContent">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#description">Description</a></li>
<li class="level1"><a href="#overview">Overview</a></li>
<li class="level1"><a href="#the-ui">The UI</a></li>
<li class="level1"><a href="#the-scoreloopsamplecascades-class">The ScoreloopSampleCascades class</a></li>
<li class="level1"><a href="#the-scoreloopbpseventhandler-class">The ScoreloopBpsEventHandler class</a></li>
<li class="level1"><a href="#the-scoreloopdata-class">The ScoreloopData class</a></li>
</ul>
</div>
<h1 class="title">Scoreloop Integration Example</h1>
<span class="subtitle"></span>
<!-- $$$scoreloopintegration-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="scoreloopintegration-assets-main-qml.html">scoreloopintegration/assets/main.qml</a></li>
<li><a href="scoreloopintegration-src-scoreloopbpseventhandler-cpp.html">scoreloopintegration/src/ScoreloopBpsEventHandler.cpp</a></li>
<li><a href="scoreloopintegration-src-scoreloopbpseventhandler-hpp.html">scoreloopintegration/src/ScoreloopBpsEventHandler.hpp</a></li>
<li><a href="scoreloopintegration-src-scoreloopdata-cpp.html">scoreloopintegration/src/ScoreloopData.cpp</a></li>
<li><a href="scoreloopintegration-src-scoreloopdata-hpp.html">scoreloopintegration/src/ScoreloopData.hpp</a></li>
<li><a href="scoreloopintegration-src-scoreloopdefines-hpp.html">scoreloopintegration/src/ScoreloopDefines.hpp</a></li>
<li><a href="scoreloopintegration-src-scoreloopsamplecascades-cpp.html">scoreloopintegration/src/ScoreloopSampleCascades.cpp</a></li>
<li><a href="scoreloopintegration-src-scoreloopsamplecascades-hpp.html">scoreloopintegration/src/ScoreloopSampleCascades.hpp</a></li>
<li><a href="scoreloopintegration-src-main-cpp.html">scoreloopintegration/src/main.cpp</a></li>
<li><a href="scoreloopintegration-scoreloopintegration-pro.html">scoreloopintegration/scoreloopintegration.pro</a></li>
<li><a href="scoreloopintegration-translations-scoreloopintegration-pro.html">scoreloopintegration/translations/scoreloopintegration.pro</a></li>
</ul>
<a name="description"></a>
<h2>Description</h2>
<p>The Scoreloop Integration Example retrieves the user name from the Scoreloop gaming service.</p>
<p class="centerAlign"><img src="images/scoreloopintegration-example.png" /></p><a name="overview"></a>
<h2>Overview</h2>
<p>In this example we'll learn how to use the Scoreloop API of the BB10 platform to retrieve the user name that is associated with the device. Currently the BB10 platform provides only a C API for accessing the Scoreloop service, so this example contains some glue code to intermediate between the C API and the QML UI.</p>
<a name="the-ui"></a>
<h2>The UI</h2>
<p>The UI of this sample application consists of a single page with a <tt>Label</tt> that shows the user name and a <tt>Button</tt> to reload the user name from the Scoreloop service.</p>
<p>The business logic of this application is encapsulated in the C++ class <tt>ScoreloopData</tt>, which is exported to the UI under the name '_scoreloop'.</p>
<pre class="qml">                <span class="type">Label</span> {
                    <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>

                    <span class="name">text</span>: <span class="name">_scoreloop</span>.<span class="name">userName</span>
                    <span class="type">textStyle</span> {
                        <span class="name">color</span>: <span class="name">Color</span>.<span class="name">White</span>
                    }
                }</pre>
<p>The <tt>ScoreloopData</tt> object provides a property 'userName' that is either empty (if no name has been loaded yet from the service) or contains the name that the Scoreloop service has associated with this device. We simply bind this property against the 'text' property of the <tt>Label</tt> for automatic updates.</p>
<pre class="qml">                <span class="type">Button</span> {
                    <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>
                    <span class="name">topMargin</span>: <span class="number">100</span>

                    <span class="name">text</span>: <span class="name">qsTr</span>(<span class="string">&quot;Reload&quot;</span>)

                    <span class="name">onClicked</span>: {
                        <span class="name">console</span>.<span class="name">log</span>(<span class="string">&quot;scoreloop: &quot;</span> <span class="operator">+</span> <span class="name">_scoreloop</span>);
                        <span class="name">console</span>.<span class="name">log</span>(<span class="string">&quot;scoreloop.userName: &quot;</span> <span class="operator">+</span> <span class="name">_scoreloop</span>.<span class="name">userName</span>);
                        <span class="name">_scoreloop</span>.<span class="name">load</span>();
                    }
                }</pre>
<p>Whenever the user clicks on the 'Reload' button, we invoke the load() method of the <tt>ScoreloopData</tt> object, which will trigger the reload of the user name from the Scoreloop service.</p>
<a name="the-scoreloopsamplecascades-class"></a>
<h2>The ScoreloopSampleCascades class</h2>
<p>The <tt>ScoreloopSampleCascades</tt> class is the central class which creates the UI and initializes the connection to the Scoreloop service.</p>
<pre class="cpp">    <span class="keyword">class</span> ScoreloopSampleCascades : <span class="keyword">public</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>
    {
        Q_OBJECT

    <span class="keyword">public</span>:
        ScoreloopSampleCascades(bb<span class="operator">::</span>cascades<span class="operator">::</span>Application <span class="operator">*</span>app);
        <span class="operator">~</span>ScoreloopSampleCascades();

    <span class="keyword">private</span>:
        SC_InitData_t m_initData;
        SC_Client_h m_client;

        ScoreloopBpsEventHandler<span class="operator">*</span> m_eventHandler;
    };</pre>
<p>Inside the constructor the SC_InitData_Init method of the Scoreloop C API is used to initialize the data structures and with SC_Client_New a new connection to the Scoreloop service is established. The parameters of this method describe the game you want to use the Scoreloop service for, in this example we use the SL Demo TNG game as dummy data.</p>
<pre class="cpp">    <span class="comment">/* These are the game id and game secret from the SL Demo TNG game - use your credentials (and SLAward.bundle) instead */</span>
    <span class="preprocessor">#define GAME_ID         &quot;f9fa2829-532c-4c71-856f-96b585a135db&quot;</span>
    <span class="preprocessor">#define GAME_SECRET     &quot;I1mpr5hwWh3yIEEaJXCizB6FS4gnvhrVTSSpuM0uGhoDNZU60ykWGw==&quot;</span>
    <span class="preprocessor">#define GAME_VERSION    &quot;1.0&quot;</span>
    <span class="preprocessor">#define GAME_CURRENCY   &quot;XPT&quot;</span>
    <span class="preprocessor">#define GAME_LANGUAGE   &quot;en&quot;</span></pre>
<p>If the connection has been established successfully, a <tt>ScoreloopBpsEventHandler</tt> object is created, which integrates the Scoreloop event handler with the BPS event loop (see below), and the <tt>ScoreloopData</tt> object is instantiated and the initial load of the user name is triggered.</p>
<pre class="cpp">    ScoreloopSampleCascades<span class="operator">::</span>ScoreloopSampleCascades(bb<span class="operator">::</span>cascades<span class="operator">::</span>Application <span class="operator">*</span>app)
        : <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>(app)
        <span class="operator">,</span> m_eventHandler(<span class="number">0</span>)
    {
        <span class="comment">// Initialize the Scoreloop platform dependent SC_InitData_t structure to default values.</span>
        SC_InitData_Init(<span class="operator">&amp;</span>m_initData);

        <span class="comment">// Create Client instance</span>
        <span class="keyword">const</span> SC_Error_t rc <span class="operator">=</span> SC_Client_New(<span class="operator">&amp;</span>m_client<span class="operator">,</span> <span class="operator">&amp;</span>m_initData<span class="operator">,</span> GAME_ID<span class="operator">,</span> GAME_SECRET<span class="operator">,</span> GAME_VERSION<span class="operator">,</span> GAME_CURRENCY<span class="operator">,</span> GAME_LANGUAGE);

        ScoreloopData <span class="operator">*</span>scoreloopData <span class="operator">=</span> <span class="number">0</span>;

        <span class="keyword">if</span> (rc <span class="operator">=</span><span class="operator">=</span> SC_OK) {
            <span class="comment">// Plug Scoreloop into the BPS Event Loop</span>
            m_eventHandler <span class="operator">=</span> <span class="keyword">new</span> ScoreloopBpsEventHandler(m_initData);

            <span class="comment">// Create ScoreloopData object to expose data to QML</span>
            scoreloopData <span class="operator">=</span> <span class="keyword">new</span> ScoreloopData(m_client<span class="operator">,</span> <span class="keyword">this</span>);

            <span class="comment">// Start loading. signals will fire when done.</span>
            scoreloopData<span class="operator">-</span><span class="operator">&gt;</span>load();
        } <span class="keyword">else</span> {
            <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;Could not initialize Scoreloop: &quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> SC_MapErrorToStr(rc);
        }

        <span class="comment">// Create scene document from main.qml asset</span>
        <span class="comment">// Set parent to created document to ensure it exists for the whole application lifetime</span>
        QmlDocument <span class="operator">*</span>qml <span class="operator">=</span> QmlDocument<span class="operator">::</span>create(<span class="string">&quot;asset:///main.qml&quot;</span>)<span class="operator">.</span>parent(<span class="keyword">this</span>);

        <span class="comment">// Make ScoreloopData available in qml</span>
        qml<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(<span class="string">&quot;_scoreloop&quot;</span><span class="operator">,</span> scoreloopData);

        <span class="comment">// Create root object for the UI</span>
        AbstractPane <span class="operator">*</span>root <span class="operator">=</span> qml<span class="operator">-</span><span class="operator">&gt;</span>createRootObject<span class="operator">&lt;</span>AbstractPane<span class="operator">&gt;</span>();

        <span class="comment">// Set created root object as a scene</span>
        app<span class="operator">-</span><span class="operator">&gt;</span>setScene(root);
    }</pre>
<p>After the initialization of the business logic has been finished, the UI is loaded from main.qml and the <tt>ScoreloopData</tt> object is exported to QML.</p>
<a name="the-scoreloopbpseventhandler-class"></a>
<h2>The ScoreloopBpsEventHandler class</h2>
<p>The <tt>ScoreloopBpsEventHandler</tt> class integrates the Scoreloop event handler with the BPS event loop. For this, it inherits from <tt>bb::AbstractBpsEventHandler</tt> and reimplements the virtual event() method.</p>
<pre class="cpp">    <span class="keyword">class</span> ScoreloopBpsEventHandler : <span class="keyword">protected</span> bb<span class="operator">::</span>AbstractBpsEventHandler
    {
    <span class="keyword">public</span>:
        ScoreloopBpsEventHandler(SC_InitData_t initData);

        <span class="comment">// Reimplemented from AbstractBpsEventHandler, called whenever a new BPS event is received</span>
        <span class="type">void</span> event(bps_event_t <span class="operator">*</span>event);

    <span class="keyword">private</span>:
        SC_InitData_t m_initData;
    };</pre>
<p>Inside the constructor we subscribe to the Scoreloop event domain, so that the event() method will be invoked whenever an event from this domain is handled by the BPS event loop.</p>
<pre class="cpp">    ScoreloopBpsEventHandler<span class="operator">::</span>ScoreloopBpsEventHandler(SC_InitData_t initData)
        : m_initData(initData)
    {
        <span class="comment">/**
         * Subscribe to the Scoreloop event domain.
         *
         * Note: This only works after SC_Client_New was called
         */</span>
        subscribe(SC_GetBPSEventDomain(<span class="operator">&amp;</span>m_initData));
    }</pre>
<p>Whenever the event() method is called, we forward the event object to the Scoreloop event handler.</p>
<pre class="cpp">    <span class="type">void</span> ScoreloopBpsEventHandler<span class="operator">::</span>event(bps_event_t <span class="operator">*</span>event)
    {
        <span class="comment">// Pass the event to the Scoreloop event handler</span>
        SC_HandleBPSEvent(<span class="operator">&amp;</span>m_initData<span class="operator">,</span> event);
    }</pre>
<a name="the-scoreloopdata-class"></a>
<h2>The ScoreloopData class</h2>
<p>The <tt>ScoreloopData</tt> class encapsulates the access to the Scoreloop service and provides the high-level API of properties, signals and slots to the UI. To keep the code simple in this example, we only provide access to the user name through a property and offer a slot to trigger a reload of the user name from the service.</p>
<pre class="cpp">    <span class="keyword">class</span> ScoreloopData : <span class="keyword">public</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>
    {
        Q_OBJECT

        <span class="comment">// The name of the user at the Scoreloop service</span>
        Q_PROPERTY(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> userName READ userName NOTIFY userNameChanged);

    <span class="keyword">public</span>:
        <span class="comment">// Creates a new ScoreloopData object</span>
        ScoreloopData(SC_Client_h client<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent <span class="operator">=</span> <span class="number">0</span>);

    <span class="keyword">public</span> Q_SLOTS:
        <span class="comment">// Triggers the load of the user name from the Scoreloop service</span>
        <span class="type">void</span> load();

    Q_SIGNALS:
        <span class="comment">// The change notification signal of the property</span>
        <span class="type">void</span> userNameChanged();

    <span class="keyword">private</span>:
        <span class="comment">// A helper method for integration with the low-level C API</span>
        <span class="keyword">static</span> <span class="type">void</span> userControllerCallback(<span class="type">void</span><span class="operator">*</span> cookie<span class="operator">,</span> SC_Error_t status);

        <span class="comment">// The accessor method of the property</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> userName() <span class="keyword">const</span>;

        <span class="comment">// The handle to access the Scoreloop service</span>
        SC_Client_h m_client;

        <span class="comment">// The handle to access the Scoreloop user service</span>
        SC_UserController_h m_userController;

        <span class="comment">// The handle that represents the Scoreloop user</span>
        SC_User_h m_user;
    };</pre>
<p>Inside the constructor we create a Scoreloop UserController (which provides access to various user specific information) and store the handle to it in a member variable. Since the communication with the Scoreloop service is asynchonous, a callback method must be passed, which will be invoked whenever the user object changes.</p>
<pre class="cpp">    ScoreloopData<span class="operator">::</span>ScoreloopData(SC_Client_h client<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent)
        : <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>(parent)
        <span class="operator">,</span> m_client(client)
        <span class="operator">,</span> m_userController(<span class="number">0</span>)
        <span class="operator">,</span> m_user(<span class="number">0</span>)
    {
        <span class="comment">// We pass 'this' as cookie for the callback, so we can retrieve the it when in the</span>
        <span class="comment">// static callback</span>
        SC_Client_CreateUserController(m_client<span class="operator">,</span> <span class="operator">&amp;</span>m_userController<span class="operator">,</span> userControllerCallback<span class="operator">,</span> <span class="keyword">this</span>);
    }</pre>
<p>When the user clicks on the 'Reload' button in the UI, the load() slot is invoked, which calls the SC_UserController_LoadUser() method from the Scoreloop API. This call starts the asynchronous loading of the user information and will invoke the previously registered callback.</p>
<pre class="cpp">    <span class="type">void</span> ScoreloopData<span class="operator">::</span>load()
    {
        SC_UserController_LoadUser(m_userController);
    }</pre>
<p>Inside the callback we use the SC_UserController_GetUser() method to retrieve the handle of the user from the controller and we emit the userNameChanged() signal to inform the UI that the user name has changed resp. is available now.</p>
<pre class="cpp">    <span class="type">void</span> ScoreloopData<span class="operator">::</span>userControllerCallback(<span class="type">void</span><span class="operator">*</span> cookie<span class="operator">,</span> SC_Error_t status)
    {
        <span class="comment">// This callback is registered when creating the controller</span>
        <span class="comment">// it will be invoked every time the controller completes a request</span>

        <span class="comment">// Since this is a static function, we passed our object through as cookie</span>
        ScoreloopData<span class="operator">*</span> self <span class="operator">=</span> <span class="keyword">static_cast</span><span class="operator">&lt;</span>ScoreloopData<span class="operator">*</span><span class="operator">&gt;</span>(cookie);

        <span class="keyword">if</span> (status <span class="operator">=</span><span class="operator">=</span> SC_OK) {
            <span class="comment">// Loading went ok, we can update our properties</span>
            self<span class="operator">-</span><span class="operator">&gt;</span>m_user <span class="operator">=</span> SC_UserController_GetUser(self<span class="operator">-</span><span class="operator">&gt;</span>m_userController);
            <span class="keyword">emit</span> self<span class="operator">-</span><span class="operator">&gt;</span>userNameChanged();
        } <span class="keyword">else</span> {
            <span class="comment">// You might want to add proper error handling.</span>
            <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> SC_MapErrorToStr(status);
        }
    }</pre>
<p>The UI will call the userName() method to update the text of the <tt>Label</tt>. Inside this method we retrieve the actual name from the user handle through the SC_User_GetLogin() method.</p>
<pre class="cpp">    <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> ScoreloopData<span class="operator">::</span>userName() <span class="keyword">const</span>
    {
        <span class="keyword">if</span> (m_user) {
            <span class="keyword">return</span> asQString(SC_User_GetLogin(m_user));
        }

        <span class="keyword">return</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span>();
    }</pre>
<p>However since this method returns a custom string class from the Scoreloop API, we convert it to a <a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a> object inside the helper method asQString().</p>
<pre class="cpp">    <span class="keyword">static</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> asQString(SC_String_h scString)
    {
        <span class="keyword">if</span> (scString) {
            <span class="keyword">const</span> <span class="type">char</span> <span class="operator">*</span>cp <span class="operator">=</span> SC_String_GetData(scString);
            <span class="keyword">if</span> (cp) {
                <span class="keyword">return</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span><span class="operator">::</span>fromUtf8(cp);
            }
        }

        <span class="keyword">return</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span>();
    }</pre>
</div>
<!-- @@@scoreloopintegration -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Copyright 2012 Research In Motion Limited.
  <br />
    This document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
