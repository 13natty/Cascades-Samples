<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- filtereddatamodel.qdoc -->
  <title>Cascades : Filtered DataModel Example</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt-based BB10 API Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
<li><a href="http://qt.nokia.com/doc/4.7/all-examples.html">Examples</a></li>
<li>Filtered DataModel Example</li>
    </ul>
  </div>
</div>
<div class="content mainContent">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#description">Description</a></li>
<li class="level1"><a href="#overview">Overview</a></li>
<li class="level1"><a href="#the-ui">The UI</a></li>
<li class="level1"><a href="#the-app-class">The App class</a></li>
<li class="level1"><a href="#the-filtereddatamodel-class">The FilteredDataModel class</a></li>
</ul>
</div>
<h1 class="title">Filtered DataModel Example</h1>
<span class="subtitle"></span>
<!-- $$$filtereddatamodel-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="filtereddatamodel-assets-main-qml.html">filtereddatamodel/assets/main.qml</a></li>
<li><a href="filtereddatamodel-src-app-cpp.html">filtereddatamodel/src/app.cpp</a></li>
<li><a href="filtereddatamodel-src-app-hpp.html">filtereddatamodel/src/app.hpp</a></li>
<li><a href="filtereddatamodel-src-filtereddatamodel-cpp.html">filtereddatamodel/src/filtereddatamodel.cpp</a></li>
<li><a href="filtereddatamodel-src-filtereddatamodel-hpp.html">filtereddatamodel/src/filtereddatamodel.hpp</a></li>
<li><a href="filtereddatamodel-src-vegetablesdatamodel-cpp.html">filtereddatamodel/src/vegetablesdatamodel.cpp</a></li>
<li><a href="filtereddatamodel-src-vegetablesdatamodel-hpp.html">filtereddatamodel/src/vegetablesdatamodel.hpp</a></li>
<li><a href="filtereddatamodel-src-main-cpp.html">filtereddatamodel/src/main.cpp</a></li>
<li><a href="filtereddatamodel-filtereddatamodel-pro.html">filtereddatamodel/filtereddatamodel.pro</a></li>
<li><a href="filtereddatamodel-translations-filtereddatamodel-pro.html">filtereddatamodel/translations/filtereddatamodel.pro</a></li>
</ul>
<a name="description"></a>
<h2>Description</h2>
<p>The Filtered DataModel example allows the user to expand and collaps the header items in a <tt>ListView</tt>.</p>
<p class="centerAlign"><img src="images/filtereddatamodel-example.png" /></p><a name="overview"></a>
<h2>Overview</h2>
<p>In this example we'll learn how to modify the structural appearance of a <tt>DataModel</tt> in a <tt>ListView</tt> by placing a filter model inbetween them. We will use the <tt>VegetablesDataModel</tt> from the <a href="vegetablesdatamodel.html">vegetablesdatamodel</a> example as source model and put a custom model <tt>FilteredDataModel</tt> on top of it to show all the top-level items but only the child items of the currently selected top-level item.</p>
<a name="the-ui"></a>
<h2>The UI</h2>
<p>The UI of this sample application consists of a <tt>ListView</tt> that simply shows the content of our custom model.</p>
<p>We create the filter model in C++ and keep an object of it inside the <tt>App</tt> class.</p>
<pre class="qml">            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qml-listview.html">ListView</a></span> {
                <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>

                <span class="name">dataModel</span>: <span class="name">_model</span></pre>
<p>The <tt>ListView</tt> uses the exported <tt>FilteredDataModel</tt> object as its dataModel.</p>
<pre class="qml">                <span class="name">onTriggered</span>: {
                    <span class="name">clearSelection</span>()
                    <span class="name">select</span>(<span class="name">indexPath</span>)
                }

                <span class="name">onSelectionChanged</span>: {
                    <span class="name">_app</span>.<span class="name">selectionChanged</span>(<span class="name">indexPath</span>, <span class="name">selected</span>)
                }</pre>
<p>Whenever the user clicks on an item, we update the selection in the onTriggered signal handler and invoke the selectionChanged() slot of the <tt>App</tt> object inside the onSelectionChanged signal handler.</p>
<pre class="qml">                    <span class="type">ListItemComponent</span> {
                        <span class="name">type</span>: <span class="string">&quot;header&quot;</span>
                        <span class="type">Label</span> {
                            <span class="name">text</span>: (<span class="name">ListItemData</span>.<span class="name">expanded</span> ? <span class="string">&quot;\u25BC &quot;</span> : <span class="string">&quot;\u25B6 &quot;</span>) <span class="operator">+</span> <span class="name">ListItemData</span>.<span class="name">data</span>
                            <span class="type">textStyle</span> {
                                <span class="name">base</span>: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">BigText</span>
                                <span class="name">color</span>: <span class="name">Color</span>.<span class="name">Black</span>
                                <span class="name">fontWeight</span>: <span class="name">FontWeight</span>.<span class="name">Bold</span>
                            }
                        }
                    }</pre>
<p>Since the standard <tt>Header</tt> control, that is used by the <tt>ListView</tt> for header items, is too small, we declare our own <tt>ListItemComponent</tt> for it. The text inside the header is prefixed with a right or down arrow (used the Unicode symbols here), depending on the 'expanded' property of this header item. The 'expanded' property does not come from the source model but is injected by the <tt>FilteredDataModel</tt>.</p>
<a name="the-app-class"></a>
<h2>The App class</h2>
<p><tt>App</tt> is the central class of the application that creates the UI and provides a public slot to mark one of the top-level items as selected.</p>
<pre class="cpp">    <span class="keyword">class</span> App : <span class="keyword">public</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>
    {
        Q_OBJECT

    <span class="keyword">public</span>:
        App(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent <span class="operator">=</span> <span class="number">0</span>);

    <span class="keyword">public</span> Q_SLOTS:
        <span class="type">void</span> selectionChanged(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a></span> <span class="operator">&amp;</span>indexPath<span class="operator">,</span> <span class="type">bool</span> selected);

    <span class="keyword">private</span>:
        FilteredDataModel <span class="operator">*</span>m_model;
    };</pre>
<p>Inside the constructor of <tt>App</tt> we create an instance of <tt>VegetablesDataModel</tt>, which acts as the source model, and an instance of <tt>FilteredDataModel</tt>, which takes the source model as parameter in its constructor.</p>
<p>Afterwards we load the UI from the main.qml file and export the <tt>FilteredDataModel</tt> object under the name '_model' to QML and the <tt>App</tt> object as '_app'. The latter is needed to be able to invoke the selectionChanged() slot from within the QML document.</p>
<pre class="cpp">    App<span class="operator">::</span>App(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent)
        : <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>(parent)
        <span class="operator">,</span> m_model(<span class="number">0</span>)
    {
        <span class="comment">// Create the source data model</span>
        VegetablesDataModel <span class="operator">*</span>vegetablesModel <span class="operator">=</span> <span class="keyword">new</span> VegetablesDataModel(<span class="keyword">this</span>);

        <span class="comment">// Create the filtered data model and pass the source model</span>
        m_model <span class="operator">=</span> <span class="keyword">new</span> FilteredDataModel(vegetablesModel<span class="operator">,</span> <span class="keyword">this</span>);

        QmlDocument <span class="operator">*</span>qml <span class="operator">=</span> QmlDocument<span class="operator">::</span>create(<span class="string">&quot;asset:///main.qml&quot;</span>)<span class="operator">.</span>parent(<span class="keyword">this</span>);
        qml<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(<span class="string">&quot;_model&quot;</span><span class="operator">,</span> m_model);
        qml<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(<span class="string">&quot;_app&quot;</span><span class="operator">,</span> <span class="keyword">this</span>);

        AbstractPane<span class="operator">*</span> root <span class="operator">=</span> qml<span class="operator">-</span><span class="operator">&gt;</span>createRootObject<span class="operator">&lt;</span>AbstractPane<span class="operator">&gt;</span>();
        Application<span class="operator">::</span>instance()<span class="operator">-</span><span class="operator">&gt;</span>setScene(root);
    }</pre>
<p>Whenever the user selects a top-level item in the <tt>ListView</tt>, the selectionChanged() slot of the <tt>App</tt> object is invoked. Inside this slot we first check that the input parameters are valid. In the following steps we extract the index of the selected item and call the expandHeader() method on the <tt>FilteredDataModel</tt> object to toggle the expansion state of the item.</p>
<pre class="cpp">    <span class="type">void</span> App<span class="operator">::</span>selectionChanged(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a></span> <span class="operator">&amp;</span>indexPath<span class="operator">,</span> <span class="type">bool</span> selected)
    {
        <span class="keyword">if</span> (indexPath<span class="operator">.</span>size() <span class="operator">!</span><span class="operator">=</span> <span class="number">1</span> <span class="operator">|</span><span class="operator">|</span> <span class="operator">!</span>selected)
            <span class="keyword">return</span>; <span class="comment">// Not interested</span>

        <span class="comment">// Selected a header item!</span>
        <span class="keyword">const</span> <span class="type">int</span> selection <span class="operator">=</span> indexPath<span class="operator">[</span><span class="number">0</span><span class="operator">]</span><span class="operator">.</span>toInt();

        <span class="comment">// Toggle the expanded state of the selected header</span>
        m_model<span class="operator">-</span><span class="operator">&gt;</span>expandHeader(selection<span class="operator">,</span> <span class="operator">!</span>m_model<span class="operator">-</span><span class="operator">&gt;</span>isHeaderExpanded(selection));
    }</pre>
<a name="the-filtereddatamodel-class"></a>
<h2>The FilteredDataModel class</h2>
<p>Like any other data model in Cascades, the <tt>FilteredDataModel</tt> also must inherit from the abstract class <tt>bb::cascades::DataModel</tt>.</p>
<pre class="cpp">    <span class="keyword">class</span> FilteredDataModel : <span class="keyword">public</span> bb<span class="operator">::</span>cascades<span class="operator">::</span>DataModel
    {
    <span class="keyword">public</span>:
        FilteredDataModel(bb<span class="operator">::</span>cascades<span class="operator">::</span>DataModel <span class="operator">*</span>sourceModel<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent <span class="operator">=</span> <span class="number">0</span>);

        <span class="comment">// Required interface implementation</span>
        <span class="keyword">virtual</span> <span class="type">int</span> childCount(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a></span><span class="operator">&amp;</span> indexPath);
        <span class="keyword">virtual</span> <span class="type">bool</span> hasChildren(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a></span><span class="operator">&amp;</span> indexPath);
        <span class="keyword">virtual</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html">QVariant</a></span> data(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a></span><span class="operator">&amp;</span> indexPath);
        <span class="keyword">virtual</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> itemType(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a></span><span class="operator">&amp;</span> indexPath);

        <span class="type">void</span> expandHeader(<span class="type">int</span> headerIndex<span class="operator">,</span> <span class="type">bool</span> selected);
        <span class="type">bool</span> isHeaderExpanded(<span class="type">int</span> headerIndex) <span class="keyword">const</span>;

    <span class="keyword">private</span>:
        <span class="type">bool</span> isFiltered(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a></span><span class="operator">&amp;</span> indexPath) <span class="keyword">const</span>;
        <span class="type">void</span> setExpandedHeader(<span class="type">int</span> headerIndex);

    <span class="keyword">private</span>:
        bb<span class="operator">::</span>cascades<span class="operator">::</span>DataModel<span class="operator">*</span> m_sourceDataModel;
        <span class="type">int</span> m_expandedIndex;  <span class="comment">// currently expanded header by index, or -1 if none expanded</span>
    };</pre>
<p>It reimplements all the abstract methods and additionally provides methods to toggle the expansion state of header items. It contains two member variables, one is the pointer to its source model and the other the index of the currently expanded header item.</p>
<pre class="cpp">    FilteredDataModel<span class="operator">::</span>FilteredDataModel(bb<span class="operator">::</span>cascades<span class="operator">::</span>DataModel <span class="operator">*</span>sourceModel<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent)
        : bb<span class="operator">::</span>cascades<span class="operator">::</span>DataModel(parent)
        <span class="operator">,</span> m_sourceDataModel(sourceModel)
        <span class="operator">,</span> m_expandedIndex(<span class="operator">-</span><span class="number">1</span>) <span class="comment">// no header expanded</span>
    {
    }</pre>
<p>Inside the constructor the member variables are initialized.</p>
<pre class="cpp">    <span class="type">int</span> FilteredDataModel<span class="operator">::</span>childCount(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a></span><span class="operator">&amp;</span> indexPath)
    {
        <span class="keyword">if</span> (isFiltered(indexPath)) {
            <span class="comment">// Unexpanded header</span>
            <span class="keyword">return</span> <span class="number">0</span>;
        }

        <span class="keyword">return</span> m_sourceDataModel<span class="operator">-</span><span class="operator">&gt;</span>childCount(indexPath); <span class="comment">// pointer always initialized</span>
    }</pre>
<p>Inside the childCount() method we test whether the passed 'indexPath' belongs to a header item that is not expanded. If that's the case we return '0', so the <tt>ListView</tt> won't show any child items underneath this header item. In all other cases, we simply forward the call to the source model.</p>
<pre class="cpp">    <span class="type">bool</span> FilteredDataModel<span class="operator">::</span>hasChildren(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a></span><span class="operator">&amp;</span> indexPath)
    {
        <span class="keyword">if</span> (isFiltered(indexPath)) {
            <span class="comment">// Unexpanded header</span>
            <span class="keyword">return</span> <span class="keyword">false</span>;
        }

        <span class="keyword">return</span> m_sourceDataModel<span class="operator">-</span><span class="operator">&gt;</span>hasChildren(indexPath); <span class="comment">// pointer always initialized</span>
    }</pre>
<p>Inside the hasChildren() method we test again whether the passed 'indexPath' belongs to a header item that is not expanded. If that's the case we return 'false', so the <tt>ListView</tt> won't show any child items underneath this header item. In all other cases, we simply forward the call to the source model.</p>
<pre class="cpp">    <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html">QVariant</a></span> FilteredDataModel<span class="operator">::</span>data(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a></span><span class="operator">&amp;</span> indexPath)
    {
        <span class="keyword">if</span> (indexPath<span class="operator">.</span>size() <span class="operator">=</span><span class="operator">=</span> <span class="number">1</span>) { <span class="comment">// header item</span>
            <span class="comment">// Enrich the original data of the source model with additional data about expanded state</span>
            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantMap-typedef">QVariantMap</a></span> data;
            data<span class="operator">[</span><span class="string">&quot;data&quot;</span><span class="operator">]</span> <span class="operator">=</span> m_sourceDataModel<span class="operator">-</span><span class="operator">&gt;</span>data(indexPath);
            data<span class="operator">[</span><span class="string">&quot;expanded&quot;</span><span class="operator">]</span> <span class="operator">=</span> (indexPath<span class="operator">[</span><span class="number">0</span><span class="operator">]</span> <span class="operator">=</span><span class="operator">=</span> m_expandedIndex);

            <span class="keyword">return</span> data;
        } <span class="keyword">else</span> {
            <span class="comment">// Pass through the data from the source model</span>
            <span class="keyword">return</span> m_sourceDataModel<span class="operator">-</span><span class="operator">&gt;</span>data(indexPath);
        }
    }</pre>
<p>Inside the data() method we test again whether the data for a header item or a normal item are requested. For a header item we want to enrich the original data (the color of the vegetables as string) with the current expansion state. We use a <tt>QVariantMap</tt> for this purpose, add an &quot;data&quot; entry with the original data from the source model and an &quot;expanded&quot; entry with a boolean value.</p>
<p>If the data of a normal item have been requested, we simply forward the call to the source model.</p>
<pre class="cpp">    <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> FilteredDataModel<span class="operator">::</span>itemType(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a></span><span class="operator">&amp;</span> indexPath)
    {
        <span class="keyword">return</span> m_sourceDataModel<span class="operator">-</span><span class="operator">&gt;</span>itemType(indexPath); <span class="comment">// pointer always initialized</span>
    }</pre>
<p>Since the do not reorder any indexes in our filter model, we can forward all calls of itemType() to the source model.</p>
<pre class="cpp">    <span class="type">void</span> FilteredDataModel<span class="operator">::</span>expandHeader(<span class="type">int</span> headerIndex<span class="operator">,</span> <span class="type">bool</span> expand)
    {
        <span class="keyword">if</span> (<span class="operator">!</span>expand) {
            <span class="keyword">if</span> (headerIndex <span class="operator">=</span><span class="operator">=</span> m_expandedIndex) {
                <span class="comment">// Collapse the header</span>
                setExpandedHeader(<span class="operator">-</span><span class="number">1</span>);
            }
        } <span class="keyword">else</span> {
            setExpandedHeader(headerIndex);
        }
    }</pre>
<p>The expandHeader() method is called whenever the user selects a top-level item in the <tt>ListView</tt>. We first check whether the selected item should be expanded or collapsed. If it should be collapsed and the currently expanded item is the current one, we change set the index to '-1', which means none of the top-level items is expanded. In all other cases we set the passed index as the new expanded header.</p>
<pre class="cpp">    <span class="type">bool</span> FilteredDataModel<span class="operator">::</span>isHeaderExpanded(<span class="type">int</span> headerIndex) <span class="keyword">const</span>
    {
        <span class="keyword">return</span> (headerIndex <span class="operator">=</span><span class="operator">=</span> m_expandedIndex);
    }</pre>
<p>The isHeaderExpanded() method is just a helper method to check whether the passed index is the one that is marked as expanded.</p>
<pre class="cpp">    <span class="type">void</span> FilteredDataModel<span class="operator">::</span>setExpandedHeader(<span class="type">int</span> index)
    {
        <span class="keyword">if</span> (m_expandedIndex <span class="operator">!</span><span class="operator">=</span> index) {
            <span class="comment">// Only emit if we actually make a change</span>
            m_expandedIndex <span class="operator">=</span> index;
            <span class="keyword">emit</span> itemsChanged(bb<span class="operator">::</span>cascades<span class="operator">::</span>DataModelChangeType<span class="operator">::</span>AddRemove);
        }
    }</pre>
<p>The setExpandedHeader() method changes the member variable to new expanded index and emits the itemsChanged() signal that is defined in the <tt>bb::cascades::DataModel</tt> class. Whenever this signal is emitted, the <tt>ListView</tt> will reread all the structural information from the model and adapt its UI.</p>
<pre class="cpp">    <span class="type">bool</span> FilteredDataModel<span class="operator">::</span>isFiltered(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a></span><span class="operator">&amp;</span> indexPath) <span class="keyword">const</span>
    {
        <span class="keyword">return</span> indexPath<span class="operator">.</span>size() <span class="operator">=</span><span class="operator">=</span> <span class="number">1</span> <span class="operator">&amp;</span><span class="operator">&amp;</span>
               indexPath<span class="operator">[</span><span class="number">0</span><span class="operator">]</span><span class="operator">.</span>toInt() <span class="operator">!</span><span class="operator">=</span> m_expandedIndex;
    }</pre>
</div>
<!-- @@@filtereddatamodel -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Copyright 2012 Research In Motion Limited.
  <br />
    This document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
