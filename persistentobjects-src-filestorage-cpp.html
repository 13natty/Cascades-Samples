<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Cascades : FileStorage.cpp Example File (persistentobjects/src/FileStorage.cpp)</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt-based BB10 API Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
    </ul>
  </div>
</div>
<div class="content mainContent">
<h1 class="title">FileStorage.cpp Example File</h1>
<span class="small-subtitle">persistentobjects/src/FileStorage.cpp</span>
<!-- $$$persistentobjects/src/FileStorage.cpp-description -->
<div class="descr"> <a name="details"></a>
<pre class="cpp">    <span class="comment">/* Copyright (c) 2012, 2013  BlackBerry Limited.
     *
     * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     * http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     */</span>

    <span class="preprocessor">#include &quot;FileStorage.hpp&quot;</span>

    <span class="preprocessor">#include &quot;Person.hpp&quot;</span>

    <span class="keyword">using</span> <span class="keyword">namespace</span> bb<span class="operator">::</span>cascades;

    <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> FileStorage<span class="operator">::</span>m_personsFilePath <span class="operator">=</span> <span class="string">&quot;./data/PersonList.dat&quot;</span>;

    FileStorage<span class="operator">::</span>FileStorage()
    {
    }

    FileStorage<span class="operator">::</span><span class="operator">~</span>FileStorage()
    {
    }

    <span class="comment">// Clear the objects in our custom data file.</span>
    <span class="type">bool</span> FileStorage<span class="operator">::</span>clear()
    {
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qfile.html">QFile</a></span> peopleFile(m_personsFilePath);
        <span class="keyword">return</span> peopleFile<span class="operator">.</span>remove();
    }
    <span class="type">bool</span> FileStorage<span class="operator">::</span>save(<span class="type">int</span> lastID<span class="operator">,</span> GroupDataModel <span class="operator">*</span>model)
    {
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qfile.html">QFile</a></span> personFile(m_personsFilePath);

        <span class="keyword">if</span> (<span class="operator">!</span>personFile<span class="operator">.</span>open(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qiodevice.html">QIODevice</a></span><span class="operator">::</span>WriteOnly))
            <span class="keyword">return</span> <span class="keyword">false</span>;

        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatastream.html">QDataStream</a></span> stream(<span class="operator">&amp;</span>personFile); <span class="comment">// Open a stream into the file.</span>

        <span class="keyword">const</span> <span class="type">bool</span> saved <span class="operator">=</span> serializeDataModel(lastID<span class="operator">,</span> model<span class="operator">,</span> <span class="operator">&amp;</span>stream); <span class="comment">// Put the data model into the stream.</span>

        personFile<span class="operator">.</span>close();

        <span class="keyword">return</span> saved;
    }

    <span class="type">bool</span> FileStorage<span class="operator">::</span>serializeDataModel(<span class="type">int</span> lastID<span class="operator">,</span> GroupDataModel<span class="operator">*</span> model<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatastream.html">QDataStream</a></span><span class="operator">*</span> stream)
    {
        <span class="comment">// This is a simple serialization function.</span>
        <span class="comment">// For more info on dealing with complex types,</span>
        <span class="comment">// or incorporating file versions see &quot;Serializing data type in Qt&quot;</span>
        <span class="comment">// http://qt-project.org/doc/qt-4.8/datastreamformat.html</span>
        <span class="type">bool</span> addedData <span class="operator">=</span> <span class="keyword">false</span>;

        <span class="operator">*</span>stream <span class="operator">&lt;</span><span class="operator">&lt;</span> lastID;
        <span class="keyword">if</span> (stream<span class="operator">-</span><span class="operator">&gt;</span>status() <span class="operator">=</span><span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatastream.html">QDataStream</a></span><span class="operator">::</span>Ok) {
            <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> model<span class="operator">-</span><span class="operator">&gt;</span>size(); i<span class="operator">+</span><span class="operator">+</span>) {
                Person <span class="operator">*</span>person <span class="operator">=</span> (Person <span class="operator">*</span>) model<span class="operator">-</span><span class="operator">&gt;</span>children()<span class="operator">[</span>i<span class="operator">]</span>;
                <span class="operator">*</span>stream <span class="operator">&lt;</span><span class="operator">&lt;</span> person<span class="operator">-</span><span class="operator">&gt;</span>customerID() <span class="operator">&lt;</span><span class="operator">&lt;</span> person<span class="operator">-</span><span class="operator">&gt;</span>firstName()
                        <span class="operator">&lt;</span><span class="operator">&lt;</span> person<span class="operator">-</span><span class="operator">&gt;</span>lastName();
                <span class="keyword">if</span> (stream<span class="operator">-</span><span class="operator">&gt;</span>status() <span class="operator">!</span><span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatastream.html">QDataStream</a></span><span class="operator">::</span>Ok) {
                    <span class="keyword">return</span> addedData <span class="operator">=</span> <span class="keyword">false</span>;
                }
            }
            addedData <span class="operator">=</span> <span class="keyword">true</span>;
        }

        <span class="keyword">return</span> addedData;
    }
    <span class="type">int</span> FileStorage<span class="operator">::</span>load(<span class="type">int</span><span class="operator">&amp;</span> lastID<span class="operator">,</span> GroupDataModel <span class="operator">*</span>model)
    {
        <span class="comment">// return the number of persons loaded.</span>
        <span class="type">int</span> loadedCount <span class="operator">=</span> <span class="number">0</span>;

        <span class="comment">// open the custom file for writing.</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qfile.html">QFile</a></span> file(m_personsFilePath);
        <span class="keyword">if</span> (<span class="operator">!</span>file<span class="operator">.</span>open(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qiodevice.html">QIODevice</a></span><span class="operator">::</span>ReadOnly)) {
            <span class="keyword">return</span> loadedCount;
        }

        <span class="comment">// Load from the stream into the dataModel.</span>
        <span class="comment">// The function deserializeIntoDataModel() will create the person instances</span>
        <span class="comment">// and add them to the given dataModel</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatastream.html">QDataStream</a></span> stream(<span class="operator">&amp;</span>file);
        loadedCount <span class="operator">=</span> deserializeIntoDataModel(<span class="operator">&amp;</span>stream<span class="operator">,</span> model<span class="operator">,</span> lastID);
        file<span class="operator">.</span>close();

        <span class="keyword">return</span> loadedCount;
    }

    <span class="type">int</span> FileStorage<span class="operator">::</span>deserializeIntoDataModel(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatastream.html">QDataStream</a></span> <span class="operator">*</span>stream<span class="operator">,</span> GroupDataModel <span class="operator">*</span>model<span class="operator">,</span> <span class="type">int</span><span class="operator">&amp;</span> lastID)
    {
        <span class="comment">// Return number of persons deserialized.</span>
        <span class="type">int</span> loadedCount <span class="operator">=</span> <span class="number">0</span>;

        <span class="comment">// Check in case the stream is empty.</span>
        <span class="keyword">if</span> (stream<span class="operator">-</span><span class="operator">&gt;</span>atEnd())
            <span class="keyword">return</span> loadedCount;

        <span class="comment">// 1. Get the last customer id from the stream and set the member.</span>
        <span class="keyword">if</span> (<span class="operator">!</span>loadLastCustomerID(stream<span class="operator">,</span> lastID))
            <span class="keyword">return</span> loadedCount;

        <span class="comment">// 2. Get the person objects.</span>
        <span class="keyword">while</span> (<span class="operator">!</span>stream<span class="operator">-</span><span class="operator">&gt;</span>atEnd()) {
            <span class="keyword">if</span> (loadPerson(stream<span class="operator">,</span> model)) {
                loadedCount<span class="operator">+</span><span class="operator">+</span>;
            } <span class="keyword">else</span> {
                <span class="keyword">break</span>; <span class="comment">// Stop reading after error.</span>
            }
        }

        <span class="keyword">return</span> loadedCount;
    }

    <span class="type">bool</span> FileStorage<span class="operator">::</span>loadPerson(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatastream.html">QDataStream</a></span><span class="operator">*</span> stream<span class="operator">,</span> GroupDataModel <span class="operator">*</span>model)
    {
        <span class="type">bool</span> loaded <span class="operator">=</span> <span class="keyword">false</span>;

        <span class="comment">// Load the data into temporary variables.</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> id<span class="operator">,</span> firstName<span class="operator">,</span> lastName;
        <span class="operator">*</span>stream <span class="operator">&gt;</span><span class="operator">&gt;</span> id <span class="operator">&gt;</span><span class="operator">&gt;</span> firstName <span class="operator">&gt;</span><span class="operator">&gt;</span> lastName;

        <span class="comment">// Check for errors in the read.</span>
        <span class="keyword">if</span> (stream<span class="operator">-</span><span class="operator">&gt;</span>status() <span class="operator">=</span><span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatastream.html">QDataStream</a></span><span class="operator">::</span>Ok) {
            <span class="comment">// Add a new person object to the data model.</span>
            model<span class="operator">-</span><span class="operator">&gt;</span>insert(<span class="keyword">new</span> Person(id<span class="operator">,</span> firstName<span class="operator">,</span> lastName)); <span class="comment">// Note the model will delete Person when the time comes.</span>
            loaded <span class="operator">=</span> <span class="keyword">true</span>;
        }

        <span class="keyword">return</span> loaded;
    }
    <span class="type">bool</span> FileStorage<span class="operator">::</span>loadLastCustomerID(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatastream.html">QDataStream</a></span><span class="operator">*</span> stream<span class="operator">,</span> <span class="type">int</span><span class="operator">&amp;</span> id)
    {
        <span class="type">bool</span> loaded <span class="operator">=</span> <span class="keyword">false</span>;
        <span class="type">int</span> lastID;

        <span class="comment">// Get the last customer id first.</span>
        <span class="comment">// ID's will be generated by incrementing this number</span>
        <span class="operator">*</span>stream <span class="operator">&gt;</span><span class="operator">&gt;</span> lastID;

        <span class="comment">// Check for errors in the read.</span>
        <span class="keyword">if</span> (stream<span class="operator">-</span><span class="operator">&gt;</span>status() <span class="operator">=</span><span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatastream.html">QDataStream</a></span><span class="operator">::</span>Ok) {
            loaded <span class="operator">=</span> <span class="keyword">true</span>;
            id <span class="operator">=</span> lastID; <span class="comment">// return the id</span>
        }

        <span class="keyword">return</span> loaded;
    }</pre>
</div>
<!-- @@@persistentobjects/src/FileStorage.cpp -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Copyright 2012 Research In Motion Limited.
  <br />
    This document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
