<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- addressbook.qdoc -->
  <title>Cascades : Address Book Example</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt-based BB10 API Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
<li><a href="http://qt.nokia.com/doc/4.7/all-examples.html">Examples</a></li>
<li>Address Book Example</li>
    </ul>
  </div>
</div>
<div class="content mainContent">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#description">Description</a></li>
<li class="level1"><a href="#overview">Overview</a></li>
<li class="level1"><a href="#the-ui">The UI</a></li>
<li class="level2"><a href="#the-main-page">The main page</a></li>
<li class="level2"><a href="#the-view-contact-page">The 'view contact' page</a></li>
<li class="level2"><a href="#the-edit-contact-and-create-new-contact-page">The 'edit contact' and 'create new contact' page</a></li>
<li class="level1"><a href="#the-business-logic">The Business Logic</a></li>
<li class="level2"><a href="#addressbook">AddressBook</a></li>
<li class="level2"><a href="#contactviewer">ContactViewer</a></li>
<li class="level2"><a href="#contacteditor">ContactEditor</a></li>
</ul>
</div>
<h1 class="title">Address Book Example</h1>
<span class="subtitle"></span>
<!-- $$$pim/addressbook-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="pim-addressbook-assets-contacteditor-qml.html">pim/addressbook/assets/ContactEditor.qml</a></li>
<li><a href="pim-addressbook-assets-contactviewer-qml.html">pim/addressbook/assets/ContactViewer.qml</a></li>
<li><a href="pim-addressbook-assets-viewerfield-qml.html">pim/addressbook/assets/ViewerField.qml</a></li>
<li><a href="pim-addressbook-assets-main-qml.html">pim/addressbook/assets/main.qml</a></li>
<li><a href="pim-addressbook-src-addressbook-cpp.html">pim/addressbook/src/AddressBook.cpp</a></li>
<li><a href="pim-addressbook-src-addressbook-hpp.html">pim/addressbook/src/AddressBook.hpp</a></li>
<li><a href="pim-addressbook-src-contacteditor-cpp.html">pim/addressbook/src/ContactEditor.cpp</a></li>
<li><a href="pim-addressbook-src-contacteditor-hpp.html">pim/addressbook/src/ContactEditor.hpp</a></li>
<li><a href="pim-addressbook-src-contactviewer-cpp.html">pim/addressbook/src/ContactViewer.cpp</a></li>
<li><a href="pim-addressbook-src-contactviewer-hpp.html">pim/addressbook/src/ContactViewer.hpp</a></li>
<li><a href="pim-addressbook-src-main-cpp.html">pim/addressbook/src/main.cpp</a></li>
<li><a href="pim-addressbook-addressbook-pro.html">pim/addressbook/addressbook.pro</a></li>
<li><a href="pim-addressbook-translations-addressbook-pro.html">pim/addressbook/translations/addressbook.pro</a></li>
</ul>
<a name="description"></a>
<h2>Description</h2>
<p>The Address Book example is a simple address book application to list, view, edit and delete the contacts available on the system or create new ones.</p>
<p class="centerAlign"><img src="images/addressbook-example.png" /></p><p class="centerAlign"><img src="images/addressbook-example1.png" /></p><p class="centerAlign"><img src="images/addressbook-example2.png" /></p><a name="overview"></a>
<h2>Overview</h2>
<p>In this example we'll learn how to use the bb::pim::contact API of the BB10 framework to work with the contacts available on the system.</p>
<p>The application has a clean separation between business logic and UI representation. All the business logic is encapsulated inside the three C++ classes <tt>AddressBook</tt>, <tt>ContactViewer</tt> and <tt>ContactEditor</tt>. These classes use the bb::pim::contact API internally to communicate with the contact service of BB10 and provide all the necessary functionality and data to the UI via properties, signals and slots. The <tt>AddressBook</tt> object is exported to the UI under the name '<a href="#addressbook">_addressBook</a>'.</p>
<a name="the-ui"></a>
<h2>The UI</h2>
<p>The UI of this sample application consists of four pages:</p>
<ul>
<li>The main page</li>
<li>The 'view contact' page</li>
<li>The 'edit contact' page</li>
<li>The 'create new contact' page</li>
</ul>
<a name="the-main-page"></a>
<h3>The main page</h3>
<p>The main page contains a <tt>ListView</tt> that displays a list of contacts and a <tt>TextField</tt> where the user can type in a text which is used as filter criterion for the list.</p>
<pre class="qml">                    <span class="comment">// The contact list filter input</span>
                    <span class="type">TextField</span> {
                        <span class="name">hintText</span>: <span class="name">qsTr</span> (<span class="string">&quot;Filter by...&quot;</span>)

                        <span class="name">onTextChanging</span>: <span class="name">_addressBook</span>.<span class="name">filter</span> <span class="operator">=</span> <span class="name">text</span>
                    }</pre>
<p>Whenever the content of the <tt>TextField</tt> is changed by the user, the 'filter' property of the exported <tt>AddressBook</tt> object is updated.</p>
<pre class="qml">                    <span class="comment">// The list view with all contacts</span>
                    <span class="type"><a href="http://qt.nokia.com/doc/4.7/qml-listview.html">ListView</a></span> {
                        <span class="name">dataModel</span>: <span class="name">_addressBook</span>.<span class="name">model</span>

                        <span class="name">listItemComponents</span>: <span class="name">ListItemComponent</span> {
                            <span class="name">type</span>: <span class="string">&quot;item&quot;</span>

                            <span class="type">StandardListItem</span> {
                                <span class="name">title</span>: <span class="name">qsTr</span> (<span class="string">&quot;%1, %2&quot;</span>).<span class="name">arg</span>(<span class="name">ListItemData</span>.<span class="name">lastName</span>).<span class="name">arg</span>(<span class="name">ListItemData</span>.<span class="name">firstName</span>)
                                <span class="name">description</span>: <span class="name">ListItemData</span>.<span class="name">email</span>
                            }
                        }

                        <span class="name">onTriggered</span>: {
                            <span class="name">clearSelection</span>()
                            <span class="name">select</span>(<span class="name">indexPath</span>)

                            <span class="name">_addressBook</span>.<span class="name">setCurrentContact</span>(<span class="name">indexPath</span>)

                            <span class="name">_addressBook</span>.<span class="name">viewContact</span>();
                            <span class="name">navigationPane</span>.<span class="name">push</span>(<span class="name">contactViewer</span>.<span class="name">createObject</span>())
                        }
                    }</pre>
<p>The <tt>ListView</tt> uses the model provided by the <tt>AddressBook</tt> object as data model and shows the first name, last name and email properties inside the items.</p>
<p>Whenever the user clicks on an item, setCurrentContact() is called on the <tt>AddressBook</tt> object, which will mark the selected contact as the 'current' contact for viewing and editing. Afterwards the viewContact() method is invoked on the <tt>AddressBook</tt> object. This will setup the <tt>ContactViewer</tt> object to make the data of the current contact available to the 'view contact' page. Finally, the 'view contact' page is pushed on the <tt>NavigationPane</tt>.</p>
<pre class="qml">        <span class="name">attachedObjects</span>: [
            <span class="type">ComponentDefinition</span> {
                <span class="name">id</span>: <span class="name">contactEditor</span>
                <span class="name">source</span>: <span class="string">&quot;ContactEditor.qml&quot;</span>
            },
            <span class="type">ComponentDefinition</span> {
                <span class="name">id</span>: <span class="name">contactViewer</span>
                <span class="name">source</span>: <span class="string">&quot;ContactViewer.qml&quot;</span>
            }
        ]</pre>
<p>This page is loaded dynamically from a <tt>ComponentDefinition</tt> that references the file ContactViewer.qml</p>
<p>The main page also contains an <tt>ActionItem</tt> inside its action bar, which can be invoked by the user to create a new contact.</p>
<pre class="qml">            <span class="name">actions</span>: [
                <span class="type">ActionItem</span> {
                    <span class="name">title</span>: <span class="name">qsTr</span> (<span class="string">&quot;New&quot;</span>)
                    <span class="name">imageSource</span>: <span class="string">&quot;asset:///images/action_addcontact.png&quot;</span>
                    <span class="name">ActionBar</span>.placement: <span class="name">ActionBarPlacement</span>.<span class="name">OnBar</span>

                    <span class="name">onTriggered</span>: {
                        <span class="name">_addressBook</span>.<span class="name">createContact</span>()
                        <span class="name">navigationPane</span>.<span class="name">push</span>(<span class="name">contactEditor</span>.<span class="name">createObject</span>())
                    }
                }
            ]</pre>
<p>When the action is triggered, the createContact() method is invoked on the <tt>AddressBook</tt> object, which will setup the <tt>ContactEditor</tt> object to be in creation mode. Afterwards the 'create new contact' page is pushed on the <tt>NavigationPane</tt>. This page is loaded dynamically from a <tt>ComponentDefinition</tt> that references the file ContactEditor.qml.</p>
<a name="the-view-contact-page"></a>
<h3>The 'view contact' page</h3>
<p>The 'view contact' page is implemented inside ContactViewer.qml and retrieves all the data to display from the <tt>ContactViewer</tt> object, which is accessible as a property of the <tt>AddressBook</tt> object.</p>
<pre class="qml">                <span class="type">ViewerField</span> {
                    <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Fill</span>
                    <span class="name">title</span>: <span class="name">qsTr</span> (<span class="string">&quot;first name&quot;</span>)
                    <span class="name">value</span>: <span class="name">_addressBook</span>.<span class="name">contactViewer</span>.<span class="name">firstName</span>
                }

                <span class="type">ViewerField</span> {
                    <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Fill</span>
                    <span class="name">topMargin</span>: <span class="number">50</span>

                    <span class="name">title</span>: <span class="name">qsTr</span> (<span class="string">&quot;last name&quot;</span>)
                    <span class="name">value</span>: <span class="name">_addressBook</span>.<span class="name">contactViewer</span>.<span class="name">lastName</span>
                }</pre>
<p>The UI of the page consists of a list of ViewerField objects (which are implemented in ViewerField.qml), one for each contact property (first name, last name, birthday and email address). These fields simply display a title text and a value text in a row. While the title texts are hard-coded, the value properties are bound against the properties provided by the <tt>ContactViewer</tt> object. So whenever the contact that is currently handled by the <tt>ContactViewer</tt> is changed, the UI will be updated automatically.</p>
<pre class="qml">        <span class="name">actions</span>: [
            <span class="type">ActionItem</span> {
                <span class="name">title</span>: <span class="name">qsTr</span> (<span class="string">&quot;Edit&quot;</span>)
                <span class="name">imageSource</span>: <span class="string">&quot;asset:///images/action_editcontact.png&quot;</span>

                <span class="name">onTriggered</span>: {
                    <span class="name">_addressBook</span>.<span class="name">editContact</span>()
                    <span class="name">navigationPane</span>.<span class="name">push</span>(<span class="name">contactEditor</span>.<span class="name">createObject</span>())
                }
            },
            <span class="type">DeleteActionItem</span> {
                <span class="name">onTriggered</span>: {
                    <span class="name">_addressBook</span>.<span class="name">deleteContact</span>()

                    <span class="name">navigationPane</span>.<span class="name">pop</span>()
                }
            }
        ]</pre>
<p>To edit or delete the currently displayed contact, the page contains two <tt>ActionItem</tt>s. If the one for deleting the contact is triggered, the deleteContact() method is invoked on the <tt>AddressBook</tt> object, which will call the appropriated methods on the bb::pim::contact API internally. If the action for editing the contact is triggered, the editContact() method is invoked on the <tt>AddressBook</tt> object, which will setup the <tt>ContactEditor</tt> object to be in editing mode and make the data of the current contact available to the 'edit contact' page. Afterwards the 'edit contact' page is pushed on the <tt>NavigationPane</tt>.</p>
<pre class="qml">        <span class="name">attachedObjects</span>: [
            <span class="type">ComponentDefinition</span> {
                <span class="name">id</span>: <span class="name">contactEditor</span>
                <span class="name">source</span>: <span class="string">&quot;ContactEditor.qml&quot;</span>
            }
        ]</pre>
<p>The 'edit contact' page is loaded dynamically from a <tt>ComponentDefinition</tt> that references the file ContactEditor.qml.</p>
<a name="the-edit-contact-and-create-new-contact-page"></a>
<h3>The 'edit contact' and 'create new contact' page</h3>
<p>For creating a new contact or editing an existing one the same UI (ContactEditor.qml) is used. The underlying business object <tt>ContactEditor</tt> provides the property 'mode' to differ between the CreateMode and EditMode.</p>
<p>The page contains two actions in its <tt>TitleBar</tt> to create/save the current contact or cancel the operation.</p>
<pre class="qml">        <span class="name">titleBar</span>: <span class="name">TitleBar</span> {
            <span class="name">id</span>: <span class="name">pageTitleBar</span>

            <span class="comment">// The 'Create/Save' action</span>
            <span class="name">acceptAction</span>: <span class="name">ActionItem</span> {
                <span class="name">title</span>: (<span class="name">_addressBook</span>.<span class="name">contactEditor</span>.<span class="name">mode</span> <span class="operator">==</span> <span class="name">ContactEditor</span>.<span class="name">CreateMode</span> ? <span class="name">qsTr</span> (<span class="string">&quot;Create&quot;</span> ) : <span class="name">qsTr</span> (<span class="string">&quot;Save&quot;</span>))

                <span class="name">onTriggered</span>: {
                    <span class="name">_addressBook</span>.<span class="name">contactEditor</span>.<span class="name">saveContact</span>()

                    <span class="name">navigationPane</span>.<span class="name">pop</span>()
                }
            }

            <span class="comment">// The 'Cancel' action</span>
            <span class="name">dismissAction</span>: <span class="name">ActionItem</span> {
                <span class="name">title</span>: <span class="name">qsTr</span> (<span class="string">&quot;Cancel&quot;</span>)

                <span class="name">onTriggered</span>: <span class="name">navigationPane</span>.<span class="name">pop</span>()
            }
        }</pre>
<p>Depending on the current mode the title of the accept action is set to 'Create' or 'Save'. In both cases, an invocation of the action will call the saveContact() method on the <tt>ContactEditor</tt> object, which will do the right thing internally, depending on the current mode.</p>
<p>If the user selects the dismiss action, the current page is popped from the <tt>NavigationPane</tt>.</p>
<pre class="qml">                <span class="type">TextField</span> {
                    <span class="name">id</span>: <span class="name">firstNameField</span>

                    <span class="name">hintText</span>: <span class="name">qsTr</span> (<span class="string">&quot;First Name&quot;</span>)

                    <span class="name">onTextChanging</span>: <span class="name">_addressBook</span>.<span class="name">contactEditor</span>.<span class="name">firstName</span> <span class="operator">=</span> <span class="name">text</span>
                }</pre>
<p>For each property of a contact, the page contains an editor field (e.g&#x2e; a <tt>TextField</tt> for the first name). Whenever the user changes the content of the field, the associated property of the <tt>ContactEditor</tt> object will be updated.</p>
<p>If the UI is in EditMode, the content of the editor fields is initialized with the values from the <tt>ContactEditor</tt> object after the UI has been created.</p>
<pre class="qml">        <span class="name">onCreationCompleted</span>: {
            <span class="keyword">if</span> (<span class="name">_addressBook</span>.<span class="name">contactEditor</span>.<span class="name">mode</span> <span class="operator">==</span> <span class="name">ContactEditor</span>.<span class="name">EditMode</span>) {
                <span class="comment">// Fill the editor fields after the UI has been created</span>
                <span class="name">firstNameField</span>.<span class="name">text</span> <span class="operator">=</span> <span class="name">_addressBook</span>.<span class="name">contactEditor</span>.<span class="name">firstName</span>
                <span class="name">lastNameField</span>.<span class="name">text</span> <span class="operator">=</span> <span class="name">_addressBook</span>.<span class="name">contactEditor</span>.<span class="name">lastName</span>
                <span class="name">birthdayField</span>.<span class="name">value</span> <span class="operator">=</span> <span class="name">_addressBook</span>.<span class="name">contactEditor</span>.<span class="name">birthday</span>
                <span class="name">emailField</span>.<span class="name">text</span> <span class="operator">=</span> <span class="name">_addressBook</span>.<span class="name">contactEditor</span>.<span class="name">email</span>
            }
        }</pre>
<a name="the-business-logic"></a>
<h2>The Business Logic</h2>
<p>To have a clean separation between business logic and UI, the business logic is implemented in the three C++ classes <tt>AddressBook</tt>, <tt>ContactViewer</tt> and <tt>ContactEditor</tt>.</p>
<a name="addressbook"></a>
<h3>AddressBook</h3>
<p>The <tt>AddressBook</tt> class is the central point to access the business logic from within the UI. Therefor the object is exported to QML under the name '<a href="#addressbook">_addressBook</a>' inside the main function.</p>
<pre class="cpp">        <span class="comment">// Load the UI description from main.qml</span>
        QmlDocument <span class="operator">*</span>qml <span class="operator">=</span> QmlDocument<span class="operator">::</span>create(<span class="string">&quot;asset:///main.qml&quot;</span>)<span class="operator">.</span>parent(<span class="operator">&amp;</span>app);

        <span class="comment">// Make the AddressBook object available to the UI as context property</span>
        qml<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(<span class="string">&quot;_addressBook&quot;</span><span class="operator">,</span> <span class="keyword">new</span> AddressBook(<span class="operator">&amp;</span>app));</pre>
<p>The <tt>AddressBook</tt> object provides the list of available contacts as a custom property 'model' of type bb::cascades::GroupDataModel, so that a <tt>ListView</tt> in the UI can use it directly as its data model. Additionally the <tt>AddressBook</tt> object provides a 'filter' property to define a filter string that is applied on the list of contacts. The other two business logic objects <tt>ContactViewer</tt> and <tt>ContactEditor</tt> can be accessed through the '<a href="#contactviewer">contactViewer</a>' and '<a href="#contacteditor">contactEditor</a>' properties.</p>
<pre class="cpp">    <span class="keyword">class</span> AddressBook : <span class="keyword">public</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>
    {
        Q_OBJECT

        <span class="comment">// The model that provides the filtered list of contacts</span>
        Q_PROPERTY(bb<span class="operator">::</span>cascades<span class="operator">::</span>GroupDataModel <span class="operator">*</span>model READ model CONSTANT);

        <span class="comment">// The pattern to filter the list of contacts</span>
        Q_PROPERTY(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> filter READ filter WRITE setFilter NOTIFY filterChanged);

        <span class="comment">// The viewer object for the current contact</span>
        Q_PROPERTY(ContactViewer<span class="operator">*</span> contactViewer READ contactViewer CONSTANT);

        <span class="comment">// The editor object for the current contact</span>
        Q_PROPERTY(ContactEditor<span class="operator">*</span> contactEditor READ contactEditor CONSTANT);

    <span class="keyword">public</span>:
        AddressBook(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent <span class="operator">=</span> <span class="number">0</span>);

    <span class="keyword">public</span> Q_SLOTS:
        <span class="comment">/**
         * Marks the contact with the given @p indexPath as current.
         */</span>
        <span class="type">void</span> setCurrentContact(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a></span> <span class="operator">&amp;</span>indexPath);

        <span class="comment">/**
         * Prepares the contact editor to create a new contact.
         */</span>
        <span class="type">void</span> createContact();

        <span class="comment">/**
         * Prepares the contact editor to edit the current contact.
         */</span>
        <span class="type">void</span> editContact();

        <span class="comment">/**
         * Prepares the contact viewer to display the current contact.
         */</span>
        <span class="type">void</span> viewContact();

        <span class="comment">/**
         * Deletes the current contact.
         */</span>
        <span class="type">void</span> deleteContact();

    Q_SIGNALS:
        <span class="comment">// The change notification signal for the property</span>
        <span class="type">void</span> filterChanged();

    <span class="keyword">private</span> Q_SLOTS:
        <span class="comment">// Filters the contacts in the model according to the filter property</span>
        <span class="type">void</span> filterContacts();

    <span class="keyword">private</span>:
        <span class="comment">// The accessor methods of the properties</span>
        bb<span class="operator">::</span>cascades<span class="operator">::</span>GroupDataModel<span class="operator">*</span> model() <span class="keyword">const</span>;
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> filter() <span class="keyword">const</span>;
        <span class="type">void</span> setFilter(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> <span class="operator">&amp;</span>filter);
        ContactViewer<span class="operator">*</span> contactViewer() <span class="keyword">const</span>;
        ContactEditor<span class="operator">*</span> contactEditor() <span class="keyword">const</span>;

        <span class="comment">// The central object to access the contacts service</span>
        bb<span class="operator">::</span>pim<span class="operator">::</span>contacts<span class="operator">::</span>ContactService<span class="operator">*</span> m_contactService;

        <span class="comment">// The property values</span>
        bb<span class="operator">::</span>cascades<span class="operator">::</span>GroupDataModel<span class="operator">*</span> m_model;
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> m_filter;

        <span class="comment">// The controller object for viewing a contact</span>
        ContactViewer<span class="operator">*</span> m_contactViewer;

        <span class="comment">// The controller object for editing a contact</span>
        ContactEditor<span class="operator">*</span> m_contactEditor;

        <span class="comment">// The ID of the current contact</span>
        bb<span class="operator">::</span>pim<span class="operator">::</span>contacts<span class="operator">::</span>ContactId m_currentContactId;
    };</pre>
<p>To use the <tt>ContactViewer</tt> and <tt>ContactEditor</tt> objects as property types, they must be registered to the QML type system inside the main function as well.</p>
<pre class="cpp">        <span class="comment">// Register our custom types with QML, so that they can be used as property types</span>
        qmlRegisterUncreatableType<span class="operator">&lt;</span>ContactEditor<span class="operator">&gt;</span>(<span class="string">&quot;com.example.bb10samples.pim.addressbook&quot;</span><span class="operator">,</span> <span class="number">1</span><span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="string">&quot;ContactEditor&quot;</span><span class="operator">,</span> <span class="string">&quot;Usage as property type and access to enums&quot;</span>);
        qmlRegisterType<span class="operator">&lt;</span>ContactViewer<span class="operator">&gt;</span>();</pre>
<p>Inside the constructor all member objects are initialized. The <tt>ContactService</tt> is the central point of the bb::pim::contact API to access contact information on the BB10 platform.</p>
<pre class="cpp">    AddressBook<span class="operator">::</span>AddressBook(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent)
        : <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>(parent)
        <span class="operator">,</span> m_contactService(<span class="keyword">new</span> ContactService(<span class="keyword">this</span>))
        <span class="operator">,</span> m_model(<span class="keyword">new</span> GroupDataModel(<span class="keyword">this</span>))
        <span class="operator">,</span> m_contactViewer(<span class="keyword">new</span> ContactViewer(m_contactService<span class="operator">,</span> <span class="keyword">this</span>))
        <span class="operator">,</span> m_contactEditor(<span class="keyword">new</span> ContactEditor(m_contactService<span class="operator">,</span> <span class="keyword">this</span>))
        <span class="operator">,</span> m_currentContactId(<span class="operator">-</span><span class="number">1</span>)
    {
        <span class="comment">// Disable grouping in data model</span>
        m_model<span class="operator">-</span><span class="operator">&gt;</span>setGrouping(ItemGrouping<span class="operator">::</span>None);

        <span class="comment">// Ensure to invoke the filterContacts() method whenever a contact has been added, changed or removed</span>
        connect(m_contactService<span class="operator">,</span> SIGNAL(contactsAdded(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qlist.html">QList</a></span><span class="operator">&lt;</span><span class="type">int</span><span class="operator">&gt;</span>))<span class="operator">,</span> SLOT(filterContacts()));
        connect(m_contactService<span class="operator">,</span> SIGNAL(contactsChanged(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qlist.html">QList</a></span><span class="operator">&lt;</span><span class="type">int</span><span class="operator">&gt;</span>))<span class="operator">,</span> SLOT(filterContacts()));
        connect(m_contactService<span class="operator">,</span> SIGNAL(contactsDeleted(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qlist.html">QList</a></span><span class="operator">&lt;</span><span class="type">int</span><span class="operator">&gt;</span>))<span class="operator">,</span> SLOT(filterContacts()));

        <span class="comment">// Fill the data model with contacts initially</span>
        filterContacts();
    }</pre>
<p>The filterContacts() method retrieves all contacts that match the specified filter from the <tt>ContactService</tt> and fills the data model with the result. The ID of the contact is stored inside the model together with the data that will be displayed in the <tt>ListView</tt>.</p>
<pre class="cpp">    <span class="type">void</span> AddressBook<span class="operator">::</span>filterContacts()
    {
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qlist.html">QList</a></span><span class="operator">&lt;</span>Contact<span class="operator">&gt;</span> contacts;

        <span class="keyword">if</span> (m_filter<span class="operator">.</span>isEmpty()) {
            <span class="comment">// No filter has been specified, so just list all contacts</span>
            ContactListFilters filter;
            contacts <span class="operator">=</span> m_contactService<span class="operator">-</span><span class="operator">&gt;</span>contacts(filter);
        } <span class="keyword">else</span> {
            <span class="comment">// Use the entered filter string as search value</span>
            ContactSearchFilters filter;
            filter<span class="operator">.</span>setSearchValue(m_filter);
            contacts <span class="operator">=</span> m_contactService<span class="operator">-</span><span class="operator">&gt;</span>searchContacts(filter);
        }

        <span class="comment">// Clear the old contact information from the model</span>
        m_model<span class="operator">-</span><span class="operator">&gt;</span>clear();

        <span class="comment">// Iterate over the list of contact IDs</span>
        foreach (<span class="keyword">const</span> Contact <span class="operator">&amp;</span>idContact<span class="operator">,</span> contacts) {
            <span class="comment">// Fetch the complete details for this contact ID</span>
            <span class="keyword">const</span> Contact contact <span class="operator">=</span> m_contactService<span class="operator">-</span><span class="operator">&gt;</span>contactDetails(idContact<span class="operator">.</span>id());

            <span class="comment">// Copy the data into a model entry</span>
            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantMap-typedef">QVariantMap</a></span> entry;
            entry<span class="operator">[</span><span class="string">&quot;contactId&quot;</span><span class="operator">]</span> <span class="operator">=</span> contact<span class="operator">.</span>id();
            entry<span class="operator">[</span><span class="string">&quot;firstName&quot;</span><span class="operator">]</span> <span class="operator">=</span> contact<span class="operator">.</span>firstName();
            entry<span class="operator">[</span><span class="string">&quot;lastName&quot;</span><span class="operator">]</span> <span class="operator">=</span> contact<span class="operator">.</span>lastName();

            <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qlist.html">QList</a></span><span class="operator">&lt;</span>ContactAttribute<span class="operator">&gt;</span> emails <span class="operator">=</span> contact<span class="operator">.</span>emails();
            <span class="keyword">if</span> (<span class="operator">!</span>emails<span class="operator">.</span>isEmpty())
                entry<span class="operator">[</span><span class="string">&quot;email&quot;</span><span class="operator">]</span> <span class="operator">=</span> emails<span class="operator">.</span>first()<span class="operator">.</span>value();

            <span class="comment">// Add the entry to the model</span>
            m_model<span class="operator">-</span><span class="operator">&gt;</span>insert(entry);
        }
    }</pre>
<p>Whenever the user changes the filter criterion, the setFilter() method is invoked, which updates the filter value and calls the filterContacts() method again.</p>
<pre class="cpp">    <span class="type">void</span> AddressBook<span class="operator">::</span>setFilter(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> <span class="operator">&amp;</span>filter)
    {
        <span class="keyword">if</span> (m_filter <span class="operator">=</span><span class="operator">=</span> filter)
            <span class="keyword">return</span>;

        m_filter <span class="operator">=</span> filter;
        <span class="keyword">emit</span> filterChanged();

        <span class="comment">// Update the model now that the filter criterion has changed</span>
        filterContacts();
    }</pre>
<p>Whenever the user selects a contact in the <tt>ListView</tt>, the setCurrentContact() method is invoked. If the selected index path is valid, the ID of the contact is extracted and stored as 'current' contact.</p>
<pre class="cpp">    <span class="type">void</span> AddressBook<span class="operator">::</span>setCurrentContact(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a></span> <span class="operator">&amp;</span>indexPath)
    {
        <span class="comment">// Extract the ID of the selected contact from the model</span>
        <span class="keyword">if</span> (indexPath<span class="operator">.</span>isEmpty()) {
            m_currentContactId <span class="operator">=</span> <span class="operator">-</span><span class="number">1</span>;
        } <span class="keyword">else</span> {
            <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantMap-typedef">QVariantMap</a></span> entry <span class="operator">=</span> m_model<span class="operator">-</span><span class="operator">&gt;</span>data(indexPath)<span class="operator">.</span>toMap();
            m_currentContactId <span class="operator">=</span> entry<span class="operator">.</span>value(<span class="string">&quot;contactId&quot;</span>)<span class="operator">.</span>toInt();
        }
    }</pre>
<p>Afterwards the UI invokes the viewContact() method, that triggers the <tt>ContactViewer</tt> to load the data for the current contact.</p>
<pre class="cpp">    <span class="type">void</span> AddressBook<span class="operator">::</span>viewContact()
    {
        <span class="comment">// Prepare the contact viewer for displaying the current contact</span>
        m_contactViewer<span class="operator">-</span><span class="operator">&gt;</span>setContactId(m_currentContactId);
    }</pre>
<p>If the user triggers the 'Delete' action from the 'view contact' page, deleteContact() is invoked, which forwards this request to the <tt>ContactService</tt>.</p>
<pre class="cpp">    <span class="type">void</span> AddressBook<span class="operator">::</span>deleteContact()
    {
        m_contactService<span class="operator">-</span><span class="operator">&gt;</span>deleteContact(m_currentContactId);
    }</pre>
<p>If the user wants to edit the current contact, the UI calls editContact(), which triggers the <tt>ContactEditor</tt> to load the data of the current contact and switches the <tt>ContactEditor</tt> into EditMode.</p>
<pre class="cpp">    <span class="type">void</span> AddressBook<span class="operator">::</span>editContact()
    {
        <span class="comment">// Prepare the contact editor for editing the current contact</span>
        m_contactEditor<span class="operator">-</span><span class="operator">&gt;</span>loadContact(m_currentContactId);
        m_contactEditor<span class="operator">-</span><span class="operator">&gt;</span>setMode(ContactEditor<span class="operator">::</span>EditMode);
    }</pre>
<p>If the user wants to create a new contact, the UI calls createContact(), which resets the <tt>ContactEditor</tt> and switches it into CreateMode.</p>
<pre class="cpp">    <span class="type">void</span> AddressBook<span class="operator">::</span>createContact()
    {
        <span class="comment">// Prepare the contact editor for creating a new contact</span>
        m_contactEditor<span class="operator">-</span><span class="operator">&gt;</span>reset();
        m_contactEditor<span class="operator">-</span><span class="operator">&gt;</span>setMode(ContactEditor<span class="operator">::</span>CreateMode);
    }</pre>
<a name="contactviewer"></a>
<h3>ContactViewer</h3>
<p>The ContactViewer class is an UI-independent representation of the contact viewer, that provides all the functionality and data as slots and properties. It encapsulates all the logic of loading a contact from the persistent storage, provides its data as properties and updates the properties automatically if the contact has changed in the storage backend.</p>
<pre class="cpp">    <span class="keyword">class</span> ContactViewer : <span class="keyword">public</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>
    {
        Q_OBJECT

        <span class="comment">// The data properties of the contact that is displayed</span>
        Q_PROPERTY(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> firstName READ firstName NOTIFY firstNameChanged)
        Q_PROPERTY(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> lastName READ lastName NOTIFY lastNameChanged)
        Q_PROPERTY(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatetime.html">QDateTime</a></span> birthday READ birthday NOTIFY birthdayChanged)
        Q_PROPERTY(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> formattedBirthday READ formattedBirthday NOTIFY birthdayChanged)
        Q_PROPERTY(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> email READ email NOTIFY emailChanged)

    <span class="keyword">public</span>:
        ContactViewer(bb<span class="operator">::</span>pim<span class="operator">::</span>contacts<span class="operator">::</span>ContactService <span class="operator">*</span>service<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent <span class="operator">=</span> <span class="number">0</span>);

        <span class="comment">// Sets the ID of the contact that should be displayed.</span>
        <span class="type">void</span> setContactId(bb<span class="operator">::</span>pim<span class="operator">::</span>contacts<span class="operator">::</span>ContactId contactId);

    Q_SIGNALS:
        <span class="comment">// The change notification signals of the properties</span>
        <span class="type">void</span> firstNameChanged();
        <span class="type">void</span> lastNameChanged();
        <span class="type">void</span> birthdayChanged();
        <span class="type">void</span> emailChanged();

    <span class="keyword">private</span> Q_SLOTS:
        <span class="comment">/**
         * This slot is invoked whenever the contact service reports that a contact has been changed.
         */</span>
        <span class="type">void</span> contactsChanged(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qlist.html">QList</a></span><span class="operator">&lt;</span><span class="type">int</span><span class="operator">&gt;</span> <span class="operator">&amp;</span>ids);

    <span class="keyword">private</span>:
        <span class="comment">// The accessor methods of the properties</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> firstName() <span class="keyword">const</span>;
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> lastName() <span class="keyword">const</span>;
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatetime.html">QDateTime</a></span> birthday() <span class="keyword">const</span>;
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> formattedBirthday() <span class="keyword">const</span>;
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> email() <span class="keyword">const</span>;

        <span class="comment">// Loads the contact from the persistent storage and updates the properties</span>
        <span class="type">void</span> updateContact();

        <span class="comment">// The central object to access the contact service</span>
        bb<span class="operator">::</span>pim<span class="operator">::</span>contacts<span class="operator">::</span>ContactService<span class="operator">*</span> m_contactService;

        <span class="comment">// The ID of the contact that is displayed</span>
        bb<span class="operator">::</span>pim<span class="operator">::</span>contacts<span class="operator">::</span>ContactId m_contactId;

        <span class="comment">// The property values</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> m_firstName;
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> m_lastName;
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatetime.html">QDateTime</a></span> m_birthday;
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> m_email;
    };</pre>
<p>Inside the constructor the contactsChanged() signal of the <tt>ContactService</tt> is connected against the custom contactsChanged() slot to reload the currently displayed contact from the persistent storage if it has been changed by some other entity.</p>
<pre class="cpp">    ContactViewer<span class="operator">::</span>ContactViewer(ContactService <span class="operator">*</span>service<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent)
        : <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>(parent)
        <span class="operator">,</span> m_contactService(service)
        <span class="operator">,</span> m_contactId(<span class="operator">-</span><span class="number">1</span>)
    {
        <span class="comment">// Ensure to invoke the contactsChanged() method whenever a contact has been changed</span>
        connect(m_contactService<span class="operator">,</span> SIGNAL(contactsChanged(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qlist.html">QList</a></span><span class="operator">&lt;</span><span class="type">int</span><span class="operator">&gt;</span>))<span class="operator">,</span> SLOT(contactsChanged(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qlist.html">QList</a></span><span class="operator">&lt;</span><span class="type">int</span><span class="operator">&gt;</span>)));
    }</pre>
<p>The method setContactId() is invoked by the <tt>AddressBook</tt> object to prepare the viewer to display a contact in the UI. In this method the passed ID is stored locally and updateContact() is called afterwards.</p>
<pre class="cpp">    <span class="type">void</span> ContactViewer<span class="operator">::</span>setContactId(ContactId contactId)
    {
        <span class="keyword">if</span> (m_contactId <span class="operator">=</span><span class="operator">=</span> contactId)
            <span class="keyword">return</span>;

        m_contactId <span class="operator">=</span> contactId;

        <span class="comment">// Trigger a refetch of the contact for the new ID</span>
        updateContact();
    }</pre>
<p>Inside updateContact() the actual contact data are loaded from the persistent storage through the <tt>ContactService</tt> object. If the value of a contact property has changed, the change notification signal is emitted.</p>
<pre class="cpp">    <span class="type">void</span> ContactViewer<span class="operator">::</span>updateContact()
    {
        <span class="comment">// Store previous values</span>
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> oldFirstName <span class="operator">=</span> m_firstName;
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> oldLastName <span class="operator">=</span> m_lastName;
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatetime.html">QDateTime</a></span> oldBirthday <span class="operator">=</span> m_birthday;
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> oldEmail <span class="operator">=</span> m_email;

        <span class="comment">// Fetch new values from persistent storage</span>
        <span class="keyword">const</span> Contact contact <span class="operator">=</span> m_contactService<span class="operator">-</span><span class="operator">&gt;</span>contactDetails(m_contactId);

        m_firstName <span class="operator">=</span> contact<span class="operator">.</span>firstName();
        m_lastName <span class="operator">=</span> contact<span class="operator">.</span>lastName();

        m_birthday <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatetime.html">QDateTime</a></span>();
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qlist.html">QList</a></span><span class="operator">&lt;</span>ContactAttribute<span class="operator">&gt;</span> dateAttributes <span class="operator">=</span> contact<span class="operator">.</span>filteredAttributes(AttributeKind<span class="operator">::</span>Date);
        foreach (<span class="keyword">const</span> ContactAttribute <span class="operator">&amp;</span>dateAttribute<span class="operator">,</span> dateAttributes) {
            <span class="keyword">if</span> (dateAttribute<span class="operator">.</span>subKind() <span class="operator">=</span><span class="operator">=</span> AttributeSubKind<span class="operator">::</span>DateBirthday)
                m_birthday <span class="operator">=</span> dateAttribute<span class="operator">.</span>valueAsDateTime();
        }

        m_email<span class="operator">.</span>clear();
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qlist.html">QList</a></span><span class="operator">&lt;</span>ContactAttribute<span class="operator">&gt;</span> emails <span class="operator">=</span> contact<span class="operator">.</span>emails();
        <span class="keyword">if</span> (<span class="operator">!</span>emails<span class="operator">.</span>isEmpty())
            m_email <span class="operator">=</span> emails<span class="operator">.</span>first()<span class="operator">.</span>value();

        <span class="comment">// Check whether values have changed</span>
        <span class="keyword">if</span> (oldFirstName <span class="operator">!</span><span class="operator">=</span> m_firstName)
            <span class="keyword">emit</span> firstNameChanged();

        <span class="keyword">if</span> (oldLastName <span class="operator">!</span><span class="operator">=</span> m_lastName)
            <span class="keyword">emit</span> lastNameChanged();

        <span class="keyword">if</span> (oldBirthday <span class="operator">!</span><span class="operator">=</span> m_birthday)
            <span class="keyword">emit</span> birthdayChanged();

        <span class="keyword">if</span> (oldEmail <span class="operator">!</span><span class="operator">=</span> m_email)
            <span class="keyword">emit</span> emailChanged();
    }</pre>
<p>The custom slot contactsChanged() checks whether the currently displayed contact is in the change set and calls updateContact() accordingly.</p>
<pre class="cpp">    <span class="type">void</span> ContactViewer<span class="operator">::</span>contactsChanged(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qlist.html">QList</a></span><span class="operator">&lt;</span><span class="type">int</span><span class="operator">&gt;</span> <span class="operator">&amp;</span>contactIds)
    {
        <span class="comment">/**
         * Call updateContact() only if the contact we are currently displaying
         * has been changed.
         */</span>
        <span class="keyword">if</span> (contactIds<span class="operator">.</span>contains(m_contactId))
            updateContact();
    }</pre>
<a name="contacteditor"></a>
<h3>ContactEditor</h3>
<p>The ContactEditor class is an UI-independent representation of the contact editor, that provides all the functionality and data as slots and properties. It encapsulates all the logic of creating a new contact or updating an existing one.</p>
<pre class="cpp">    <span class="keyword">class</span> ContactEditor : <span class="keyword">public</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>
    {
        Q_OBJECT

        <span class="comment">// The data properties of the contact that is created or updated</span>
        Q_PROPERTY(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> firstName READ firstName WRITE setFirstName NOTIFY firstNameChanged)
        Q_PROPERTY(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> lastName READ lastName WRITE setLastName NOTIFY lastNameChanged)
        Q_PROPERTY(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatetime.html">QDateTime</a></span> birthday READ birthday WRITE setBirthday NOTIFY birthdayChanged)
        Q_PROPERTY(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> email READ email WRITE setEmail NOTIFY emailChanged)

        <span class="comment">// Defines whether the editor is in 'create' or 'edit' mode</span>
        Q_PROPERTY(Mode mode READ mode WRITE setMode NOTIFY modeChanged)

        Q_ENUMS(Mode)

    <span class="keyword">public</span>:
        <span class="comment">/**
         * Describes the mode of the contact editor.
         * The mode information are used to adapt the behavior of the editor and
         * provide hints to the UI.
         */</span>
        <span class="keyword">enum</span> Mode {
            CreateMode<span class="operator">,</span>
            EditMode
        };

        ContactEditor(bb<span class="operator">::</span>pim<span class="operator">::</span>contacts<span class="operator">::</span>ContactService <span class="operator">*</span>service<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent <span class="operator">=</span> <span class="number">0</span>);

        <span class="type">void</span> setMode(Mode mode);
        Mode mode() <span class="keyword">const</span>;

    <span class="keyword">public</span> Q_SLOTS:
        <span class="comment">/**
         * Loads the contact with the given ID.
         */</span>
        <span class="type">void</span> loadContact(bb<span class="operator">::</span>pim<span class="operator">::</span>contacts<span class="operator">::</span>ContactId contactId);

        <span class="comment">/**
         * Save the currently loaded contact if in 'edit' mode or creates a new one
         * if in 'create' mode.
         */</span>
        <span class="type">void</span> saveContact();

        <span class="comment">/**
         * Resets all fields of the contact editor.
         */</span>
        <span class="type">void</span> reset();

    Q_SIGNALS:
        <span class="comment">// The change notification signals of the properties</span>
        <span class="type">void</span> firstNameChanged();
        <span class="type">void</span> lastNameChanged();
        <span class="type">void</span> birthdayChanged();
        <span class="type">void</span> emailChanged();
        <span class="type">void</span> modeChanged();

    <span class="keyword">private</span>:
        <span class="comment">// The accessor methods of the properties</span>
        <span class="type">void</span> setFirstName(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> <span class="operator">&amp;</span>firstName);
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> firstName() <span class="keyword">const</span>;

        <span class="type">void</span> setLastName(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> <span class="operator">&amp;</span>lastName);
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> lastName() <span class="keyword">const</span>;

        <span class="type">void</span> setBirthday(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatetime.html">QDateTime</a></span> <span class="operator">&amp;</span>birthday);
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatetime.html">QDateTime</a></span> birthday() <span class="keyword">const</span>;

        <span class="type">void</span> setEmail(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> <span class="operator">&amp;</span>email);
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> email() <span class="keyword">const</span>;

        <span class="comment">// The central object to access the contact service</span>
        bb<span class="operator">::</span>pim<span class="operator">::</span>contacts<span class="operator">::</span>ContactService <span class="operator">*</span>m_contactService;

        <span class="comment">// The ID of the currently loaded contact (if in 'edit' mode)</span>
        bb<span class="operator">::</span>pim<span class="operator">::</span>contacts<span class="operator">::</span>ContactId m_contactId;

        <span class="comment">// The property values</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> m_firstName;
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> m_lastName;
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatetime.html">QDateTime</a></span> m_birthday;
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> m_email;

        Mode m_mode;
    };</pre>
<p>Inside the constructor the member variables are initialized with the default values.</p>
<pre class="cpp">    ContactEditor<span class="operator">::</span>ContactEditor(ContactService <span class="operator">*</span>service<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent)
        : <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>(parent)
        <span class="operator">,</span> m_contactService(service)
        <span class="operator">,</span> m_contactId(<span class="operator">-</span><span class="number">1</span>)
        <span class="operator">,</span> m_birthday(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatetime.html">QDateTime</a></span><span class="operator">::</span>currentDateTime())
        <span class="operator">,</span> m_mode(CreateMode)
    {
    }</pre>
<p>If the user wants to edit an existing contact, the <tt>AddressBook</tt> object invokes loadContact() to load the contact data from the persistent storage and make them available to the UI through the properties.</p>
<pre class="cpp">    <span class="type">void</span> ContactEditor<span class="operator">::</span>loadContact(ContactId contactId)
    {
        m_contactId <span class="operator">=</span> contactId;

        <span class="comment">// Load the contact from the persistent storage</span>
        <span class="keyword">const</span> Contact contact <span class="operator">=</span> m_contactService<span class="operator">-</span><span class="operator">&gt;</span>contactDetails(m_contactId);

        <span class="comment">// Update the properties with the data from the contact</span>
        m_firstName <span class="operator">=</span> contact<span class="operator">.</span>firstName();
        m_lastName <span class="operator">=</span> contact<span class="operator">.</span>lastName();

        m_birthday <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatetime.html">QDateTime</a></span><span class="operator">::</span>currentDateTime();
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qlist.html">QList</a></span><span class="operator">&lt;</span>ContactAttribute<span class="operator">&gt;</span> dateAttributes <span class="operator">=</span> contact<span class="operator">.</span>filteredAttributes(AttributeKind<span class="operator">::</span>Date);
        foreach (<span class="keyword">const</span> ContactAttribute <span class="operator">&amp;</span>dateAttribute<span class="operator">,</span> dateAttributes) {
            <span class="keyword">if</span> (dateAttribute<span class="operator">.</span>subKind() <span class="operator">=</span><span class="operator">=</span> AttributeSubKind<span class="operator">::</span>DateBirthday)
                m_birthday <span class="operator">=</span> dateAttribute<span class="operator">.</span>valueAsDateTime();
        }

        m_email<span class="operator">.</span>clear();
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qlist.html">QList</a></span><span class="operator">&lt;</span>ContactAttribute<span class="operator">&gt;</span> emails <span class="operator">=</span> contact<span class="operator">.</span>emails();
        <span class="keyword">if</span> (<span class="operator">!</span>emails<span class="operator">.</span>isEmpty())
            m_email <span class="operator">=</span> emails<span class="operator">.</span>first()<span class="operator">.</span>value();

        <span class="comment">// Emit the change notifications</span>
        <span class="keyword">emit</span> firstNameChanged();
        <span class="keyword">emit</span> lastNameChanged();
        <span class="keyword">emit</span> birthdayChanged();
        <span class="keyword">emit</span> emailChanged();
    }</pre>
<p>When the user clicks on the 'Create'/'Save' button in the UI, saveContact() is invoked. Depending on the current mode, a new contact is created or the current one modified. In both cases the <tt>ContactBuilder</tt> class is used to add or change the attributes of the <tt>Contact</tt> object.</p>
<pre class="cpp">    <span class="type">void</span> ContactEditor<span class="operator">::</span>saveContact()
    {
        <span class="keyword">if</span> (m_mode <span class="operator">=</span><span class="operator">=</span> CreateMode) {
            <span class="comment">// Create a builder to assemble the new contact</span>
            ContactBuilder builder;

            <span class="comment">// Set the first name</span>
            builder<span class="operator">.</span>addAttribute(ContactAttributeBuilder()
                                <span class="operator">.</span>setKind(AttributeKind<span class="operator">::</span>Name)
                                <span class="operator">.</span>setSubKind(AttributeSubKind<span class="operator">::</span>NameGiven)
                                <span class="operator">.</span>setValue(m_firstName));

            <span class="comment">// Set the last name</span>
            builder<span class="operator">.</span>addAttribute(ContactAttributeBuilder()
                                <span class="operator">.</span>setKind(AttributeKind<span class="operator">::</span>Name)
                                <span class="operator">.</span>setSubKind(AttributeSubKind<span class="operator">::</span>NameSurname)
                                <span class="operator">.</span>setValue(m_lastName));

            <span class="comment">// Set the birthday</span>
            builder<span class="operator">.</span>addAttribute(ContactAttributeBuilder()
                                <span class="operator">.</span>setKind(AttributeKind<span class="operator">::</span>Date)
                                <span class="operator">.</span>setSubKind(AttributeSubKind<span class="operator">::</span>DateBirthday)
                                <span class="operator">.</span>setValue(m_birthday));

            <span class="comment">// Set the email address</span>
            builder<span class="operator">.</span>addAttribute(ContactAttributeBuilder()
                                <span class="operator">.</span>setKind(AttributeKind<span class="operator">::</span>Email)
                                <span class="operator">.</span>setSubKind(AttributeSubKind<span class="operator">::</span>Other)
                                <span class="operator">.</span>setValue(m_email));

            <span class="comment">// Save the contact to persistent storage</span>
            m_contactService<span class="operator">-</span><span class="operator">&gt;</span>createContact(builder<span class="operator">,</span> <span class="keyword">false</span>);

        } <span class="keyword">else</span> <span class="keyword">if</span> (m_mode <span class="operator">=</span><span class="operator">=</span> EditMode) {
            <span class="comment">// Load the contact from persistent storage</span>
            Contact contact <span class="operator">=</span> m_contactService<span class="operator">-</span><span class="operator">&gt;</span>contactDetails(m_contactId);
            <span class="keyword">if</span> (contact<span class="operator">.</span>id()) {
                <span class="comment">// Create a builder to modify the contact</span>
                ContactBuilder builder <span class="operator">=</span> contact<span class="operator">.</span>edit();

                <span class="comment">// Update the single attributes</span>
                updateContactAttribute<span class="operator">&lt;</span><span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span><span class="operator">&gt;</span>(builder<span class="operator">,</span> contact<span class="operator">,</span> AttributeKind<span class="operator">::</span>Name<span class="operator">,</span> AttributeSubKind<span class="operator">::</span>NameGiven<span class="operator">,</span> m_firstName);
                updateContactAttribute<span class="operator">&lt;</span><span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span><span class="operator">&gt;</span>(builder<span class="operator">,</span> contact<span class="operator">,</span> AttributeKind<span class="operator">::</span>Name<span class="operator">,</span> AttributeSubKind<span class="operator">::</span>NameSurname<span class="operator">,</span> m_lastName);
                updateContactAttribute<span class="operator">&lt;</span><span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatetime.html">QDateTime</a></span><span class="operator">&gt;</span>(builder<span class="operator">,</span> contact<span class="operator">,</span> AttributeKind<span class="operator">::</span>Date<span class="operator">,</span> AttributeSubKind<span class="operator">::</span>DateBirthday<span class="operator">,</span> m_birthday);
                updateContactAttribute<span class="operator">&lt;</span><span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span><span class="operator">&gt;</span>(builder<span class="operator">,</span> contact<span class="operator">,</span> AttributeKind<span class="operator">::</span>Email<span class="operator">,</span> AttributeSubKind<span class="operator">::</span>Other<span class="operator">,</span> m_email);

                <span class="comment">// Save the updated contact back to persistent storage</span>
                m_contactService<span class="operator">-</span><span class="operator">&gt;</span>updateContact(builder);
            }
        }
    }</pre>
<p>To modify an existing attribute the helper function updateContactAttribute() has been implemented.</p>
<pre class="cpp">    <span class="comment">/**
     * A helper method to update a single attribute on a Contact object.
     * It first deletes the old attribute (if it exists) and adds the attribute with the
     * new value afterwards.
     */</span>
    <span class="keyword">template</span> <span class="operator">&lt;</span><span class="keyword">typename</span> T<span class="operator">&gt;</span>
    <span class="keyword">static</span> <span class="type">void</span> updateContactAttribute(ContactBuilder <span class="operator">&amp;</span>builder<span class="operator">,</span> <span class="keyword">const</span> Contact <span class="operator">&amp;</span>contact<span class="operator">,</span>
                                            AttributeKind<span class="operator">::</span>Type kind<span class="operator">,</span> AttributeSubKind<span class="operator">::</span>Type subKind<span class="operator">,</span>
                                            <span class="keyword">const</span> T <span class="operator">&amp;</span>value)
    {
        <span class="comment">// Delete previous instance of the attribute</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qlist.html">QList</a></span><span class="operator">&lt;</span>ContactAttribute<span class="operator">&gt;</span> attributes <span class="operator">=</span> contact<span class="operator">.</span>filteredAttributes(kind);
        foreach (<span class="keyword">const</span> ContactAttribute <span class="operator">&amp;</span>attribute<span class="operator">,</span> attributes) {
            <span class="keyword">if</span> (attribute<span class="operator">.</span>subKind() <span class="operator">=</span><span class="operator">=</span> subKind)
                builder<span class="operator">.</span>deleteAttribute(attribute);
        }

        <span class="comment">// Add new instance of the attribute with new value</span>
        builder<span class="operator">.</span>addAttribute(ContactAttributeBuilder()
                            <span class="operator">.</span>setKind(kind)
                            <span class="operator">.</span>setSubKind(subKind)
                            <span class="operator">.</span>setValue(value));
    }</pre>
<p>If the user wants to create a new contact, the <tt>AddressBook</tt> object invokes the <a href="http://qt.nokia.com/doc/4.7/qtextstream.html#reset">reset</a>() method to clear all fields of the <tt>ContactEditor</tt>.</p>
<pre class="cpp">    <span class="type">void</span> ContactEditor<span class="operator">::</span><a href="http://qt.nokia.com/doc/4.7/qtextstream.html#reset">reset</a>()
    {
        <span class="comment">// Reset all properties</span>
        m_firstName<span class="operator">.</span>clear();
        m_lastName<span class="operator">.</span>clear();
        m_birthday <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatetime.html">QDateTime</a></span><span class="operator">::</span>currentDateTime();
        m_email<span class="operator">.</span>clear();

        <span class="comment">// Emit the change notifications</span>
        <span class="keyword">emit</span> firstNameChanged();
        <span class="keyword">emit</span> lastNameChanged();
        <span class="keyword">emit</span> birthdayChanged();
        <span class="keyword">emit</span> emailChanged();
    }</pre>
</div>
<!-- @@@pim/addressbook -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Copyright 2012 Research In Motion Limited.
  <br />
    This document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
