<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- nfcdemo.qdoc -->
  <title>Cascades : NFC Demo</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt-based BB10 API Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
<li><a href="http://qt.nokia.com/doc/4.7/all-examples.html">Examples</a></li>
<li>NFC Demo</li>
    </ul>
  </div>
</div>
<div class="content mainContent">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#description">Description</a></li>
<li class="level1"><a href="#overview">Overview</a></li>
<li class="level1"><a href="#the-ui">The UI</a></li>
<li class="level1"><a href="#macaddresshandler">MacAddressHandler</a></li>
<li class="level1"><a href="#nfcsender">NfcSender</a></li>
<li class="level1"><a href="#nfcreceiver">NfcReceiver</a></li>
<li class="level1"><a href="#nfcsharehandler">NfcShareHandler</a></li>
</ul>
</div>
<h1 class="title">NFC Demo</h1>
<span class="subtitle"></span>
<!-- $$$nfcdemo-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="nfcdemo-assets-field-qml.html">nfcdemo/assets/Field.qml</a></li>
<li><a href="nfcdemo-assets-macaddresspage-qml.html">nfcdemo/assets/MacAddressPage.qml</a></li>
<li><a href="nfcdemo-assets-receiverpage-qml.html">nfcdemo/assets/ReceiverPage.qml</a></li>
<li><a href="nfcdemo-assets-senderpage-qml.html">nfcdemo/assets/SenderPage.qml</a></li>
<li><a href="nfcdemo-assets-sharepage-qml.html">nfcdemo/assets/SharePage.qml</a></li>
<li><a href="nfcdemo-assets-main-qml.html">nfcdemo/assets/main.qml</a></li>
<li><a href="nfcdemo-src-filelistmodel-cpp.html">nfcdemo/src/FileListModel.cpp</a></li>
<li><a href="nfcdemo-src-filelistmodel-hpp.html">nfcdemo/src/FileListModel.hpp</a></li>
<li><a href="nfcdemo-src-macaddresshandler-cpp.html">nfcdemo/src/MacAddressHandler.cpp</a></li>
<li><a href="nfcdemo-src-macaddresshandler-hpp.html">nfcdemo/src/MacAddressHandler.hpp</a></li>
<li><a href="nfcdemo-src-nfcreceiver-cpp.html">nfcdemo/src/NfcReceiver.cpp</a></li>
<li><a href="nfcdemo-src-nfcreceiver-hpp.html">nfcdemo/src/NfcReceiver.hpp</a></li>
<li><a href="nfcdemo-src-nfcsender-cpp.html">nfcdemo/src/NfcSender.cpp</a></li>
<li><a href="nfcdemo-src-nfcsender-hpp.html">nfcdemo/src/NfcSender.hpp</a></li>
<li><a href="nfcdemo-src-nfcsharehandler-cpp.html">nfcdemo/src/NfcShareHandler.cpp</a></li>
<li><a href="nfcdemo-src-nfcsharehandler-hpp.html">nfcdemo/src/NfcShareHandler.hpp</a></li>
<li><a href="nfcdemo-src-main-cpp.html">nfcdemo/src/main.cpp</a></li>
<li><a href="nfcdemo-nfcdemo-pro.html">nfcdemo/nfcdemo.pro</a></li>
<li><a href="nfcdemo-translations-nfcdemo-pro.html">nfcdemo/translations/nfcdemo.pro</a></li>
</ul>
<a name="description"></a>
<h2>Description</h2>
<p>The nfc example allows a user to exchange content, such as messages or files with another NFC enabled device, or just to simply read data from NFC tags.</p>
<p class="centerAlign"><img src="images/nfcdemo-example.png" /></p><p class="centerAlign"><img src="images/nfcdemo-example1.png" /></p><p class="centerAlign"><img src="images/nfcdemo-example2.png" /></p><a name="overview"></a>
<h2>Overview</h2>
<p>In this example we'll learn how to use the <tt>NfcShareManager</tt> to share data and files by tapping NFC enabled device or NFC tag. Concurrently, we will also demonstrate data sharing(SNEP protocol) using the BPS library.</p>
<a name="the-ui"></a>
<h2>The UI</h2>
<p>The UI of this sample application consists of 4 tabs that represent different functionality: 'MAC Address', 'Sender', 'Receiver', and 'Share'.</p>
<p>MAC Address</p>
<pre class="qml">            <span class="comment">// The label that shows the MAC address</span>
            <span class="type">Label</span> {
                <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>
                <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Center</span>

                <span class="name">text</span>: <span class="name">qsTr</span>(<span class="string">&quot;MAC Address: %1&quot;</span>).<span class="name">arg</span>(<span class="name">_macAddressHandler</span>.<span class="name">macAddress</span>)
                <span class="type">textStyle</span> {
                    <span class="name">base</span>: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">BodyText</span>
                    <span class="name">color</span>: <span class="name">Color</span>.<span class="name">White</span>
                }
            }</pre>
<p>This tab contains a label which updates with the MAC address of the remote NFC enabled device that you tap. This exchange is done upon sensing a NFC target and successfully establishing a NFC connection.</p>
<p>Sender</p>
<pre class="qml">                <span class="comment">// The input field for the NDEF message payload</span>
                <span class="type">TextField</span> {

                    <span class="name">inputMode</span>: <span class="name">TextFieldInputMode</span>.<span class="name">Text</span>
                    <span class="name">hintText</span>: <span class="name">qsTr</span>(<span class="string">&quot;Enter some text&quot;</span>)
                    <span class="name">onTextChanging</span>: {
                        <span class="name">_nfcSender</span>.<span class="name">payload</span> <span class="operator">=</span> <span class="name">text</span>
                    }
                }

                <span class="comment">// Guide message to display to the user</span>
                <span class="type">Label</span> {
                    <span class="name">text</span>: <span class="name">qsTr</span>(<span class="string">&quot;Type some text into the text field and then tap an NFC tag or device to share content&quot;</span>)

                    <span class="name">multiline</span>: <span class="number">true</span>
                    <span class="type">textStyle</span> {
                        <span class="name">base</span>: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">BodyText</span>
                        <span class="name">color</span>: <span class="name">Color</span>.<span class="name">White</span>
                        <span class="name">textAlign</span>: <span class="name">TextAlign</span>.<span class="name">Center</span>
                    }
                }</pre>
<p>This tab contains a <tt>TextField</tt> and a <tt>Label</tt> with the usage description. Once the user enters some text into the field, this data will be shared with another NFC enabled device, or written to an NFC tag (through tag writing).</p>
<p>Receiver</p>
<pre class="qml">            <span class="comment">// The list view that shows the records of the received NDEF message</span>
            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qml-listview.html">ListView</a></span> {
                <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Fill</span>
                <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Fill</span>

                <span class="name">dataModel</span>: <span class="name">_nfcReceiver</span>.<span class="name">messageRecords</span>

                <span class="name">listItemComponents</span>: [
                    <span class="type">ListItemComponent</span> {
                        <span class="name">type</span>: <span class="string">&quot;&quot;</span>

                        <span class="type">Container</span> {
                            <span class="name">preferredWidth</span>: <span class="number">768</span>
                            <span class="name">leftPadding</span>: <span class="number">10</span>
                            <span class="name">rightPadding</span>: <span class="number">10</span>

                            <span class="type">Field</span> {
                                <span class="name">title</span>: <span class="name">qsTr</span>(<span class="string">&quot;tnf type&quot;</span>)
                                <span class="name">value</span>: <span class="name">ListItemData</span>.<span class="name">tnfType</span> <span class="operator">==</span> <span class="string">&quot;0&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Empty Tag&quot;</span>) :
                                       <span class="name">ListItemData</span>.<span class="name">tnfType</span> <span class="operator">==</span> <span class="string">&quot;1&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Well Known Type&quot;</span>) :
                                       <span class="name">ListItemData</span>.<span class="name">tnfType</span> <span class="operator">==</span> <span class="string">&quot;2&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Media (MIME)&quot;</span>) :
                                       <span class="name">ListItemData</span>.<span class="name">tnfType</span> <span class="operator">==</span> <span class="string">&quot;3&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Uri&quot;</span>) :
                                       <span class="name">ListItemData</span>.<span class="name">tnfType</span> <span class="operator">==</span> <span class="string">&quot;4&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;External&quot;</span>) : <span class="string">&quot;&quot;</span>
                            }

                            <span class="type">Field</span> {
                                <span class="name">title</span>: <span class="name">qsTr</span>(<span class="string">&quot;record type&quot;</span>)
                                <span class="name">value</span>: <span class="name">ListItemData</span>.<span class="name">recordType</span> <span class="operator">==</span> <span class="string">&quot;Sp&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Smart Poster&quot;</span>) :
                                       <span class="name">ListItemData</span>.<span class="name">recordType</span> <span class="operator">==</span> <span class="string">&quot;T&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Text&quot;</span>) :
                                       <span class="name">ListItemData</span>.<span class="name">recordType</span> <span class="operator">==</span> <span class="string">&quot;U&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Uri&quot;</span>) :
                                       <span class="name">ListItemData</span>.<span class="name">recordType</span> <span class="operator">==</span> <span class="string">&quot;Gc&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Generic Control&quot;</span>) :
                                       <span class="name">ListItemData</span>.<span class="name">recordType</span> <span class="operator">==</span> <span class="string">&quot;Hr&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Handover Request&quot;</span>) :
                                       <span class="name">ListItemData</span>.<span class="name">recordType</span> <span class="operator">==</span> <span class="string">&quot;Hs&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Handover Select&quot;</span>) :
                                       <span class="name">ListItemData</span>.<span class="name">recordType</span> <span class="operator">==</span> <span class="string">&quot;Hc&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Handover Carrier&quot;</span>) :
                                       <span class="name">ListItemData</span>.<span class="name">recordType</span> <span class="operator">==</span> <span class="string">&quot;Sig&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Signature&quot;</span>) : <span class="string">&quot;&quot;</span>
                            }

                            <span class="type">Field</span> {
                                <span class="name">title</span>: <span class="name">qsTr</span>(<span class="string">&quot;payload&quot;</span>)
                                <span class="name">value</span>: <span class="name">ListItemData</span>.<span class="name">payload</span>
                            }

                            <span class="type">Field</span> {
                                <span class="name">title</span>: <span class="name">qsTr</span>(<span class="string">&quot;hex&quot;</span>)
                                <span class="name">value</span>: <span class="name">ListItemData</span>.<span class="name">hexPayload</span>
                            }
                        }
                    }
                ]
            }</pre>
<p>This tab is intended to display the properties of the NDEF message, which is shared via some NFC tag, or shared data from another NFC enabled device. The NDEF message records, containing the property information, are displayed through a <tt>ListView</tt>.</p>
<p>Share</p>
<p>This tab is used to share data or files by using the <tt>NfcShareManager</tt>, this being an alternative to the BPS library used in the other tabs to achieve the same functionality. The page contains a <tt>TextField</tt> for data input or uses a <tt>FilePicker</tt> to select the file(s) to be shared.</p>
<p>We export all the C++ classes corresponding to the above mentioned functionalities into QML, under their respective names &quot;<a href="#macaddresshandler">_macAddressHandler</a>, <a href="#nfcreceiver">_nfcReceiver</a>, <a href="#nfcsender">_nfcSender</a>, and <a href="#nfcsharehandler">_nfcShareHandler</a>&quot; as context property insode the main.cpp function.</p>
<pre class="cpp">        QmlDocument <span class="operator">*</span>qml <span class="operator">=</span> QmlDocument<span class="operator">::</span>create(<span class="string">&quot;asset:///main.qml&quot;</span>)<span class="operator">.</span>parent(<span class="operator">&amp;</span>app);
        qml<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(<span class="string">&quot;_macAddressHandler&quot;</span><span class="operator">,</span> <span class="keyword">new</span> MacAddressHandler(<span class="operator">&amp;</span>app));
        qml<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(<span class="string">&quot;_nfcReceiver&quot;</span><span class="operator">,</span> <span class="keyword">new</span> NfcReceiver(<span class="operator">&amp;</span>app));
        qml<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(<span class="string">&quot;_nfcSender&quot;</span><span class="operator">,</span> <span class="keyword">new</span> NfcSender(<span class="operator">&amp;</span>app));
        qml<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(<span class="string">&quot;_nfcShareHandler&quot;</span><span class="operator">,</span> <span class="keyword">new</span> NfcShareHandler(<span class="operator">&amp;</span>app));</pre>
<p>Inside the QML pages for each tab, we simply bind the properties of the labels, text fields or data models to their corresponding exported properties. Which invokes automatically the functionality upon user interaction or the display of received data. For example, in the Sender page the onTextChanging handler assigns the text from the TextField to the &quot;<a href="#nfcsender">_nfcSender</a>.payload&quot; property, the payload(data) in turn is pushed to another NFC device upon establishing a connection.</p>
<a name="macaddresshandler"></a>
<h2>MacAddressHandler</h2>
<p>This class is tasked with the acquisition of the MAC address, it does so using the Bps library by initializing it, registering with the nfc domain and dealing with the nfc handover to acquire the mac address.</p>
<pre class="cpp">    <span class="type">void</span> MacAddressHandler<span class="operator">::</span>initialize()
    {
        bps_initialize();
        subscribe(nfc_get_domain());

        <span class="keyword">const</span> <span class="type">int</span> rc <span class="operator">=</span> nfc_request_events();
        <span class="keyword">if</span> (rc <span class="operator">=</span><span class="operator">=</span> NFC_RESULT_SUCCESS) {
            <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;[INFO] Request NFC Events: NFC_RESULT_SUCCESS&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> endl;
        } <span class="keyword">else</span> {
            nfc_stop_events();
            unsubscribe(nfc_get_domain());
            bps_shutdown();
            <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;[ERRO] Request NFC Events: NFC_RESULT_FAILURE&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> endl;
        }

        nfc_register_handover_listener(BLUETOOTH_HANDOVER);
    }</pre>
<p>This snippet does the initial Bps initialization for use with the current thread and registers with the NFC domain in order to receive nfc events, plus it registers the bluetooth handover listener.</p>
<pre class="cpp">    <span class="type">void</span> MacAddressHandler<span class="operator">::</span>handleNfcHandoverDetectedEvent(nfc_target_t <span class="operator">*</span>target)
    {
        nfc_confirm_handover_process(target<span class="operator">,</span> <span class="keyword">true</span>);
        <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;[INFO] Confirmed Handover&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> endl;
    }

    <span class="type">void</span> MacAddressHandler<span class="operator">::</span>handleNfcHandoverCompletedEvent(nfc_target_t <span class="operator">*</span>target)
    {
        handover_transport_type_t transport;
        nfc_get_handover_transport(target<span class="operator">,</span> <span class="operator">&amp;</span>transport);

        nfc_bluetooth_handover_data_t bluetooth_data;
        nfc_get_bluetooth_handover_data(target<span class="operator">,</span> <span class="operator">&amp;</span>bluetooth_data);

        <span class="comment">// The MAC address is in little-endian order</span>
        <span class="keyword">const</span> <span class="type">unsigned</span> <span class="type">char</span> <span class="operator">*</span>macAddr <span class="operator">=</span> bluetooth_data<span class="operator">.</span>mac_address;

        m_macAddress<span class="operator">.</span>sprintf(<span class="string">&quot;%02x:%02x:%02x:%02x:%02x:%02x&quot;</span><span class="operator">,</span> (<span class="type">unsigned</span> <span class="type">int</span>) macAddr<span class="operator">[</span><span class="number">5</span><span class="operator">]</span><span class="operator">,</span>
                            (<span class="type">unsigned</span> <span class="type">int</span>) macAddr<span class="operator">[</span><span class="number">4</span><span class="operator">]</span><span class="operator">,</span> (<span class="type">unsigned</span> <span class="type">int</span>) macAddr<span class="operator">[</span><span class="number">3</span><span class="operator">]</span><span class="operator">,</span>
                            (<span class="type">unsigned</span> <span class="type">int</span>) macAddr<span class="operator">[</span><span class="number">2</span><span class="operator">]</span><span class="operator">,</span> (<span class="type">unsigned</span> <span class="type">int</span>) macAddr<span class="operator">[</span><span class="number">1</span><span class="operator">]</span><span class="operator">,</span>
                            (<span class="type">unsigned</span> <span class="type">int</span>) macAddr<span class="operator">[</span><span class="number">0</span><span class="operator">]</span>);

        <span class="keyword">emit</span> macAddressChanged();
        <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;[INFO] MAC ADDRESS: &quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> m_macAddress <span class="operator">&lt;</span><span class="operator">&lt;</span> endl;
    }</pre>
<p>Once the handover has been confirmed and completed, the bluetooth handover data is parsed specifically to extract the mac address value. Which is than formatted into a <a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a> for display by emiting the macAddressChanged() signal, with the string as its argument.</p>
<a name="nfcsender"></a>
<h2>NfcSender</h2>
<p>The following class is responsible for sending a text payload, using the NFC SNEP push protocol, to another NFC enabled device, or to write to an NFC tag.</p>
<pre class="cpp">    <span class="type">void</span> NfcSender<span class="operator">::</span>initialize()
    {
        bps_initialize();
        subscribe(nfc_get_domain());

        <span class="keyword">const</span> <span class="type">int</span> rc <span class="operator">=</span> nfc_request_events();
        <span class="keyword">if</span> (rc <span class="operator">=</span><span class="operator">=</span> NFC_RESULT_SUCCESS) {
            <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;[INFO] Request NFC Events: NFC_RESULT_SUCCESS&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> endl;
        } <span class="keyword">else</span> {
            nfc_stop_events();
            unsubscribe(nfc_get_domain());
            bps_shutdown();
            <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;[ERRO] Request NFC Events: NFC_RESULT_FAILURE&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> endl;
        }
        nfc_register_snep_client();
    }</pre>
<p>This code does the Bps initialization for use with the current thread and subscribes to receive NFC events and registers as a snep client.</p>
<pre class="cpp">    <span class="type">void</span> NfcSender<span class="operator">::</span>event(bps_event_t <span class="operator">*</span>event)
    {
        uint16_t code <span class="operator">=</span> bps_event_get_code(event);
        nfc_event_t <span class="operator">*</span>nfc_event <span class="operator">=</span> <span class="number">0</span>;

        <span class="keyword">if</span> (nfc_get_nfc_event(event<span class="operator">,</span> <span class="operator">&amp;</span>nfc_event) <span class="operator">!</span><span class="operator">=</span> BPS_SUCCESS) {
            <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;[ERRO] Get NFC event: BPS_FAILURE&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> endl;
        }

        nfc_target_t <span class="operator">*</span>target <span class="operator">=</span> <span class="number">0</span>;
        nfc_get_target(nfc_event<span class="operator">,</span> <span class="operator">&amp;</span>target);

        <span class="keyword">switch</span> (code) {
            <span class="keyword">case</span> NFC_SNEP_CONNECTION_EVENT: {
                <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;[INFO] Received NFC_NDEF_PUSH_EVENT&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> endl;
                handleSnepPush(target);
            }
            <span class="keyword">break</span>;
            <span class="keyword">case</span> NFC_NDEF_PUSH_SUCCEED_EVENT: {
                <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;[INFO] Received NFC_NDEF_PUSH_SUCCEED_EVENT&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> endl;
            }
            <span class="keyword">break</span>;
            <span class="keyword">case</span> NFC_NDEF_PUSH_FAILURE_MSG_OVER_SIZE_EVENT: {
                <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;[ERRO] Received NFC_NDEF_PUSH_FAILURE_MSG_OVER_SIZE_EVENT&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> endl;
            }
            <span class="keyword">break</span>;
            <span class="keyword">case</span> NFC_NDEF_PUSH_FAILURE_REJECTED_EVENT: {
                <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;[ERRO] Received NFC_NDEF_PUSH_FAILURE_REJECTED_EVENT&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> endl;
            }
            <span class="keyword">break</span>;
            <span class="keyword">case</span> NFC_NDEF_PUSH_FAILURE_IO_ERROR_EVENT: {
                <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;[ERRO] Received NFC_NDEF_PUSH_FAILURE_IO_ERROR_EVENT&quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> endl;
            }
            <span class="keyword">break</span>;
            <span class="keyword">default</span>: {
                <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;[WARN] Event not handled: &quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> code <span class="operator">&lt;</span><span class="operator">&lt;</span> endl;
            }
            <span class="keyword">break</span>;
        }

        nfc_destroy_target(target);
    }</pre>
<p>This method listens to the NFC events, and upon receiving a successful NFC SNEP connection it invokes the handleSnepPush() method to deal with sending the data.</p>
<pre class="cpp">    <span class="type">void</span> NfcSender<span class="operator">::</span>handleSnepPush(nfc_target_t <span class="operator">*</span>target)
    {
        nfc_ndef_message_t <span class="operator">*</span>ndef_message;
        nfc_create_ndef_message(<span class="operator">&amp;</span>ndef_message);

        nfc_ndef_record_t <span class="operator">*</span>record;
        <span class="keyword">const</span> <span class="type">char</span><span class="operator">*</span> record_type <span class="operator">=</span> <span class="string">&quot;text/plain&quot;</span>;
        <span class="keyword">const</span> uchar_t <span class="operator">*</span>payload <span class="operator">=</span> (<span class="keyword">const</span> uchar_t <span class="operator">*</span>)m_payload<span class="operator">.</span>toUtf8()<span class="operator">.</span>constData();

        <span class="comment">//TODO: Kind of sketchy.</span>
        <span class="keyword">const</span> <span class="type">int</span> payload_length <span class="operator">=</span> m_payload<span class="operator">.</span>toUtf8()<span class="operator">.</span>length();
        nfc_create_ndef_record(NDEF_TNF_MEDIA<span class="operator">,</span> record_type<span class="operator">,</span> payload<span class="operator">,</span> payload_length<span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="operator">&amp;</span>record);

        nfc_add_ndef_record(ndef_message<span class="operator">,</span> record);

        nfc_push_ndef_message(target<span class="operator">,</span> ndef_message);
        nfc_delete_ndef_message(ndef_message<span class="operator">,</span> <span class="keyword">true</span>);
    }</pre>
<p>This method creates a ndefrecord that houses the payload (data), this record is than added to a standard ndefmessage which is than pushed to the other device using the SNEP protocol.</p>
<a name="nfcreceiver"></a>
<h2>NfcReceiver</h2>
<p>This class retrieves the NdefMessage being transmitted, extracts its properties and displays them on the screen.</p>
<pre class="cpp">    NfcReceiver<span class="operator">::</span>NfcReceiver(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent)
        : <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>(parent)
        <span class="operator">,</span> m_messageRecords(<span class="keyword">new</span> bb<span class="operator">::</span>cascades<span class="operator">::</span><span class="type">QVariantListDataModel</span>())
    {
        m_messageRecords<span class="operator">-</span><span class="operator">&gt;</span>setParent(<span class="keyword">this</span>);

        <span class="comment">// Create an InvokeManager</span>
        bb<span class="operator">::</span>system<span class="operator">::</span>InvokeManager <span class="operator">*</span>invokeManager <span class="operator">=</span> <span class="keyword">new</span> bb<span class="operator">::</span>system<span class="operator">::</span>InvokeManager(<span class="keyword">this</span>);

        <span class="comment">/**
         * The signal invoked(const bb::system::InvokeRequest&amp;) is used for applications.
         */</span>
        connect(invokeManager<span class="operator">,</span> SIGNAL(invoked(<span class="keyword">const</span> bb<span class="operator">::</span>system<span class="operator">::</span>InvokeRequest<span class="operator">&amp;</span>))<span class="operator">,</span>
                <span class="keyword">this</span><span class="operator">,</span> SLOT(receivedInvokeTarget(<span class="keyword">const</span> bb<span class="operator">::</span>system<span class="operator">::</span>InvokeRequest<span class="operator">&amp;</span>)));
    }</pre>
<p>Inside the constructor the <tt>InvokeManager</tt> is initialized, from whom we listen for invoke requests.</p>
<pre class="cpp">    <span class="type">void</span> NfcReceiver<span class="operator">::</span>receivedInvokeTarget(<span class="keyword">const</span> bb<span class="operator">::</span>system<span class="operator">::</span>InvokeRequest<span class="operator">&amp;</span> request)
    {
        <span class="comment">// The data contains our NDEF message</span>
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qbytearray.html">QByteArray</a></span> data <span class="operator">=</span> request<span class="operator">.</span>data();

        <span class="comment">// Create out NDEF message</span>
        <span class="keyword">const</span> <span class="type">QtMobilitySubset</span><span class="operator">::</span><span class="type">QNdefMessage</span> ndefMessage <span class="operator">=</span> <span class="type">QtMobilitySubset</span><span class="operator">::</span><span class="type">QNdefMessage</span><span class="operator">::</span>fromByteArray(data);

        <span class="comment">// Fill the model with the single records</span>
        m_messageRecords<span class="operator">-</span><span class="operator">&gt;</span>clear();

        <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> ndefMessage<span class="operator">.</span>size(); <span class="operator">+</span><span class="operator">+</span>i) {
            <span class="keyword">const</span> <span class="type">QtMobilitySubset</span><span class="operator">::</span><span class="type">QNdefRecord</span> record <span class="operator">=</span> ndefMessage<span class="operator">.</span>at(i);

            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantMap-typedef">QVariantMap</a></span> entry;
            entry<span class="operator">[</span><span class="string">&quot;tnfType&quot;</span><span class="operator">]</span> <span class="operator">=</span> record<span class="operator">.</span>typeNameFormat();
            entry<span class="operator">[</span><span class="string">&quot;recordType&quot;</span><span class="operator">]</span> <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span><span class="operator">::</span>fromLatin1(record<span class="operator">.</span>type());
            entry<span class="operator">[</span><span class="string">&quot;payload&quot;</span><span class="operator">]</span> <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span><span class="operator">::</span>fromLatin1(record<span class="operator">.</span>payload());
            entry<span class="operator">[</span><span class="string">&quot;hexPayload&quot;</span><span class="operator">]</span> <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span><span class="operator">::</span>fromLatin1(record<span class="operator">.</span>payload()<span class="operator">.</span>toHex());

            m_messageRecords<span class="operator">-</span><span class="operator">&gt;</span>append(entry);
        }

        <span class="keyword">emit</span> messageReceived();
    }</pre>
<p>This method exttracts the data portion of the request, which is the <tt>QNdefMessage</tt> we have been waiting for. Afterwards, it access' the record entries from the message and saves them in the <tt>QVariantListDataModel</tt> for display.</p>
<a name="nfcsharehandler"></a>
<h2>NfcShareHandler</h2>
<p>The <tt>NfcShareHandler</tt> class performs sharing of data and files over NFC, with some similarity to <a href="#nfcsender">NfcSender</a>, the difference being the underlying mechanism used to perform this sharing. Instead of using the Bps library, it uses the <tt>NfcShareManager</tt> to achieve the same result, but with a more convenient way. The <tt>NfcShareManager</tt> will allow sharing data to either a tag (through tag writing) or to another device (SNEP Push) behind the scenes.</p>
<pre class="cpp">    NfcShareHandler<span class="operator">::</span>NfcShareHandler(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent)
        : <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>(parent)
        <span class="operator">,</span> m_shareMode(DataShare)
        <span class="operator">,</span> m_fileListModel(<span class="keyword">new</span> FileListModel(<span class="keyword">this</span>))
        <span class="operator">,</span> m_systemToast(<span class="keyword">new</span> bb<span class="operator">::</span>system<span class="operator">::</span>SystemToast(<span class="keyword">this</span>))
        <span class="operator">,</span> m_nfcShareManager(<span class="keyword">new</span> bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareManager(<span class="keyword">this</span>))
    {
        connect(m_fileListModel<span class="operator">,</span> SIGNAL(changed())<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> SLOT(prepareFileShareContent()));

        <span class="comment">// Connect signal for finished (success) notifications</span>
        connect(m_nfcShareManager<span class="operator">,</span> SIGNAL(finished(bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareSuccess<span class="operator">::</span>Type))<span class="operator">,</span>
                <span class="keyword">this</span><span class="operator">,</span> SLOT(sharingFinished(bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareSuccess<span class="operator">::</span>Type)));

        <span class="comment">// Connect signal for error notifications</span>
        connect(m_nfcShareManager<span class="operator">,</span> SIGNAL(error(bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareError<span class="operator">::</span>Type))<span class="operator">,</span>
                <span class="keyword">this</span><span class="operator">,</span> SLOT(sharingError(bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareError<span class="operator">::</span>Type)));
    }</pre>
<p>The constructor initializes it's member variables, including the <tt>NfcShareManager</tt> and makes the signal/slot connections.</p>
<pre class="cpp">    <span class="type">void</span> NfcShareHandler<span class="operator">::</span>prepareDataShareContent()
    {
        <span class="keyword">if</span> (m_data<span class="operator">.</span>isEmpty())
            <span class="keyword">return</span>;

        <span class="comment">// Prepare new data share content</span>
        bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareDataContent dataShareContent;

        <span class="comment">// The data content needs to be stored as a QByteArray</span>
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qbytearray.html">QByteArray</a></span> data(m_data<span class="operator">.</span>toUtf8());

        <span class="comment">// We will share our data as text/plain data</span>
        dataShareContent<span class="operator">.</span>setMimeType(QLatin1String(<span class="string">&quot;text/plain&quot;</span>));
        dataShareContent<span class="operator">.</span>setData(data);

        <span class="comment">// Set the share content to our new data share content</span>
        m_nfcShareManager<span class="operator">-</span><span class="operator">&gt;</span>setShareContent(dataShareContent);
    }</pre>
<p>Clients specify the data they want to share by creating an instance of NfcShareDataContent, populating it with data, and passing the object to NfcShareManager::setShareContent(const NfcShareDataContent &amp;). A request must contain a valid combination of MIME type, data and URI fields.</p>
<pre class="cpp">    <span class="type">void</span> NfcShareHandler<span class="operator">::</span>prepareFileShareContent()
    {
        <span class="comment">// Prepare new file share content</span>
        bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareFilesContent fileShareContent;

        <span class="comment">// Get the current list of files stored by the FileListModel</span>
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qlist.html">QList</a></span><span class="operator">&lt;</span><span class="type"><a href="http://qt.nokia.com/doc/4.7/qurl.html">QUrl</a></span><span class="operator">&gt;</span> files <span class="operator">=</span> m_fileListModel<span class="operator">-</span><span class="operator">&gt;</span>files();
        <span class="keyword">if</span> (files<span class="operator">.</span>isEmpty())
            <span class="keyword">return</span>;

        fileShareContent<span class="operator">.</span>setFileUrls(files);

        <span class="comment">// Set the share content to our new file share content</span>
        m_nfcShareManager<span class="operator">-</span><span class="operator">&gt;</span>setShareContent(fileShareContent);
    }</pre>
<p>Defines a request to share local files over NFC.</p>
<p>The files are given through the <tt>FileListModel</tt>, which is populated using <tt>FilePicker</tt>. The files you wish to share are specified by creating an instance of NfcShareFilesContent, populating it with file paths in URI form, and passing the object to NfcShareManager::setShareContent(const NfcShareFilesContent &amp;).</p>
<p>Note that a request must contain at least one file to be valid.</p>
<pre class="cpp">    <span class="type">void</span> NfcShareHandler<span class="operator">::</span>sharingFinished(bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareSuccess<span class="operator">::</span>Type result)
    {
        <span class="comment">// TODO: clean up - some bluetooth notifications overlap with ours</span>
        <span class="comment">// we will display a System Toast when a transaction has been completed successfully</span>
        <span class="keyword">switch</span> (result) {
            <span class="keyword">case</span> bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareSuccess<span class="operator">::</span>File:
                displayNotification(tr(<span class="string">&quot;NFC file transfer started successfully&quot;</span>));
                <span class="keyword">break</span>;
            <span class="keyword">case</span> bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareSuccess<span class="operator">::</span>Snep:
                displayNotification(tr(<span class="string">&quot;NFC data was transfered successfully&quot;</span>));
                <span class="keyword">break</span>;
            <span class="keyword">case</span> bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareSuccess<span class="operator">::</span>TagWrite:
                displayNotification(tr(<span class="string">&quot;NFC data was written successfully&quot;</span>));
                <span class="keyword">break</span>;
            <span class="keyword">default</span>:
                displayNotification(tr(<span class="string">&quot;Unknown share success&quot;</span>));
                <span class="keyword">break</span>;
        }
    }

    <span class="type">void</span> NfcShareHandler<span class="operator">::</span>sharingError(bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareError<span class="operator">::</span>Type error)
    {
        <span class="keyword">switch</span> (error) {
            <span class="comment">/**
             * Unrecoverable NFC errors
             */</span>
            <span class="keyword">case</span> bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareError<span class="operator">::</span>NoContentToShare:
            <span class="keyword">case</span> bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareError<span class="operator">::</span>Unknown:
                displayNotification(tr(<span class="string">&quot;Failed to share data over NFC&quot;</span>));
                <span class="keyword">break</span>;
            <span class="keyword">case</span> bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareError<span class="operator">::</span>RegisterFileSharing:
                displayNotification(tr(<span class="string">&quot;Failed to prepare for file sharing&quot;</span>));
                <span class="keyword">break</span>;
            <span class="keyword">case</span> bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareError<span class="operator">::</span>RegisterDataSharing:
                displayNotification(tr(<span class="string">&quot;Failed to prepare for data sharing&quot;</span>));
                <span class="keyword">break</span>;
                <span class="comment">/**
                 * Recoverable NFC errors - try again
                 */</span>
            <span class="keyword">case</span> bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareError<span class="operator">::</span>MessageSize:
                displayNotification(tr(<span class="string">&quot;NFC Tag is too small for a shared message&quot;</span>));
                <span class="keyword">break</span>;
            <span class="keyword">case</span> bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareError<span class="operator">::</span>TagLocked:
                displayNotification(tr(<span class="string">&quot;Failed to write to a locked NFC Tag&quot;</span>));
                <span class="keyword">break</span>;
            <span class="keyword">case</span> bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareError<span class="operator">::</span>UnsupportedTagType:
                displayNotification(tr(<span class="string">&quot;Failed to write to a unsupported NFC Tag&quot;</span>));
                <span class="keyword">break</span>;
            <span class="keyword">case</span> bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareError<span class="operator">::</span>DataTransferFailed: <span class="comment">//includes REJECTED and IO ERROR</span>
            <span class="keyword">case</span> bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareError<span class="operator">::</span>HandoverFailed:
            <span class="keyword">case</span> bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareError<span class="operator">::</span>BluetoothFileTransferFailed:
                displayNotification(tr(<span class="string">&quot;Failed to share data over NFC - tap again&quot;</span>));
                <span class="keyword">break</span>;
            <span class="keyword">default</span>:
                displayNotification(tr(<span class="string">&quot;Unknown nfc share error&quot;</span>));
                <span class="keyword">break</span>;
        }
    }

    <span class="type">void</span> NfcShareHandler<span class="operator">::</span>displayNotification(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span><span class="operator">&amp;</span> notification)
    {
        <span class="comment">//TODO: clean - a bunch of these toasts can pile up and require the</span>
        <span class="comment">// user to close them all</span>

        <span class="comment">// Create a System Toast to display our notifications.</span>
        <span class="comment">// The toast will be placed in the middle center of the screen and will NOT auto dismiss</span>
        <span class="comment">// the user will have to click 'Ok' to dismiss the toast.</span>
        m_systemToast<span class="operator">-</span><span class="operator">&gt;</span>setBody(notification);
        m_systemToast<span class="operator">-</span><span class="operator">&gt;</span>setPosition(bb<span class="operator">::</span>system<span class="operator">::</span>SystemUiPosition<span class="operator">::</span>MiddleCenter);

        <span class="comment">// The modality should be set to Application, a Global Modality will prevent</span>
        <span class="comment">// the toast from disappearing when the application is thumbnailed.</span>
        m_systemToast<span class="operator">-</span><span class="operator">&gt;</span>setModality(bb<span class="operator">::</span>system<span class="operator">::</span>SystemUiModality<span class="operator">::</span>Application);

        bb<span class="operator">::</span>system<span class="operator">::</span>SystemUiButton<span class="operator">*</span> toastButton <span class="operator">=</span> m_systemToast<span class="operator">-</span><span class="operator">&gt;</span>button();
        toastButton<span class="operator">-</span><span class="operator">&gt;</span>setLabel(tr(<span class="string">&quot;Ok&quot;</span>));

        <span class="comment">// We need to enable the button or it will auto dismiss</span>
        toastButton<span class="operator">-</span><span class="operator">&gt;</span>setEnabled(<span class="keyword">true</span>);

        <span class="comment">// Display the System Toast</span>
        m_systemToast<span class="operator">-</span><span class="operator">&gt;</span>show();
    }</pre>
<p>When the share completes, either the sharingFinished() or sharingError() is invoked, depending which signal we receive. In both cases we check the types of events that are received and formulate a proper notification to be displayed using the <tt>SystemToast</tt>.</p>
<pre class="cpp">    <span class="type">void</span> NfcShareHandler<span class="operator">::</span>setShareMode(ShareMode mode)
    {
        <span class="keyword">if</span> (m_shareMode <span class="operator">=</span><span class="operator">=</span> mode)
            <span class="keyword">return</span>;

        m_shareMode <span class="operator">=</span> mode;

        <span class="comment">// Clear all previous set data</span>
        <span class="comment">//m_nfcShareManager-&gt;reset();</span>

        <span class="comment">// HACK: Needed in R9, since reset() does not work as supposed</span>
        m_nfcShareManager<span class="operator">-</span><span class="operator">&gt;</span>setShareMode(bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareMode<span class="operator">::</span>Disabled);

        <span class="keyword">switch</span> (m_shareMode) {
            <span class="keyword">case</span> DataShare:
                m_nfcShareManager<span class="operator">-</span><span class="operator">&gt;</span>setShareMode(bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareMode<span class="operator">::</span>Data);
                prepareDataShareContent();
                <span class="keyword">break</span>;
            <span class="keyword">case</span> FileShare:
                m_nfcShareManager<span class="operator">-</span><span class="operator">&gt;</span>setShareMode(bb<span class="operator">::</span>system<span class="operator">::</span>NfcShareMode<span class="operator">::</span>File);
                prepareFileShareContent();
                <span class="keyword">break</span>;
        }

        <span class="keyword">emit</span> shareModeChanged();
    }</pre>
<p>This method allows for the switching between the different types of share modes, the modes being data or file sharing. This is done in the <tt>SegmentedControl</tt>, located in SharePage.qml, by invoking this method when the onSelectedValueChanged() slot is invoked. Once the mode has been chosen, either the prepareDataShareContent() or prepareFileShareContent() is invoked.</p>
</div>
<!-- @@@nfcdemo -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Copyright 2012 Research In Motion Limited.
  <br />
    This document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
