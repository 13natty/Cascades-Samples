<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- databasecrud.qdoc -->
  <title>Cascades : Database CRUD Example</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt-based BB10 API Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
<li><a href="http://qt.nokia.com/doc/4.7/all-examples.html">Examples</a></li>
<li>Database CRUD Example</li>
    </ul>
  </div>
</div>
<div class="content mainContent">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#description">Description</a></li>
<li class="level1"><a href="#overview">Overview</a></li>
<li class="level1"><a href="#ui">UI</a></li>
<li class="level1"><a href="#app">App</a></li>
</ul>
</div>
<h1 class="title">Database CRUD Example</h1>
<span class="subtitle"></span>
<!-- $$$databasecrud-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="databasecrud-precompiled-h.html">databasecrud/precompiled.h</a></li>
<li><a href="databasecrud-assets-createpage-qml.html">databasecrud/assets/CreatePage.qml</a></li>
<li><a href="databasecrud-assets-deletepage-qml.html">databasecrud/assets/DeletePage.qml</a></li>
<li><a href="databasecrud-assets-errorpage-qml.html">databasecrud/assets/ErrorPage.qml</a></li>
<li><a href="databasecrud-assets-pagebase-qml.html">databasecrud/assets/PageBase.qml</a></li>
<li><a href="databasecrud-assets-retrievepage-qml.html">databasecrud/assets/RetrievePage.qml</a></li>
<li><a href="databasecrud-assets-updatepage-qml.html">databasecrud/assets/UpdatePage.qml</a></li>
<li><a href="databasecrud-assets-main-qml.html">databasecrud/assets/main.qml</a></li>
<li><a href="databasecrud-src-person-cpp.html">databasecrud/src/Person.cpp</a></li>
<li><a href="databasecrud-src-person-hpp.html">databasecrud/src/Person.hpp</a></li>
<li><a href="databasecrud-src-app-cpp.html">databasecrud/src/app.cpp</a></li>
<li><a href="databasecrud-src-app-hpp.html">databasecrud/src/app.hpp</a></li>
<li><a href="databasecrud-src-main-cpp.html">databasecrud/src/main.cpp</a></li>
<li><a href="databasecrud-databasecrud-pro.html">databasecrud/databasecrud.pro</a></li>
<li><a href="databasecrud-translations-databasecrud-pro.html">databasecrud/translations/databasecrud.pro</a></li>
</ul>
<a name="description"></a>
<h2>Description</h2>
<p>The Database CRUD example demonstrates how to create, read, update and delete records from a database table using the <tt>SqlDataAccess</tt> instance.</p>
<p class="centerAlign"><img src="images/databasecrud-example.png" /></p><p class="centerAlign"><img src="images/databasecrud-example1.png" /></p><p class="centerAlign"><img src="images/databasecrud-example2.png" /></p><p class="centerAlign"><img src="images/databasecrud-example3.png" /></p><a name="overview"></a>
<h2>Overview</h2>
<p>In this example we'll learn how to use the <a href="http://qt.nokia.com/doc/4.7/qsqldatabase.html">QSqlDatabase</a> and SqlDataAccess to create databases, tables, records and how to retrieve, update and even delete them.</p>
<a name="ui"></a>
<h2>UI</h2>
<p>The UI of this sample application is very simplistic, made up of four Tab's that represent each of the database table record stages, such as &quot;Retrieve&quot;, &quot;Create&quot;, &quot;Update&quot; and &quot;Delete&quot;.</p>
<p>The business logic of the application is encapsulated in the &quot;app&quot; class, which provides the various invokable methods for each one of these actions.</p>
<pre class="qml">    <span class="type">Tab</span> {
        <span class="name">title</span>: <span class="name">qsTr</span>(<span class="string">&quot;Retrieve&quot;</span>)
        <span class="name">imageSource</span>: <span class="string">&quot;asset:///images/retrieve.png&quot;</span>

        <span class="type">PageBase</span> {
            <span class="name">databaseOpen</span>: <span class="name">root</span>.<span class="name">databaseOpen</span>
            <span class="name">page</span>: <span class="string">&quot;RetrievePage.qml&quot;</span>
        }
    }

    <span class="type">Tab</span> {
        <span class="name">title</span>: <span class="name">qsTr</span>(<span class="string">&quot;Create&quot;</span>)
        <span class="name">imageSource</span>: <span class="string">&quot;asset:///images/create.png&quot;</span>

        <span class="type">PageBase</span> {
            <span class="name">databaseOpen</span>: <span class="name">root</span>.<span class="name">databaseOpen</span>
            <span class="name">page</span>: <span class="string">&quot;CreatePage.qml&quot;</span>
        }
    }

    <span class="type">Tab</span> {
        <span class="name">title</span>: <span class="name">qsTr</span>(<span class="string">&quot;Update&quot;</span>)
        <span class="name">imageSource</span>: <span class="string">&quot;asset:///images/update.png&quot;</span>

        <span class="type">PageBase</span> {
            <span class="name">databaseOpen</span>: <span class="name">root</span>.<span class="name">databaseOpen</span>
            <span class="name">page</span>: <span class="string">&quot;UpdatePage.qml&quot;</span>
        }
    }

    <span class="type">Tab</span> {
        <span class="name">title</span>: <span class="name">qsTr</span>(<span class="string">&quot;Delete&quot;</span>)
        <span class="name">imageSource</span>: <span class="string">&quot;asset:///images/delete.png&quot;</span>

        <span class="type">PageBase</span> {
            <span class="name">databaseOpen</span>: <span class="name">root</span>.<span class="name">databaseOpen</span>
            <span class="name">page</span>: <span class="string">&quot;DeletePage.qml&quot;</span>
        }
    }</pre>
<p>Each of these Tab's provides an interface to invoke one of the methods that was exposed through the <a href="#app">_app</a> instance that was introduced into the qml context using setContextProperty(). Each Tab references the custom component PageBase, which uses a <tt>ControlDelegate</tt> to provide a delegate to the control which is dynamically loaded.</p>
<pre class="qml">    <span class="type">Page</span> {
        <span class="name">id</span>: <span class="name">root</span>

        property <span class="type">bool</span> <span class="name">databaseOpen</span>: <span class="number">false</span>
        property <span class="type">string</span> <span class="name">page</span>

        <span class="name">titleBar</span>: <span class="name">TitleBar</span> {
            <span class="name">title</span>: <span class="name">qsTr</span>(<span class="string">&quot;Database CRUD Sample&quot;</span>)
        }

        <span class="type">ControlDelegate</span> {
            <span class="name">source</span>: <span class="name">databaseOpen</span> ? <span class="name">root</span>.<span class="name">page</span> : <span class="string">&quot;ErrorPage.qml&quot;</span>
            <span class="name">delegateActive</span>: <span class="number">true</span>
        }
    }</pre>
<p>The page is constructed using the Qml source that is supplied to the <tt>ControlDelegate</tt>. The control is created from the Qml asset file that is provided via the page property, and is only created if the database connection is open, otherwise an error container is displayed with the error message. Each of the Tab's page is created using this base component.</p>
<pre class="qml">    <span class="type">Container</span> {
        <span class="name">layout</span>: <span class="name">DockLayout</span> {
        }

        <span class="type">Container</span> {
            <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>
            <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Center</span>

            <span class="name">leftPadding</span>: <span class="number">30</span>
            <span class="name">rightPadding</span>: <span class="number">30</span>

            <span class="type">TextField</span> {
                <span class="name">id</span>: <span class="name">firstNameCreateTextField</span>
                <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>

                <span class="name">hintText</span>: <span class="name">qsTr</span>(<span class="string">&quot;First Name&quot;</span>)
            }

            <span class="type">TextField</span> {
                <span class="name">id</span>: <span class="name">lastNameCreateTextField</span>
                <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>

                <span class="name">hintText</span>: <span class="name">qsTr</span>(<span class="string">&quot;Last Name&quot;</span>)
            }

            <span class="type">Button</span> {
                <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>

                <span class="name">text</span>: <span class="name">qsTr</span>(<span class="string">&quot;Create&quot;</span>)

                <span class="name">onClicked</span>: {
                    <span class="name">_app</span>.<span class="name">createRecord</span>(<span class="name">firstNameCreateTextField</span>.<span class="name">text</span>, <span class="name">lastNameCreateTextField</span>.<span class="name">text</span>);
                }
            }
        }
    }</pre>
<p>The create container that provides Name TextField's and a &quot;Create&quot; Button for creating a person record.</p>
<pre class="qml">    <span class="type">Container</span> {
        <span class="name">layout</span>: <span class="name">DockLayout</span> {
        }

        <span class="type">Container</span> {
            <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>
            <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Center</span>

            <span class="name">leftPadding</span>: <span class="number">30</span>
            <span class="name">rightPadding</span>: <span class="number">30</span>

            <span class="type">TextField</span> {
                <span class="name">id</span>: <span class="name">idDeletionTextField</span>
                <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>

                <span class="name">hintText</span>: <span class="name">qsTr</span>(<span class="string">&quot;Key of record to delete&quot;</span>)
            }

            <span class="type">Button</span> {
                <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>

                <span class="name">text</span>: <span class="name">qsTr</span>(<span class="string">&quot;Delete&quot;</span>)

                <span class="name">onClicked</span>: {
                    <span class="name">_app</span>.<span class="name">deleteRecord</span>(<span class="name">idDeletionTextField</span>.<span class="name">text</span>);
                }
            }
        }
    }</pre>
<p>The delete container that provides record key TextField and a &quot;Delete&quot; Button for deleting a person record.</p>
<pre class="qml">    <span class="type">Container</span> {
        <span class="name">bottomPadding</span>: <span class="number">30</span>

        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qml-listview.html">ListView</a></span> {
            <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Fill</span>

            <span class="name">dataModel</span>: <span class="name">_app</span>.<span class="name">dataModel</span>

            <span class="name">listItemComponents</span>: [
                <span class="type">ListItemComponent</span> {
                    <span class="name">type</span>: <span class="string">&quot;item&quot;</span>
                    <span class="type">StandardListItem</span> {
                        <span class="name">imageSource</span>: <span class="string">&quot;asset:///images/icon1.png&quot;</span>
                        <span class="name">title</span>: <span class="name">qsTr</span>(<span class="string">&quot;%1 %2&quot;</span>).<span class="name">arg</span>(<span class="name">ListItemData</span>.<span class="name">firstName</span>).<span class="name">arg</span>(<span class="name">ListItemData</span>.<span class="name">lastName</span>)
                        <span class="name">description</span>: <span class="name">qsTr</span>(<span class="string">&quot;Unique Key: %1&quot;</span>).<span class="name">arg</span>(<span class="name">ListItemData</span>.<span class="name">customerID</span>)
                    }
                }
            ]
        }

        <span class="type">Button</span> {
            <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>

            <span class="name">text</span>: <span class="name">qsTr</span>(<span class="string">&quot;Retrieve&quot;</span>)
            <span class="name">onClicked</span>: {
                <span class="name">_app</span>.<span class="name">readRecords</span>(); <span class="comment">// Refresh the list view.</span>
            }
        }
    }</pre>
<p>The retrieve container that provides a <a href="http://qt.nokia.com/doc/4.7/qml-listview.html">ListView</a> using StandardListItem to display person records and a &quot;Retrieve&quot; Button for retrieving the database table records for display.</p>
<pre class="qml">    <span class="type">Container</span> {
        <span class="name">layout</span>: <span class="name">DockLayout</span> {
        }

        <span class="type">Container</span> {
            <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>
            <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Center</span>

            <span class="name">leftPadding</span>: <span class="number">30</span>
            <span class="name">rightPadding</span>: <span class="number">30</span>

            <span class="type">TextField</span> {
                <span class="name">id</span>: <span class="name">firstNameUpdateTextField</span>
                <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>

                <span class="name">hintText</span>: <span class="name">qsTr</span>(<span class="string">&quot;New first name&quot;</span>)
            }

            <span class="type">TextField</span> {
                <span class="name">id</span>: <span class="name">lastNameUpdateTextField</span>
                <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>

                <span class="name">hintText</span>: <span class="name">qsTr</span>(<span class="string">&quot;New last name&quot;</span>)
            }

            <span class="type">TextField</span> {
                <span class="name">id</span>: <span class="name">idUpdateTextField</span>
                <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>

                <span class="name">hintText</span>: <span class="name">qsTr</span>(<span class="string">&quot;Key of record to update&quot;</span>)
            }

            <span class="type">Button</span> {
                <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>

                <span class="name">text</span>: <span class="name">qsTr</span>(<span class="string">&quot;Update&quot;</span>)

                <span class="name">onClicked</span>: {
                    <span class="name">_app</span>.<span class="name">updateRecord</span>(<span class="name">idUpdateTextField</span>.<span class="name">text</span>, <span class="name">firstNameUpdateTextField</span>.<span class="name">text</span>, <span class="name">lastNameUpdateTextField</span>.<span class="name">text</span>);
                }
            }
        }
    }</pre>
<p>The update container that provides Name, record key TextField's and a &quot;Update&quot; Button for updating the person record fields.</p>
<pre class="qml">    <span class="type">Container</span> {
        <span class="name">layout</span>: <span class="name">DockLayout</span> {
        }

        <span class="name">background</span>: <span class="name">Color</span>.<span class="name">Red</span>

        <span class="type">Label</span> {
            <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>
            <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Center</span>

            <span class="name">text</span>: <span class="name">qsTr</span>(<span class="string">&quot;ERROR: Database Initialization Failed&quot;</span>)
        }
    }</pre>
<p>The error container that provides a Label for displaying an error when database initialization fails.</p>
<a name="app"></a>
<h2>App</h2>
<p>This app class contains the business logic dealing with the database instance.</p>
<pre class="cpp">    App<span class="operator">::</span>App()
        : m_dataModel(<span class="number">0</span>)
    {
        <span class="comment">// Initialize the Group Data Model before setitng up our QML Scene</span>
        <span class="comment">// as the QML scene will bind to the data model</span>
        initDataModel();

        <span class="comment">// Create a QMLDocument from the definition in main.qml</span>
        QmlDocument <span class="operator">*</span>qml <span class="operator">=</span> QmlDocument<span class="operator">::</span>create(<span class="string">&quot;asset:///main.qml&quot;</span>)<span class="operator">.</span>parent(<span class="keyword">this</span>);

        <span class="comment">//-- setContextProperty expose C++ object in QML as an variable</span>
        <span class="comment">// this must come before the next line so the root is instantiated after app is defined.</span>
        qml<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(<span class="string">&quot;_app&quot;</span><span class="operator">,</span> <span class="keyword">this</span>);

        <span class="comment">// Creates the root node object as defined in main.qml</span>
        AbstractPane <span class="operator">*</span>root <span class="operator">=</span> qml<span class="operator">-</span><span class="operator">&gt;</span>createRootObject<span class="operator">&lt;</span>AbstractPane<span class="operator">&gt;</span>();

        <span class="comment">// Give the application the root node to display.</span>
        Application<span class="operator">::</span>instance()<span class="operator">-</span><span class="operator">&gt;</span>setScene(root);

        <span class="comment">// Initialize the database, ensure a connection can be established</span>
        <span class="comment">// and that all the required tables and initial data exists</span>
        <span class="keyword">const</span> <span class="type">bool</span> dbInited <span class="operator">=</span> initDatabase();

        <span class="comment">// Inform the UI if the database was successfully initialized or not</span>
        root<span class="operator">-</span><span class="operator">&gt;</span>setProperty(<span class="string">&quot;databaseOpen&quot;</span><span class="operator">,</span> dbInited);
    }</pre>
<p>The constructor intitializes the instance variables, and creates the qml document as well as setting the application scene to the created <tt>AbstractPane</tt> which stems from the document. Performs the GroupDataModel and <a href="http://qt.nokia.com/doc/4.7/qsqldatabase.html">QSqlDatabase</a> initializations.</p>
<pre class="cpp">    <span class="type">bool</span> App<span class="operator">::</span>initDatabase()
    {
        <span class="comment">// Initialize the database and create any tables needed for the app to function</span>
        <span class="comment">// properly if they do not already exist.</span>
        <span class="comment">// IMPORTANT NOTE: This function 'drops' the 'customers' table and recreates it</span>
        <span class="comment">// each time the application starts. This is done to ensure the application starts</span>
        <span class="comment">// with the same table each time for experimental purposes. This is not typical in</span>
        <span class="comment">// most applications however.</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qsqldatabase.html">QSqlDatabase</a></span> database <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qsqldatabase.html">QSqlDatabase</a></span><span class="operator">::</span>addDatabase(<span class="string">&quot;QSQLITE&quot;</span>);
        database<span class="operator">.</span>setDatabaseName(DB_PATH);

        <span class="comment">// If we cannot open a connection to the database, then fail initialization</span>
        <span class="comment">// and display an error message</span>
        <span class="keyword">if</span> (database<span class="operator">.</span>open() <span class="operator">=</span><span class="operator">=</span> <span class="keyword">false</span>) {
            <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qsqlerror.html">QSqlError</a></span> error <span class="operator">=</span> database<span class="operator">.</span>lastError();
            alert(tr(<span class="string">&quot;Error opening connection to the database: %1&quot;</span>)<span class="operator">.</span>arg(error<span class="operator">.</span>text()));
            <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;\nDatabase NOT opened.&quot;</span>;
            <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// return as if we cannot open a connection to the db, then below calls</span>
                          <span class="comment">// will also fail</span>
        }

        <span class="comment">// Drop the 'customers' table if it exists so that the application</span>
        <span class="comment">// always start with an empty table.</span>
        <span class="comment">// Note: A typical application would NOT do this.</span>
        <span class="comment">// open the default database.</span>

        SqlDataAccess <span class="operator">*</span>sqlda <span class="operator">=</span> <span class="keyword">new</span> SqlDataAccess(DB_PATH);
        sqlda<span class="operator">-</span><span class="operator">&gt;</span>execute(<span class="string">&quot;DROP TABLE IF EXISTS customers&quot;</span>);
        <span class="keyword">if</span>(<span class="operator">!</span>sqlda<span class="operator">-</span><span class="operator">&gt;</span>hasError()) {
            <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;Table dropped.&quot;</span>;
        } <span class="keyword">else</span> {
            <span class="keyword">const</span> DataAccessError error <span class="operator">=</span> sqlda<span class="operator">-</span><span class="operator">&gt;</span>error();
            alert(tr(<span class="string">&quot;Drop table error: %1&quot;</span>)<span class="operator">.</span>arg(error<span class="operator">.</span>errorMessage()));<span class="comment">//.arg(error.text()));</span>
        }

        <span class="comment">// Create the 'customers' table that was just dropped (if it existed)</span>
        <span class="comment">// with no data</span>
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> createSQL <span class="operator">=</span> <span class="string">&quot;CREATE TABLE customers &quot;</span>
                                  <span class="string">&quot;  (customerID INTEGER PRIMARY KEY AUTOINCREMENT, &quot;</span>
                                  <span class="string">&quot;  firstName VARCHAR, &quot;</span>
                                  <span class="string">&quot;  lastName VARCHAR);&quot;</span>;
        sqlda<span class="operator">-</span><span class="operator">&gt;</span>execute(createSQL);
        <span class="keyword">if</span>(<span class="operator">!</span>sqlda<span class="operator">-</span><span class="operator">&gt;</span>hasError()) {
            <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;Table created.&quot;</span>;
        } <span class="keyword">else</span> {
            <span class="keyword">const</span> DataAccessError error <span class="operator">=</span> sqlda<span class="operator">-</span><span class="operator">&gt;</span>error();
            alert(tr(<span class="string">&quot;Create table error: %1&quot;</span>)<span class="operator">.</span>arg(error<span class="operator">.</span>errorMessage()));<span class="comment">//.arg(error.text()));</span>
            <span class="keyword">return</span> <span class="keyword">false</span>;
        }

        <span class="keyword">return</span> <span class="keyword">true</span>;
    }</pre>
<p>This method, when invoked, creates the database using <tt>QSqlDatabase</tt>. Every time you need to refer to the created database you can invoke <a href="http://qt.nokia.com/doc/4.7/qsqldatabase.html#database">QSqlDatabase::database</a>() to get the connection instance. However, you can specify a name to the database() method to refer to another database connection if a name was given at creation time. It also creates an initial &quot;customer&quot; table in which the records are added, updated or removed from.</p>
<pre class="cpp">    <span class="comment">// -----------------------------------------------------------------------------------------------</span>
    <span class="comment">// Synchronous Database Functionality with QSqlDatabase and QSqlQuery</span>
    <span class="type">void</span> App<span class="operator">::</span>createTable()
    {
        <span class="comment">// 1. Get a reference to the database, which will automatically open the connection</span>
        <span class="comment">//    if it is not already open.</span>
        <span class="comment">//    NOTE: The below code assumes that the database being accessed is the 'default</span>
        <span class="comment">//    connection' database. If a database connection was created with a registered</span>
        <span class="comment">//    connection name then you would access the database via:</span>
        <span class="comment">//    QSqlDatabase db = QSqlDatabase::database(&lt;connectionName&gt;);</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qsqldatabase.html">QSqlDatabase</a></span> database <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qsqldatabase.html">QSqlDatabase</a></span><span class="operator">::</span>database();

        <span class="comment">// 2. Create a query to execute.</span>
        <span class="comment">//    The below query creates a table with customerID, firstName, and lastName columns</span>
        <span class="comment">//    if it does not already exist.</span>
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> createSQL <span class="operator">=</span> <span class="string">&quot;CREATE TABLE IF NOT EXISTS customers ( &quot;</span>
                                  <span class="string">&quot;                customerID INTEGER PRIMARY KEY AUTOINCREMENT, &quot;</span>
                                  <span class="string">&quot;                firstName VARCHAR, &quot;</span>
                                  <span class="string">&quot;                lastName VARCHAR&quot;</span>
                                  <span class="string">&quot;);&quot;</span>;

        <span class="comment">// 3. Create an QSqlQuery object with which you can execute queries</span>
        <span class="comment">//    NOTE: The QSqlDatabase function has an 'exec' function, however this</span>
        <span class="comment">//    is deprecated and should be avoided.</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qsqlquery.html">QSqlQuery</a></span> query(database);
        <span class="keyword">if</span> (query<span class="operator">.</span>exec(createSQL)) {
            alert(tr(<span class="string">&quot;Table creation query execute successfully&quot;</span>));
        } <span class="keyword">else</span> {
            <span class="comment">// If 'exec' fails, error information can be accessed via the lastError function</span>
            <span class="comment">// the last error is reset every time exec is called.</span>
            <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qsqlerror.html">QSqlError</a></span> error <span class="operator">=</span> query<span class="operator">.</span>lastError();
            alert(tr(<span class="string">&quot;Create table error: %1&quot;</span>)<span class="operator">.</span>arg(error<span class="operator">.</span>text()));
        }

        <span class="comment">// 4. Optionally close the database connection if we no longer plan to use it</span>
        <span class="comment">//    Note that calling QSqlDatabase::database() will automatically re-open</span>
        <span class="comment">//    the connection for us.</span>
        <span class="comment">//    NOTE: Closing the database invalidates any QSqlQuery objects you have created</span>
        <span class="comment">//    with this database connection.</span>
        database<span class="operator">.</span>close();
    }

    <span class="type">void</span> App<span class="operator">::</span>dropTable()
    {
        <span class="comment">// 1. Get a reference to the database, which will automatically open the connection</span>
        <span class="comment">//    if it is not already open.</span>
        <span class="comment">//    NOTE: The below code assumes that the database being accessed is the 'default</span>
        <span class="comment">//    connection' database. If a database connection was created with a registered</span>
        <span class="comment">//    connection name then you would access the database via:</span>
        <span class="comment">//    QSqlDatabase db = QSqlDatabase::database(&lt;connectionName&gt;);</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qsqldatabase.html">QSqlDatabase</a></span> database <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qsqldatabase.html">QSqlDatabase</a></span><span class="operator">::</span>database();

        <span class="comment">// 2. When dropping a table, you should first verify if it exists or not.</span>
        <span class="comment">//    Alternatively, you can embed into your SQL statement a check to see</span>
        <span class="comment">//    if the table exists.</span>
        <span class="comment">//    The below example embeds the check into the SQL statement.</span>

        <span class="comment">// NOTE: If you wish to check if the table exists in code, you can use the</span>
        <span class="comment">//    below example:</span>
        <span class="comment">//        if(database.tables().contains(&quot;customers&quot;)) {</span>
        <span class="comment">//            alert(tr(&quot;The 'customers' table exists&quot;));</span>
        <span class="comment">//      }</span>

        <span class="comment">// 3. Create an QSqlQuery object with which you can execute queries</span>
        <span class="comment">//    NOTE: The QSqlDatabase function has an 'exec' function, however this</span>
        <span class="comment">//    is deprecated and should be avoided.</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qsqlquery.html">QSqlQuery</a></span> query(database);

        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> dropSQL <span class="operator">=</span> <span class="string">&quot;DROP TABLE IF EXISTS customers&quot;</span>;
        <span class="keyword">if</span> (query<span class="operator">.</span>exec(dropSQL)) {
            alert(tr(<span class="string">&quot;Table drop query executed successfully.&quot;</span>));
        } <span class="keyword">else</span> {
            <span class="comment">// If 'exec' fails, error information can be accessed via the lastError function</span>
            <span class="comment">// the last error is reset every time exec is called.</span>
            <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qsqlerror.html">QSqlError</a></span> error <span class="operator">=</span> query<span class="operator">.</span>lastError();
            alert(tr(<span class="string">&quot;Drop table error: %1&quot;</span>)<span class="operator">.</span>arg(error<span class="operator">.</span>text()));
        }

        <span class="comment">// 4. Optionally close the database connection if we no longer plan to use it</span>
        <span class="comment">//    Note that calling QSqlDatabase::database() will automatically re-open</span>
        <span class="comment">//    the connection for us.</span>
        <span class="comment">//    NOTE: Closing the database invalidates any QSqlQuery objects you have created</span>
        <span class="comment">//    with this database connection.</span>
        database<span class="operator">.</span>close();
    }

    <span class="type">void</span> App<span class="operator">::</span>createRecord(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> <span class="operator">&amp;</span>firstName<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> <span class="operator">&amp;</span>lastName)
    {
        <span class="comment">// 1. Get a reference to the database, which will automatically open the connection</span>
        <span class="comment">//    if it is not already open.</span>
        <span class="comment">//    NOTE: The below code assumes that the database being accessed is the 'default</span>
        <span class="comment">//    connection' database. If a database connection was created with a registered</span>
        <span class="comment">//    connection name then you would access the database via:</span>
        <span class="comment">//    QSqlDatabase db = QSqlDatabase::database(&lt;connectionName&gt;);</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qsqldatabase.html">QSqlDatabase</a></span> database <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qsqldatabase.html">QSqlDatabase</a></span><span class="operator">::</span>database();

        <span class="comment">// 2. Verify the table exists first, always a good safety pre-caution.</span>
        <span class="comment">//    For performance, on application startup, you would verify that all tables exist</span>
        <span class="comment">//    and can create or update any that do not. This would allow you to</span>
        <span class="comment">//    skip this check to see if a table exists or not in the database.</span>
        <span class="keyword">if</span> (<span class="operator">!</span>database<span class="operator">.</span>tables()<span class="operator">.</span>contains(<span class="string">&quot;customers&quot;</span>)) {
            alert(tr(<span class="string">&quot;Create record error: customers table does not exist.&quot;</span>));
        } <span class="keyword">else</span> {
            <span class="comment">// 3. Create an QSqlQuery object with which you can execute queries</span>
            <span class="comment">//    In this example we bind parameters in the query. A large advantage to using</span>
            <span class="comment">//    bindings (aside from performance enhancements) is that input is automatically</span>
            <span class="comment">//    escaped avoiding potential issues with odd characters (quotes) and prevents</span>
            <span class="comment">//    SQL Injection attacks.</span>
            <span class="comment">//    Note that for databases that do not support bindings, Qt simulates the binding</span>
            <span class="comment">//    effects.</span>
            <span class="comment">//    IMPORTANT NOTE: If ever accepting user information without using bindings,</span>
            <span class="comment">//    be sure to 'escape' your queries.</span>
            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qsqlquery.html">QSqlQuery</a></span> query(database);
            query<span class="operator">.</span>prepare(<span class="string">&quot;INSERT INTO customers (firstName, lastName) VALUES(:firstName, :lastName)&quot;</span>);
            query<span class="operator">.</span>bindValue(<span class="string">&quot;:firstName&quot;</span><span class="operator">,</span> firstName);
            query<span class="operator">.</span>bindValue(<span class="string">&quot;:lastName&quot;</span><span class="operator">,</span> lastName);
            query<span class="operator">.</span>exec();

            <span class="comment">// Note that no SQL Statement is passed to 'exec' as it is a prepared statement.</span>
            <span class="keyword">if</span> (query<span class="operator">.</span>exec()) {
                alert(tr(<span class="string">&quot;Record created&quot;</span>));
            } <span class="keyword">else</span> {
                <span class="comment">// If 'exec' fails, error information can be accessed via the lastError function</span>
                <span class="comment">// the last error is reset every time exec is called.</span>
                <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qsqlerror.html">QSqlError</a></span> error <span class="operator">=</span> query<span class="operator">.</span>lastError();
                alert(tr(<span class="string">&quot;Create record error: %1&quot;</span>)<span class="operator">.</span>arg(error<span class="operator">.</span>text()));
            }
        }

        <span class="comment">// 4. Optionally close the database connection if we no longer plan to use it</span>
        <span class="comment">//    Note that calling QSqlDatabase::database() will automatically re-open</span>
        <span class="comment">//    the connection for us.</span>
        <span class="comment">//    NOTE: Closing the database invalidates any QSqlQuery objects you have created</span>
        <span class="comment">//    with this database connection.</span>
        database<span class="operator">.</span>close();
    }</pre>
<p>These methods manipulate the database connection using appropriate sql queries to create, update and delete the records from the table. The queries use parameter binding, one advantage of binding is that the input is automatically escaped, avoiding potential issues with special characters. If the database does not support binding, Qt simulates the binding effects.</p>
<pre class="cpp">    <span class="comment">// Read all records from the database.</span>
    <span class="comment">// Clear the data model and refill it.</span>
    <span class="type">void</span> App<span class="operator">::</span>readRecords()
    {
        <span class="comment">// 1. Create the local DB connection via SqlDataAccess instance. Note, creating instance</span>
        <span class="comment">//    Will automatically open a connection to the database.</span>
        SqlDataAccess <span class="operator">*</span>sqlda <span class="operator">=</span> <span class="keyword">new</span> SqlDataAccess(DB_PATH);

        <span class="comment">// 2. Create a query to search for the records</span>
        <span class="comment">//    IMPORTANT NOTE: If accepting user input and not using bindings, be sure</span>
        <span class="comment">//    to escape it to allow quote characters, and prevent SQL Injection attacks.</span>
        <span class="comment">//    The below example is not a prepared statement and does not use bindings as</span>
        <span class="comment">//    there is no user input to accept.</span>

        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> sqlQuery <span class="operator">=</span> <span class="string">&quot;SELECT customerID, firstName, lastName FROM customers&quot;</span>;

        <span class="comment">// 3. Call 'execute' on the SqlDataAccess. Note, that when using a SELECT action,</span>
        <span class="comment">//    the retrieved records are stored in the QVariantList as QVariantMap objects.</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html">QVariant</a></span> result <span class="operator">=</span> sqlda<span class="operator">-</span><span class="operator">&gt;</span>execute(sqlQuery);
        <span class="keyword">if</span> (<span class="operator">!</span>sqlda<span class="operator">-</span><span class="operator">&gt;</span>hasError()) {
            <span class="type">int</span> recordsRead <span class="operator">=</span> <span class="number">0</span>;
            <span class="comment">// The data will be displayed in a group data model</span>
            <span class="comment">// Clear any previous reads from the data model first</span>
            m_dataModel<span class="operator">-</span><span class="operator">&gt;</span>clear();
            <span class="keyword">if</span>( <span class="operator">!</span>result<span class="operator">.</span>isNull() ) {
                <span class="comment">// If the query is successful and results are not null</span>
                <span class="comment">// you can access the records through the QVariantList</span>
                <span class="comment">// by accessing the QVariantMap object at each index for the records values.</span>
                <span class="comment">// ImportantNote: The alternative is to add to the model directly exposing the records values for reference via qml.</span>
                <span class="comment">//                You essentially get the same result as with the Person object but with less hassle.</span>
                <span class="comment">// m_dataModel-&gt;insertList(result.value&lt;QVariantList&gt;());</span>
                <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a></span> list <span class="operator">=</span> result<span class="operator">.</span>value<span class="operator">&lt;</span><span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a></span><span class="operator">&gt;</span>();
                recordsRead <span class="operator">=</span> list<span class="operator">.</span>size();
                <span class="keyword">for</span>(<span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> recordsRead; i<span class="operator">+</span><span class="operator">+</span>) {
                    <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantMap-typedef">QVariantMap</a></span> map <span class="operator">=</span> list<span class="operator">.</span>at(i)<span class="operator">.</span>value<span class="operator">&lt;</span><span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantMap-typedef">QVariantMap</a></span><span class="operator">&gt;</span>();
                    Person <span class="operator">*</span>person <span class="operator">=</span> <span class="keyword">new</span> Person(map<span class="operator">[</span><span class="string">&quot;customerID&quot;</span><span class="operator">]</span><span class="operator">.</span>toString()<span class="operator">,</span>
                                     map<span class="operator">[</span><span class="string">&quot;firstName&quot;</span><span class="operator">]</span><span class="operator">.</span>toString()<span class="operator">,</span>
                                     map<span class="operator">[</span><span class="string">&quot;lastName&quot;</span><span class="operator">]</span><span class="operator">.</span>toString());
                    Q_UNUSED(person);
                    <span class="comment">//NOTE: When adding an object to a DataModel, the DataModel sets</span>
                    <span class="comment">//    itself as the parent of the object if no parent has already been</span>
                    <span class="comment">//    set. Therefore, when clearing or removing an item from the data model</span>
                    <span class="comment">//    the data model will destroy the object if it is the parent of the object.</span>
                    m_dataModel<span class="operator">-</span><span class="operator">&gt;</span>insert(person);
                }
            }

            <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qDebug">qDebug</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;Read &quot;</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> recordsRead <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot; records succeeded&quot;</span>;

            <span class="keyword">if</span> (recordsRead <span class="operator">=</span><span class="operator">=</span> <span class="number">0</span>) {
                alert(tr(<span class="string">&quot;The customer table is empty.&quot;</span>));
            }
        } <span class="keyword">else</span> {
            alert(tr(<span class="string">&quot;Read records failed: %1&quot;</span>)<span class="operator">.</span>arg(sqlda<span class="operator">-</span><span class="operator">&gt;</span>error()<span class="operator">.</span>errorMessage()));
        }
    }</pre>
<p>This method queries the database for all the table records and creates a Person object instance for each record, which is than inserted into the data model for display. The value for each field is retrieved using the record field indexOf(), which is than supplied to the query result to extract the value for a particular field, i.e&#x2e; name.</p>
</div>
<!-- @@@databasecrud -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Copyright 2012 Research In Motion Limited.
  <br />
    This document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
