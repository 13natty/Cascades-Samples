<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- soapxml.qdoc -->
  <title>Cascades : SOAP XML</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt-based BB10 API Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
<li><a href="http://qt.nokia.com/doc/4.7/all-examples.html">Examples</a></li>
<li>SOAP XML</li>
    </ul>
  </div>
</div>
<div class="content mainContent">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#description">Description</a></li>
<li class="level1"><a href="#overview">Overview</a></li>
<li class="level1"><a href="#the-ui">The UI</a></li>
<li class="level1"><a href="#weatherservice">WeatherService</a></li>
</ul>
</div>
<h1 class="title">SOAP XML</h1>
<span class="subtitle"></span>
<!-- $$$soapxml-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="soapxml-assets-main-qml.html">soapxml/assets/main.qml</a></li>
<li><a href="soapxml-assets-controls-networkactivity-qml.html">soapxml/assets/controls/NetworkActivity.qml</a></li>
<li><a href="soapxml-src-weatherservice-cpp.html">soapxml/src/WeatherService.cpp</a></li>
<li><a href="soapxml-src-weatherservice-hpp.html">soapxml/src/WeatherService.hpp</a></li>
<li><a href="soapxml-src-qtsoap-qtsoap-cpp.html">soapxml/src/qtsoap/qtsoap.cpp</a></li>
<li><a href="soapxml-src-qtsoap-qtsoap-h.html">soapxml/src/qtsoap/qtsoap.h</a></li>
<li><a href="soapxml-src-main-cpp.html">soapxml/src/main.cpp</a></li>
<li><a href="soapxml-soapxml-pro.html">soapxml/soapxml.pro</a></li>
</ul>
<a name="description"></a>
<h2>Description</h2>
<p>The SOAP XML example demonstrates how to retrieve weather information from a SOAP-based webservice.</p>
<div class="centerAlign"><p><img src="images/soapxml-example.png" /> <img src="images/soapxml-example1.png" /></p>
</div><a name="overview"></a>
<h2>Overview</h2>
<p>In this example we'll learn how to use the <a href="qtsoaphttptransport.html">QtSoapHttpTransport</a> class for transporting SOAP messages to and from other hosts using the HTTP protocol, and how to parse and extract information from the response message.</p>
<a name="the-ui"></a>
<h2>The UI</h2>
<p>The sample application provides an UI where the user can select a city from a dropdown menu, and retrieve/display the weather information for that location using the &quot;Get Weather&quot; button which will send and parse the soap messages from the host.</p>
<p>All the business logic is encapsulated in the C++ class WeatherService which has been exposed to qml as a WeatherService type.</p>
<pre class="qml">    <span class="type">DropDown</span> {
        <span class="name">id</span>: <span class="name">cityDropDown</span>

        <span class="name">enabled</span>: !<span class="name">weatherService</span>.<span class="name">active</span>

        <span class="name">title</span>: <span class="name">qsTr</span>(<span class="string">&quot;City&quot;</span>)

        <span class="type">Option</span> {
            <span class="name">text</span>: <span class="name">qsTr</span>(<span class="string">&quot;Beverly Hills&quot;</span>)
            <span class="name">description</span>: <span class="name">qsTr</span>(<span class="string">&quot;Beverly Hills, California&quot;</span>)
            <span class="name">value</span>: <span class="string">&quot;90210&quot;</span>
            <span class="name">selected</span>: <span class="number">true</span>
        }

        <span class="type">Option</span> {
            <span class="name">text</span>: <span class="name">qsTr</span>(<span class="string">&quot;Detroit&quot;</span>)
            <span class="name">description</span>: <span class="name">qsTr</span>(<span class="string">&quot;Detroit, Michigan&quot;</span>)
            <span class="name">value</span>: <span class="string">&quot;48201&quot;</span>
        }

        <span class="type">Option</span> {
            <span class="name">text</span>: <span class="name">qsTr</span>(<span class="string">&quot;Pittsburgh&quot;</span>)
            <span class="name">description</span>: <span class="name">qsTr</span>(<span class="string">&quot;City of Pittsburgh (South Side), Pennsylvania&quot;</span>)
            <span class="name">value</span>: <span class="string">&quot;15203&quot;</span>
        }

        <span class="type">Option</span> {
            <span class="name">text</span>: <span class="name">qsTr</span>(<span class="string">&quot;Miami&quot;</span>)
            <span class="name">description</span>: <span class="name">qsTr</span>(<span class="string">&quot;Miami, Florida&quot;</span>)
            <span class="name">value</span>: <span class="string">&quot;33126&quot;</span>
        }

        <span class="type">Option</span> {
            <span class="name">text</span>: <span class="name">qsTr</span>(<span class="string">&quot;Mordor&quot;</span>)
            <span class="name">description</span>: <span class="name">qsTr</span>(<span class="string">&quot;One does not simply walk into Mordor&quot;</span>)
            <span class="name">value</span>: <span class="string">&quot;331261&quot;</span>
        }

        <span class="name">onSelectedIndexChanged</span>: {
            <span class="name">weatherService</span>.<span class="name">reset</span>()
        }
    }</pre>
<p>The DropDown menu where the user can select one of the available citys for which weather data can be retrieved, which is only active as long as the WeatherService is active.</p>
<pre class="qml">    <span class="type">Button</span> {
        <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>

        <span class="name">text</span>: <span class="name">qsTr</span>(<span class="string">&quot;Get Weather&quot;</span>)
        <span class="name">enabled</span>: !<span class="name">weatherService</span>.<span class="name">active</span>

        <span class="name">onClicked</span>: {
            <span class="name">weatherService</span>.<span class="name">requestWeatherInformation</span>(<span class="name">cityDropDown</span>.<span class="name">selectedValue</span>);
        }
    }</pre>
<p>The 'Get Weather' button will invoke the requestWeatherInformation(zipcode) slot of the WeatherService object when the user clicks it. Like the DropDown, the button will be disabled while the information is retrieved, parsed and displayed.</p>
<pre class="qml">    <span class="type">NetworkActivity</span> {
        <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>

        <span class="name">active</span>: <span class="name">weatherService</span>.<span class="name">active</span>
    }
    <span class="type">Container</span> {

        property <span class="type">alias</span> <span class="name">active</span>: <span class="name">activityIndicator</span>.<span class="name">running</span>

        <span class="name">visible</span>: <span class="name">activityIndicator</span>.<span class="name">running</span>

        <span class="name">layout</span> : <span class="name">DockLayout</span> {}

        <span class="type">ActivityIndicator</span> {
            <span class="name">id</span> : <span class="name">activityIndicator</span>

            <span class="name">horizontalAlignment</span> : <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>
            <span class="name">verticalAlignment</span> : <span class="name">VerticalAlignment</span>.<span class="name">Center</span>

            <span class="name">preferredHeight</span> : <span class="number">500</span>
            <span class="name">preferredWidth</span> : <span class="number">500</span>
        }
    }</pre>
<p>This indicator displays the progress, only active during the process, of sending a soap message, and parsing the reply which deactivates during the display of the message response.</p>
<pre class="qml">    <span class="type">Container</span> {
        <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>
        <span class="name">topMargin</span>: <span class="number">100</span>
        <span class="name">topPadding</span>: <span class="number">20</span>
        <span class="name">leftPadding</span>: <span class="number">20</span>
        <span class="name">rightPadding</span>: <span class="number">20</span>

        <span class="name">background</span>: <span class="name">Color</span>.<span class="name">create</span>(<span class="string">&quot;#aaffffff&quot;</span>)

        <span class="name">visible</span>: !<span class="name">weatherService</span>.<span class="name">active</span> <span class="operator">&amp;&amp;</span> <span class="name">weatherService</span>.<span class="name">succeeded</span>

        <span class="type">Label</span> {
            <span class="name">text</span>: <span class="name">weatherService</span>.<span class="name">description</span>
            <span class="type">textStyle</span> {
                <span class="name">base</span>: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">BodyText</span>
                <span class="name">textAlign</span>: <span class="name">TextAlign</span>.<span class="name">Center</span>
            }
        }

        <span class="type">Label</span> {
            <span class="name">topMargin</span>: <span class="number">30</span>

            <span class="name">text</span>: <span class="name">weatherService</span>.<span class="name">temperature</span>
            <span class="type">textStyle</span> {
                <span class="name">fontSizeValue</span>: <span class="number">26</span>
                <span class="name">color</span>: <span class="name">Color</span>.<span class="name">Black</span>
                <span class="name">textAlign</span>: <span class="name">TextAlign</span>.<span class="name">Center</span>
            }
        }
    }

    <span class="type">Container</span> {
        <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>
        <span class="name">topMargin</span>: <span class="number">100</span>

        <span class="name">visible</span>: !<span class="name">weatherService</span>.<span class="name">active</span> <span class="operator">&amp;&amp;</span> !<span class="name">weatherService</span>.<span class="name">succeeded</span>

        <span class="type">TextArea</span> {
            <span class="name">editable</span>: <span class="number">false</span>
            <span class="name">backgroundVisible</span>: <span class="number">false</span>

            <span class="name">text</span>: <span class="name">weatherService</span>.<span class="name">error</span>
            <span class="type">textStyle</span> {
                <span class="name">base</span>: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">SmallText</span>
                <span class="name">color</span>: <span class="name">Color</span>.<span class="name">Black</span>
                <span class="name">textAlign</span>: <span class="name">TextAlign</span>.<span class="name">Center</span>
            }
        }
    }
    }</pre>
<p>The first Container is only visible if the WeatherService is no longer active and has succeeded, allowing the labels to present the temperature information from the soap request. The second Container is active if the WeatherService does not succeed and displays the generated error message. The &quot;visible, text&quot; properties are bound to the WeatherService objects properties, which will be refreshed/updated when those properties change.</p>
<pre class="qml">    <span class="name">attachedObjects</span>: [
        <span class="type">WeatherService</span> {
            <span class="name">id</span>: <span class="name">weatherService</span>
        }
    ]</pre>
<p>This is the registered qml custom type WeatherService, which the rest of the qml can reference to access its properties, slots or invokable methods.</p>
<a name="weatherservice"></a>
<h2>WeatherService</h2>
<p>The WeatherService class encapsulates the mechanism for creating SOAP messages requests to the host, and parsing the reply messages to display the results. It contains a <a href="qtsoaphttptransport.html">QtSoapHttpTransport</a> member variable which will do the low-level http communication.</p>
<pre class="cpp">    WeatherService<span class="operator">::</span>WeatherService(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span><span class="operator">*</span> parent)
        : <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>(parent)
        <span class="operator">,</span> m_succeeded(<span class="keyword">false</span>)
        <span class="operator">,</span> m_active(<span class="keyword">false</span>)
    {
        <span class="type">bool</span> ok <span class="operator">=</span> connect(<span class="operator">&amp;</span>m_soap<span class="operator">,</span> SIGNAL(responseReady())<span class="operator">,</span> SLOT(onServiceResponse()));
        Q_ASSERT(ok);
        Q_UNUSED(ok);
    }</pre>
<p>In the constructor the <a href="qtsoaphttptransport.html#responseReady">responseReady()</a> signal of the <a href="qtsoaphttptransport.html">QtSoapHttpTransport</a> against the onServiceResponse() slot of the WeatherService object, so that we can parse the soap response when the host has responded to our request.</p>
<pre class="cpp">    <span class="type">void</span> WeatherService<span class="operator">::</span>requestWeatherInformation(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> <span class="operator">&amp;</span>zipCode)
    {
        <span class="keyword">if</span> (m_active)
            <span class="keyword">return</span>;

        m_active <span class="operator">=</span> <span class="keyword">true</span>;
        <span class="keyword">emit</span> activeChanged();

        m_succeeded <span class="operator">=</span> <span class="keyword">false</span>;

        m_soap<span class="operator">.</span>setAction(<span class="string">&quot;http://ws.cdyne.com/WeatherWS/GetCityWeatherByZIP&quot;</span>);
        m_soap<span class="operator">.</span>setHost(<span class="string">&quot;wsf.cdyne.com&quot;</span>);

        <span class="type"><a href="qtsoapmessage.html">QtSoapMessage</a></span> request;
        request<span class="operator">.</span>setMethod(<span class="type"><a href="qtsoapqname.html">QtSoapQName</a></span>(<span class="string">&quot;GetCityWeatherByZIP&quot;</span><span class="operator">,</span> <span class="string">&quot;http://ws.cdyne.com/WeatherWS/&quot;</span>));
        request<span class="operator">.</span>addMethodArgument(<span class="string">&quot;ZIP&quot;</span><span class="operator">,</span> <span class="string">&quot;http://ws.cdyne.com/WeatherWS/&quot;</span><span class="operator">,</span> zipCode);

        <span class="comment">// Submit the method request to the web service.</span>
        m_soap<span class="operator">.</span>submitRequest(request<span class="operator">,</span> <span class="string">&quot;/WeatherWS/Weather.asmx&quot;</span>);
    }</pre>
<p>Inside this method a new city request is passed to the <a href="qtsoapmessage.html#addMethodArgument">addMethodArgument()</a> of the <a href="qtsoapmessage.html">QtSoapMessage</a> with the zip code as parameter that the user selected in the DropDown in the UI.</p>
<pre class="cpp">    <span class="type">void</span> WeatherService<span class="operator">::</span>onServiceResponse()
    {
        <span class="comment">// Get the response, check for error.</span>
        <span class="keyword">const</span> <span class="type"><a href="qtsoapmessage.html">QtSoapMessage</a></span><span class="operator">&amp;</span> response <span class="operator">=</span> m_soap<span class="operator">.</span>getResponse();
        <span class="keyword">if</span> (response<span class="operator">.</span>isFault()) {
            m_error <span class="operator">=</span> tr(<span class="string">&quot;Query failed: %1&quot;</span>)<span class="operator">.</span>arg(response<span class="operator">.</span>faultString()<span class="operator">.</span>value()<span class="operator">.</span>toString());
            <span class="keyword">emit</span> statusChanged();

            m_active <span class="operator">=</span> <span class="keyword">false</span>;
            <span class="keyword">emit</span> activeChanged();

            <span class="keyword">emit</span> complete();
            <span class="keyword">return</span>;
        }

        <span class="comment">// Extract the return value from this method response, check for</span>
        <span class="comment">// errors.</span>
        <span class="keyword">const</span> <span class="type"><a href="qtsoaptype.html">QtSoapType</a></span><span class="operator">&amp;</span> responseValue <span class="operator">=</span> response<span class="operator">.</span>returnValue();
        <span class="keyword">if</span> (<span class="operator">!</span>responseValue<span class="operator">.</span>isValid()) {
            m_error <span class="operator">=</span> tr(<span class="string">&quot;Query failed: invalid return value&quot;</span>);
            <span class="keyword">emit</span> statusChanged();

            m_active <span class="operator">=</span> <span class="keyword">false</span>;
            <span class="keyword">emit</span> activeChanged();

            <span class="keyword">emit</span> complete();
            <span class="keyword">return</span>;
        }

        <span class="keyword">if</span> (<span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span><span class="operator">::</span>compare(<span class="string">&quot;true&quot;</span><span class="operator">,</span> responseValue<span class="operator">[</span><span class="string">&quot;Success&quot;</span><span class="operator">]</span><span class="operator">.</span>toString()<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qt.html">Qt</a></span><span class="operator">::</span>CaseInsensitive) <span class="operator">=</span><span class="operator">=</span> <span class="number">0</span>) {
            m_succeeded <span class="operator">=</span> <span class="keyword">true</span>;
            m_error<span class="operator">.</span>clear();

            <span class="keyword">const</span> <span class="type">int</span> fahrenheit <span class="operator">=</span> responseValue<span class="operator">[</span><span class="string">&quot;Temperature&quot;</span><span class="operator">]</span><span class="operator">.</span>toInt();
            <span class="keyword">const</span> <span class="type">int</span> celsius <span class="operator">=</span> (fahrenheit <span class="operator">-</span> <span class="number">32</span>)<span class="operator">*</span>(<span class="number">5.0</span> <span class="operator">/</span> <span class="number">9.0</span>);
            m_temperature <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span><span class="operator">::</span>fromLatin1(<span class="string">&quot;%1 F / %2%3C&quot;</span>)<span class="operator">.</span>arg(fahrenheit)<span class="operator">.</span>arg(celsius)<span class="operator">.</span>arg(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qchar.html">QChar</a></span>(<span class="number">0x00B0</span>));
            m_description <span class="operator">=</span> responseValue<span class="operator">[</span><span class="string">&quot;Description&quot;</span><span class="operator">]</span><span class="operator">.</span>toString();

            <span class="keyword">emit</span> temperatureChanged();
            <span class="keyword">emit</span> descriptionChanged();
        } <span class="keyword">else</span> {
            m_succeeded <span class="operator">=</span> <span class="keyword">false</span>;
            m_error <span class="operator">=</span> responseValue<span class="operator">[</span><span class="string">&quot;ResponseText&quot;</span><span class="operator">]</span><span class="operator">.</span>toString();
        }

        <span class="keyword">emit</span> statusChanged();

        m_active <span class="operator">=</span> <span class="keyword">false</span>;
        <span class="keyword">emit</span> activeChanged();

        <span class="keyword">emit</span> complete();
    }</pre>
<p>After the responseReady signal is generated, the onServiceResponse() method is called. This one parses the <a href="qtsoapmessage.html">QtSoapMessage</a> to test it's validity and extract the weather information related to the selected city.</p>
</div>
<!-- @@@soapxml -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Copyright 2012 Research In Motion Limited.
  <br />
    This document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
