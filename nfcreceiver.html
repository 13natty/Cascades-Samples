<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- nfcreceiver.qdoc -->
  <title>Cascades : NFC Receiver</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt-based BB10 API Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
<li><a href="http://qt.nokia.com/doc/4.7/all-examples.html">Examples</a></li>
<li>NFC Receiver</li>
    </ul>
  </div>
</div>
<div class="content mainContent">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#description">Description</a></li>
<li class="level1"><a href="#overview">Overview</a></li>
<li class="level1"><a href="#the-ui">The UI</a></li>
<li class="level1"><a href="#nfcreceiver">NfcReceiver</a></li>
</ul>
</div>
<h1 class="title">NFC Receiver</h1>
<span class="subtitle"></span>
<!-- $$$nfcreceiver-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="nfcreceiver-precompiled-h.html">nfcreceiver/precompiled.h</a></li>
<li><a href="nfcreceiver-assets-field-qml.html">nfcreceiver/assets/Field.qml</a></li>
<li><a href="nfcreceiver-assets-main-qml.html">nfcreceiver/assets/main.qml</a></li>
<li><a href="nfcreceiver-src-nfcreceiver-cpp.html">nfcreceiver/src/NfcReceiver.cpp</a></li>
<li><a href="nfcreceiver-src-nfcreceiver-hpp.html">nfcreceiver/src/NfcReceiver.hpp</a></li>
<li><a href="nfcreceiver-src-main-cpp.html">nfcreceiver/src/main.cpp</a></li>
<li><a href="nfcreceiver-nfcreceiver-pro.html">nfcreceiver/nfcreceiver.pro</a></li>
<li><a href="nfcreceiver-translations-nfcreceiver-pro.html">nfcreceiver/translations/nfcreceiver.pro</a></li>
</ul>
<a name="description"></a>
<h2>Description</h2>
<p>The NFC Receiver example allows the user to simply read data from NFC tags.</p>
<p class="centerAlign"><img src="images/nfcreceiver-example.png" /></p><a name="overview"></a>
<h2>Overview</h2>
<p>In this example we'll learn how to use the <tt>bb::system::InvokeManager</tt> to be invoked on the arrival of a NFC tag and how to extract data out of the received NDEF message. The business logic is encapsulated in the C++ class <tt>NfcReceiver</tt>, which is exported to QML under the name '<a href="#nfcreceiver">_nfcReceiver</a>'.</p>
<pre class="cpp">        NfcReceiver nfcReceiver;

        QmlDocument <span class="operator">*</span>qml <span class="operator">=</span> QmlDocument<span class="operator">::</span>create(<span class="string">&quot;asset:///main.qml&quot;</span>)<span class="operator">.</span>parent(<span class="operator">&amp;</span>app);
        qml<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(<span class="string">&quot;_nfcReceiver&quot;</span><span class="operator">,</span> <span class="operator">&amp;</span>nfcReceiver);</pre>
<a name="the-ui"></a>
<h2>The UI</h2>
<p>The UI is intended to display the properties of the NDEF message, which is shared via some NFC tag, or shared data from another NFC enabled device. The NDEF message records, containing the property information, are displayed through a <tt>ListView</tt>.</p>
<pre class="qml">    <span class="comment">// The list view that shows the records of the received NDEF message</span>
    <span class="type"><a href="http://qt.nokia.com/doc/4.7/qml-listview.html">ListView</a></span> {
        <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Fill</span>
        <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Fill</span>

        <span class="name">dataModel</span>: <span class="name">_nfcReceiver</span>.<span class="name">messageRecords</span>

        <span class="name">listItemComponents</span>: [
            <span class="type">ListItemComponent</span> {
                <span class="name">type</span>: <span class="string">&quot;&quot;</span>

                <span class="type">Container</span> {
                    <span class="name">preferredWidth</span>: <span class="number">768</span>
                    <span class="name">leftPadding</span>: <span class="number">10</span>
                    <span class="name">rightPadding</span>: <span class="number">10</span>

                    <span class="type">Field</span> {
                        <span class="name">title</span>: <span class="name">qsTr</span>(<span class="string">&quot;tnf type&quot;</span>)
                        <span class="name">value</span>: <span class="name">ListItemData</span>.<span class="name">tnfType</span> <span class="operator">==</span> <span class="string">&quot;0&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Empty Tag&quot;</span>) :
                               <span class="name">ListItemData</span>.<span class="name">tnfType</span> <span class="operator">==</span> <span class="string">&quot;1&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Well Known Type&quot;</span>) :
                               <span class="name">ListItemData</span>.<span class="name">tnfType</span> <span class="operator">==</span> <span class="string">&quot;2&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Media (MIME)&quot;</span>) :
                               <span class="name">ListItemData</span>.<span class="name">tnfType</span> <span class="operator">==</span> <span class="string">&quot;3&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Uri&quot;</span>) :
                               <span class="name">ListItemData</span>.<span class="name">tnfType</span> <span class="operator">==</span> <span class="string">&quot;4&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;External&quot;</span>) : <span class="string">&quot;&quot;</span>
                    }

                    <span class="type">Field</span> {
                        <span class="name">title</span>: <span class="name">qsTr</span>(<span class="string">&quot;record type&quot;</span>)
                        <span class="name">value</span>: <span class="name">ListItemData</span>.<span class="name">recordType</span> <span class="operator">==</span> <span class="string">&quot;Sp&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Smart Poster&quot;</span>) :
                               <span class="name">ListItemData</span>.<span class="name">recordType</span> <span class="operator">==</span> <span class="string">&quot;T&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Text&quot;</span>) :
                               <span class="name">ListItemData</span>.<span class="name">recordType</span> <span class="operator">==</span> <span class="string">&quot;U&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Uri&quot;</span>) :
                               <span class="name">ListItemData</span>.<span class="name">recordType</span> <span class="operator">==</span> <span class="string">&quot;Gc&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Generic Control&quot;</span>) :
                               <span class="name">ListItemData</span>.<span class="name">recordType</span> <span class="operator">==</span> <span class="string">&quot;Hr&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Handover Request&quot;</span>) :
                               <span class="name">ListItemData</span>.<span class="name">recordType</span> <span class="operator">==</span> <span class="string">&quot;Hs&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Handover Select&quot;</span>) :
                               <span class="name">ListItemData</span>.<span class="name">recordType</span> <span class="operator">==</span> <span class="string">&quot;Hc&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Handover Carrier&quot;</span>) :
                               <span class="name">ListItemData</span>.<span class="name">recordType</span> <span class="operator">==</span> <span class="string">&quot;Sig&quot;</span> ? <span class="name">qsTr</span>(<span class="string">&quot;Signature&quot;</span>) : <span class="string">&quot;&quot;</span>
                    }

                    <span class="type">Field</span> {
                        <span class="name">title</span>: <span class="name">qsTr</span>(<span class="string">&quot;payload&quot;</span>)
                        <span class="name">value</span>: <span class="name">ListItemData</span>.<span class="name">payload</span>
                    }

                    <span class="type">Field</span> {
                        <span class="name">title</span>: <span class="name">qsTr</span>(<span class="string">&quot;hex&quot;</span>)
                        <span class="name">value</span>: <span class="name">ListItemData</span>.<span class="name">hexPayload</span>
                    }
                }
            }
        ]
    }</pre>
<a name="nfcreceiver"></a>
<h2>NfcReceiver</h2>
<p>This class retrieves the NdefMessage being transmitted, extracts its properties and displays them on the screen.</p>
<pre class="cpp">    NfcReceiver<span class="operator">::</span>NfcReceiver(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent)
        : <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>(parent)
        <span class="operator">,</span> m_messageRecords(<span class="keyword">new</span> bb<span class="operator">::</span>cascades<span class="operator">::</span><span class="type">QVariantListDataModel</span>())
    {
        m_messageRecords<span class="operator">-</span><span class="operator">&gt;</span>setParent(<span class="keyword">this</span>);

        <span class="comment">// Create an InvokeManager</span>
        bb<span class="operator">::</span>system<span class="operator">::</span>InvokeManager <span class="operator">*</span>invokeManager <span class="operator">=</span> <span class="keyword">new</span> bb<span class="operator">::</span>system<span class="operator">::</span>InvokeManager(<span class="keyword">this</span>);

        <span class="comment">/**
         * The signal invoked(const bb::system::InvokeRequest&amp;) is used for applications.
         */</span>
        <span class="type">bool</span> ok <span class="operator">=</span> connect(invokeManager<span class="operator">,</span> SIGNAL(invoked(<span class="keyword">const</span> bb<span class="operator">::</span>system<span class="operator">::</span>InvokeRequest<span class="operator">&amp;</span>))<span class="operator">,</span>
                          <span class="keyword">this</span><span class="operator">,</span> SLOT(receivedInvokeTarget(<span class="keyword">const</span> bb<span class="operator">::</span>system<span class="operator">::</span>InvokeRequest<span class="operator">&amp;</span>)));
        Q_ASSERT(ok);
        Q_UNUSED(ok);
    }</pre>
<p>Inside the constructor the <tt>InvokeManager</tt> is initialized, from whom we listen for invoke requests.</p>
<pre class="cpp">    <span class="type">void</span> NfcReceiver<span class="operator">::</span>receivedInvokeTarget(<span class="keyword">const</span> bb<span class="operator">::</span>system<span class="operator">::</span>InvokeRequest<span class="operator">&amp;</span> request)
    {
        <span class="comment">// The data contains our NDEF message</span>
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qbytearray.html">QByteArray</a></span> data <span class="operator">=</span> request<span class="operator">.</span>data();

        <span class="comment">// Create out NDEF message</span>
        <span class="keyword">const</span> <span class="type">QtMobilitySubset</span><span class="operator">::</span><span class="type">QNdefMessage</span> ndefMessage <span class="operator">=</span> <span class="type">QtMobilitySubset</span><span class="operator">::</span><span class="type">QNdefMessage</span><span class="operator">::</span>fromByteArray(data);

        <span class="comment">// Fill the model with the single records</span>
        m_messageRecords<span class="operator">-</span><span class="operator">&gt;</span>clear();

        <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> ndefMessage<span class="operator">.</span>size(); <span class="operator">+</span><span class="operator">+</span>i) {
            <span class="keyword">const</span> <span class="type">QtMobilitySubset</span><span class="operator">::</span><span class="type">QNdefRecord</span> record <span class="operator">=</span> ndefMessage<span class="operator">.</span>at(i);

            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantMap-typedef">QVariantMap</a></span> entry;
            entry<span class="operator">[</span><span class="string">&quot;tnfType&quot;</span><span class="operator">]</span> <span class="operator">=</span> record<span class="operator">.</span>typeNameFormat();
            entry<span class="operator">[</span><span class="string">&quot;recordType&quot;</span><span class="operator">]</span> <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span><span class="operator">::</span>fromLatin1(record<span class="operator">.</span>type());
            entry<span class="operator">[</span><span class="string">&quot;payload&quot;</span><span class="operator">]</span> <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span><span class="operator">::</span>fromLatin1(record<span class="operator">.</span>payload());
            entry<span class="operator">[</span><span class="string">&quot;hexPayload&quot;</span><span class="operator">]</span> <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span><span class="operator">::</span>fromLatin1(record<span class="operator">.</span>payload()<span class="operator">.</span>toHex());

            m_messageRecords<span class="operator">-</span><span class="operator">&gt;</span>append(entry);
        }

        <span class="keyword">emit</span> messageReceived();
    }</pre>
<p>This method extracts the data portion of the request, which is the <tt>QNdefMessage</tt> we have been waiting for. Afterwards, it access' the record entries from the message and saves them in the <tt>QVariantListDataModel</tt> for display.</p>
</div>
<!-- @@@nfcreceiver -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Copyright 2012 Research In Motion Limited.
  <br />
    This document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
