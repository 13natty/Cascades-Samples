<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- repeater.qdoc -->
  <title>Cascades : Repeater Example</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt-based BB10 API Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
<li><a href="http://qt.nokia.com/doc/4.7/all-examples.html">Examples</a></li>
<li>Repeater Example</li>
    </ul>
  </div>
</div>
<div class="content mainContent">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#description">Description</a></li>
<li class="level1"><a href="#overview">Overview</a></li>
<li class="level1"><a href="#the-ui">The UI</a></li>
<li class="level2"><a href="#simple">Simple</a></li>
<li class="level2"><a href="#index">Index</a></li>
<li class="level2"><a href="#dynamic">Dynamic</a></li>
<li class="level2"><a href="#array">Array</a></li>
<li class="level2"><a href="#sql-model">SQL Model</a></li>
<li class="level1"><a href="#repeater">Repeater</a></li>
</ul>
</div>
<h1 class="title">Repeater Example</h1>
<span class="subtitle"></span>
<!-- $$$repeater-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="repeater-assets-custompage-qml.html">repeater/assets/CustomPage.qml</a></li>
<li><a href="repeater-assets-main-qml.html">repeater/assets/main.qml</a></li>
<li><a href="repeater-src-repeater-cpp.html">repeater/src/Repeater.cpp</a></li>
<li><a href="repeater-src-repeater-hpp.html">repeater/src/Repeater.hpp</a></li>
<li><a href="repeater-src-sqlmodel-cpp.html">repeater/src/SqlModel.cpp</a></li>
<li><a href="repeater-src-sqlmodel-hpp.html">repeater/src/SqlModel.hpp</a></li>
<li><a href="repeater-src-main-cpp.html">repeater/src/main.cpp</a></li>
<li><a href="repeater-repeater-pro.html">repeater/repeater.pro</a></li>
</ul>
<a name="description"></a>
<h2>Description</h2>
<p>The Repeater example demonstrates how to use <a href="http://qt.nokia.com/doc/4.7/qdeclarativecomponent.html">QDeclarativeComponent</a> to extend Cascades with a powerful mechanism to generate a couple of parameterized controls depending on a template and a model.</p>
<p class="centerAlign"><img src="images/repeater-example.png" /></p><a name="overview"></a>
<h2>Overview</h2>
<p>In this example we'll learn how to use the <a href="http://qt.nokia.com/doc/4.7/qdeclarativecomponent.html">QDeclarativeComponent</a> class to extend Cascades with a custom element named <tt>Repeater</tt> that allows the user to load and unload a set of parameterized <tt>Controls</tt> at runtime. This element can be used to create a calendar control for example, where you have a couple of identical subcontrols (one box for each day) that differ slightly (the day number).</p>
<p>The <tt>Repeater</tt> takes a model and a delegate as parameters. The delegate is a QML snippet that is used as template for the controls to generate. For each entry of the model, the <tt>Repeater</tt> will generate one control and add it to the <tt>Container</tt> the <tt>Repeater</tt> is located in.</p>
<a name="the-ui"></a>
<h2>The UI</h2>
<p>The UI of this sample application consists of a <tt>TabbedPane</tt> with five pages:</p>
<a name="simple"></a>
<h3>Simple</h3>
<pre class="qml">    <span class="type">Container</span> {
        <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Fill</span>
        <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Fill</span>

        <span class="name">leftPadding</span>: <span class="number">30</span>
        <span class="name">topPadding</span>: <span class="number">30</span>
        <span class="name">rightPadding</span>: <span class="number">30</span>

        <span class="type">Repeater</span> {
            <span class="comment">// Use a simple number (N) as model -&gt; the delegate will be repeated N times</span>
            <span class="name">model</span>: <span class="number">5</span>

            <span class="type">Label</span> {
                <span class="name">text</span>: <span class="name">qsTr</span> (<span class="string">&quot;Hello World&quot;</span>)
                <span class="type">textStyle</span> {
                    <span class="name">base</span>: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">BodyText</span>
                    <span class="name">color</span>: <span class="name">Color</span>.<span class="name">White</span>
                }
            }
        }
    }</pre>
<p>In this case the <tt>Repeater</tt> takes a numeric value (5) as model which means that it will create the given delegate (the 'Hello World' label) 5 times. This makes the declaration of a larger number of identical objects easy, but the power of the <tt>Repeater</tt> will become visible on the next page.</p>
<a name="index"></a>
<h3>Index</h3>
<pre class="qml">    <span class="type">Container</span> {
        <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Fill</span>
        <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Fill</span>

        <span class="name">leftPadding</span>: <span class="number">30</span>
        <span class="name">topPadding</span>: <span class="number">30</span>
        <span class="name">rightPadding</span>: <span class="number">30</span>

        <span class="type">Repeater</span> {
            <span class="comment">// Use a simple number (N) as model -&gt; the delegate will be repeated N times</span>
            <span class="name">model</span>: <span class="number">5</span>

            <span class="type">Label</span> {
                <span class="comment">// The current index can be accessed via the 'index' context property</span>
                <span class="name">text</span>: <span class="name">qsTr</span> (<span class="string">&quot;Hello World (%1)&quot;</span>).<span class="name">arg</span>(<span class="name">index</span>)
                <span class="type">textStyle</span> {
                    <span class="name">base</span>: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">BodyText</span>
                    <span class="name">color</span>: <span class="name">Color</span>.<span class="name">White</span>
                }
            }
        }
    }</pre>
<p>On this page the <tt>Repeater</tt> create 5 <tt>Labels</tt> again, however this time the delegate accesses the 'index' property which is injected by the <tt>Repeater</tt> into the context of the delegate (the <tt>Label</tt>). The value of the 'index' property will be different for each instantiation of the delegate, so we will create 5 different <tt>Labels</tt> with the content 'Hello World (1)' to 'Hello World (5)' here.</p>
<a name="dynamic"></a>
<h3>Dynamic</h3>
<pre class="qml">    <span class="type">Container</span> {
        <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Fill</span>
        <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Fill</span>

        <span class="name">leftPadding</span>: <span class="number">30</span>
        <span class="name">topPadding</span>: <span class="number">30</span>
        <span class="name">rightPadding</span>: <span class="number">30</span>

        <span class="type">Slider</span> {
            <span class="name">id</span>: <span class="name">slider</span>
            <span class="name">fromValue</span>: <span class="number">1</span>
            <span class="name">toValue</span>: <span class="number">5</span>
            <span class="name">value</span>: <span class="number">1</span>
        }

        <span class="type">Repeater</span> {
            <span class="comment">// The number, that is used as model, can be a property binding as well</span>
            <span class="name">model</span>: <span class="name">slider</span>.<span class="name">immediateValue</span>

            <span class="type">Label</span> {
                <span class="name">text</span>: <span class="name">qsTr</span> (<span class="string">&quot;Hello World (%1)&quot;</span>).<span class="name">arg</span>(<span class="name">index</span>)
                <span class="type">textStyle</span> {
                    <span class="name">base</span>: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">BodyText</span>
                    <span class="name">color</span>: <span class="name">Color</span>.<span class="name">White</span>
                }
            }
        }
    }</pre>
<p>On this page we show that the model of the <tt>Repeater</tt> does not have to be a static value, we can bind the 'value' property of a <tt>Slider</tt> against the 'model' property of the <tt>Repeater</tt>. Now whenever the user changes the <tt>Slider</tt>, the number of <tt>Labels</tt> will be adapted automatically.</p>
<a name="array"></a>
<h3>Array</h3>
<pre class="qml">    <span class="type">Container</span> {
        <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Fill</span>
        <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Fill</span>

        <span class="name">leftPadding</span>: <span class="number">30</span>
        <span class="name">topPadding</span>: <span class="number">30</span>
        <span class="name">rightPadding</span>: <span class="number">30</span>

        <span class="type">Repeater</span> {
            <span class="comment">// Use an array of arbitrary values as model</span>
            <span class="name">model</span>: [<span class="name">Color</span>.<span class="name">Red</span>, <span class="name">Color</span>.<span class="name">Yellow</span>, <span class="name">Color</span>.<span class="name">Green</span>, <span class="name">Color</span>.<span class="name">Blue</span>, <span class="name">Color</span>.<span class="name">White</span>]

            <span class="type">Label</span> {
                <span class="name">text</span>: <span class="name">qsTr</span> (<span class="string">&quot;Hello World (%1)&quot;</span>).<span class="name">arg</span>(<span class="name">index</span>)

                <span class="comment">// The current value of the model can be accessed via the 'modelData' context property</span>
                <span class="type">textStyle</span> {
                    <span class="name">base</span>: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">BodyText</span>
                    <span class="name">color</span>: <span class="name">modelData</span>
                }
            }
        }
    }</pre>
<p>This pages demonstrates that the model of the <tt>Repeater</tt> does not have to be a numeric value but can also be a list of objects, in this case we use a list of color objects. The 'index' property will be in the range of the size of the list now and the content of the list is accessible within the delegate via the 'modelData' property. So we will get 5 <tt>Labels</tt> with a numbered 'Hello World' text again, but this time each <tt>Label</tt> has a different color.</p>
<a name="sql-model"></a>
<h3>SQL Model</h3>
<pre class="qml">    <span class="type">Container</span> {
        <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Fill</span>
        <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Fill</span>

        <span class="name">leftPadding</span>: <span class="number">30</span>
        <span class="name">topPadding</span>: <span class="number">30</span>
        <span class="name">rightPadding</span>: <span class="number">30</span>

        <span class="type">ScrollView</span> {
            <span class="type">scrollViewProperties</span> {
                <span class="name">scrollMode</span>: <span class="name">ScrollMode</span>.<span class="name">Vertical</span>
            }

            <span class="type">Container</span> {
                <span class="type">Repeater</span> {
                    <span class="comment">// Use a DataModel object as model</span>
                    <span class="name">model</span>: <span class="name">_sqlModel</span>
                    <span class="type">Container</span> {
                        <span class="name">topPadding</span>: <span class="number">30</span>

                        <span class="comment">// The values of the current model entry can be accessed by their key names (here: title, firstname, surname)</span>
                        <span class="type">Label</span> {
                            <span class="name">text</span>: <span class="name">title</span>
                            <span class="name">textStyle</span>.base: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">TitleText</span>
                            <span class="name">textStyle</span>.color: <span class="name">Color</span>.<span class="name">White</span>
                        }

                        <span class="type">Label</span> {
                            <span class="name">text</span>: <span class="name">qsTr</span> (<span class="string">&quot;[%1 %2]&quot;</span>).<span class="name">arg</span>(<span class="name">firstname</span>).<span class="name">arg</span>(<span class="name">surname</span>)
                            <span class="name">textStyle</span>.base: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">BodyText</span>
                            <span class="name">textStyle</span>.color: <span class="name">Color</span>.<span class="name">White</span>
                        }

                        <span class="type">Divider</span> {}
                    }
                }
            }
        }
    }</pre>
<p>Finally we show that the model of the <tt>Repeater</tt> can be an actual <tt>DataModel</tt> as provided by Cascades. Here we have created a C++ <tt>DataSet</tt> model, that loads its data from a SQLite database file, and exported it under the name '_sqlModel'. Each entry of this model contains of a list of key/value pairs. The <tt>Repeater</tt> will make these pairs available to the delegate under the key names, so we can use 'firstname' and 'surname' to access the actual values for that entry.</p>
<a name="repeater"></a>
<h2>Repeater</h2>
<p>The <tt>Repeater</tt> has a 'delegate' property of type <a href="http://qt.nokia.com/doc/4.7/qdeclarativecomponent.html">QDeclarativeComponent</a>*, which specifies the component used for creating the QML elements. The 'model' property specifies how often the element should be repeated. Apart from using an integer constant here, it is also possible to specify a <a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a> or a <tt>DataModel</tt>. For the later case, the variant and the map content of the <a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a> and the <tt>DataModel</tt> are made available in the created QML elements by setting them as their context property.</p>
<p>The fact that writing &quot;delegate: Label { ..&#x2e; }&quot; in QML creates a <a href="http://qt.nokia.com/doc/4.7/qdeclarativecomponent.html">QDeclarativeComponent</a>* and not a <tt>Label*</tt> is a special behavior of the QML engine. Internally, the QML engine checks if the property (in this case 'delegate') is of type <a href="http://qt.nokia.com/doc/4.7/qdeclarativecomponent.html">QDeclarativeComponent</a>*, and if so, treats the assignment as a component assignment, not a item assignment. The <tt>Repeater</tt> itself just sees a <a href="http://qt.nokia.com/doc/4.7/qdeclarativecomponent.html">QDeclarativeComponent</a>*, as that is what it gets passed from the QML engine.</p>
<pre class="cpp">    <span class="keyword">class</span> Repeater : <span class="keyword">public</span> bb<span class="operator">::</span>cascades<span class="operator">::</span>CustomControl
    {
        Q_OBJECT

        <span class="comment">/**
         * The property that represents the model.
         * We use QVariant as type here so that the user can pass different type of models here.
         */</span>
        Q_PROPERTY(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html">QVariant</a></span> model READ model WRITE setModel NOTIFY modelChanged)

        <span class="comment">// The declarative component that is used as 'template' for the repeated elements</span>
        Q_PROPERTY(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qdeclarativecomponent.html">QDeclarativeComponent</a></span> <span class="operator">*</span>delegate READ delegate WRITE setDelegate NOTIFY delegateChanged)

        <span class="comment">// Mark the 'delegate' property as default property</span>
        Q_CLASSINFO(<span class="string">&quot;DefaultProperty&quot;</span><span class="operator">,</span> <span class="string">&quot;delegate&quot;</span>)

        <span class="keyword">public</span>:
            Repeater(bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>parent <span class="operator">=</span> <span class="number">0</span>);
            <span class="operator">~</span>Repeater();

            <span class="comment">// The accessor methods for the properties</span>
            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html">QVariant</a></span> model() <span class="keyword">const</span>;
            <span class="type">void</span> setModel(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html">QVariant</a></span> <span class="operator">&amp;</span>model);

            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdeclarativecomponent.html">QDeclarativeComponent</a></span> <span class="operator">*</span>delegate() <span class="keyword">const</span>;
            <span class="type">void</span> setDelegate(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qdeclarativecomponent.html">QDeclarativeComponent</a></span> <span class="operator">*</span>delegate);

        Q_SIGNALS:
            <span class="comment">// The change notification signals of the properties</span>
            <span class="type">void</span> modelChanged();
            <span class="type">void</span> delegateChanged();

        <span class="keyword">private</span>:
            <span class="comment">// This method clears the previsouly generated controls</span>
            <span class="type">void</span> clear();

            <span class="comment">// This method regenerates new controls according to the current model data</span>
            <span class="type">void</span> regenerate();

            <span class="comment">// The model data</span>
            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html">QVariant</a></span> m_model;

            <span class="comment">// The declarative component that is used as 'template' for the repeated elements</span>
            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdeclarativecomponent.html">QDeclarativeComponent</a></span> <span class="operator">*</span>m_delegate;

            <span class="comment">// The list of generated controls</span>
            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qlist.html">QList</a></span><span class="operator">&lt;</span>bb<span class="operator">::</span>cascades<span class="operator">::</span>Control<span class="operator">*</span><span class="operator">&gt;</span> m_controls;
    };</pre>
<p>The <tt>Repeater</tt> inherits from <tt>bb::cascades::CustomControl</tt>, so it can be placed inside a Container. However the newly created <tt>Controls</tt> are not placed inside the <tt>Repeater</tt>, but inside its parent <tt>Container</tt>.</p>
<p>The type of its 'model' property is <a href="http://qt.nokia.com/doc/4.7/qvariant.html">QVariant</a>. That allows us to assign models of different types (numeric values, arrays, <tt>DataModels</tt>) to it.</p>
<pre class="cpp">    Repeater<span class="operator">::</span>Repeater(Container <span class="operator">*</span>parent)
        : CustomControl(parent)
        <span class="operator">,</span> m_model(<span class="number">0</span>)
        <span class="operator">,</span> m_delegate(<span class="number">0</span>)
    {
        <span class="comment">// The Repeater itself is invisible</span>
        setVisible(<span class="keyword">false</span>);
    }</pre>
<p>Inside the constructor we initialize the member variables and hide the <tt>Repeater</tt> object.</p>
<pre class="cpp">    <span class="type">void</span> Repeater<span class="operator">::</span>setModel(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html">QVariant</a></span> <span class="operator">&amp;</span>model)
    {
        <span class="keyword">if</span> (m_model <span class="operator">=</span><span class="operator">=</span> model)
            <span class="keyword">return</span>;

        <span class="comment">// If the model has changed, clear all previously generated controls and regenerate them</span>
        m_model <span class="operator">=</span> model;
        clear();
        regenerate();

        <span class="keyword">emit</span> modelChanged();
    }
    <span class="type">void</span> Repeater<span class="operator">::</span>setDelegate(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qdeclarativecomponent.html">QDeclarativeComponent</a></span> <span class="operator">*</span>delegate)
    {
        <span class="keyword">if</span> (m_delegate <span class="operator">=</span><span class="operator">=</span> delegate)
            <span class="keyword">return</span>;

        <span class="comment">// If the delegate has changed, clear all previously generated controls and regenerate them</span>
        m_delegate <span class="operator">=</span> delegate;
        clear();
        regenerate();

        <span class="keyword">emit</span> delegateChanged();
    }</pre>
<p>Whenever the 'model' or the 'delegate' property changes, we first delete all previously generated controls by calling <tt>clear()</tt> and then regenerate the controls with the new model and delegate data by calling <tt>regenerate()</tt>.</p>
<pre class="cpp">    <span class="type">void</span> Repeater<span class="operator">::</span>clear()
    {
        <span class="comment">// First remove all generated controls from their parent container ...</span>
        Container <span class="operator">*</span>container <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span>Container<span class="operator">*</span><span class="operator">&gt;</span>(parent());
        foreach (Control <span class="operator">*</span>control<span class="operator">,</span> m_controls) {
            container<span class="operator">-</span><span class="operator">&gt;</span>remove(control);
        }

        <span class="comment">// ... and delete them afterwards.</span>
        <a href="http://qt.nokia.com/doc/4.7/qtalgorithms.html#qDeleteAll">qDeleteAll</a>(m_controls);
        m_controls<span class="operator">.</span>clear();
    }</pre>
<p>The <tt>clear()</tt> method retrieves the pointer to the parent <tt>Container</tt> and then removes all generated controls from it. Afterwards it deletes all generated controls.</p>
<pre class="cpp">    <span class="type">void</span> Repeater<span class="operator">::</span>regenerate()
    {
        <span class="comment">// Sanity check</span>
        <span class="keyword">if</span> (<span class="operator">!</span>m_delegate)
            <span class="keyword">return</span>;

        <span class="comment">/**
         * Find the position of the Repeater inside its parent container, so that we can insert
         * the newly generated items there.
         */</span>
        Container <span class="operator">*</span>container <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span>Container<span class="operator">*</span><span class="operator">&gt;</span>(parent());
        <span class="keyword">const</span> <span class="type">int</span> repeaterPosition <span class="operator">=</span> container<span class="operator">-</span><span class="operator">&gt;</span>indexOf(<span class="keyword">this</span>);

        <span class="comment">/**
         * Now we check what the type of the model is and generate the controls.
         */</span>
        <span class="keyword">if</span> (m_model<span class="operator">.</span>type() <span class="operator">=</span><span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html">QVariant</a></span><span class="operator">::</span>Int <span class="operator">|</span><span class="operator">|</span> m_model<span class="operator">.</span>type() <span class="operator">=</span><span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html">QVariant</a></span><span class="operator">::</span>Double) {
            <span class="comment">/**
             * If a numeric value (N) was passed as model, we create a new control for each entry
             * in the sequence [1 - N] and make the index available as context property.
             */</span>
            <span class="keyword">const</span> <span class="type">int</span> counter <span class="operator">=</span> m_model<span class="operator">.</span>toInt();

            <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">1</span>; i <span class="operator">&lt;</span><span class="operator">=</span> counter; <span class="operator">+</span><span class="operator">+</span>i) {
                <span class="comment">// Create a child context that is specific for this new control</span>
                <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdeclarativecontext.html">QDeclarativeContext</a></span> <span class="operator">*</span>context <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdeclarativecontext.html">QDeclarativeContext</a></span>(m_delegate<span class="operator">-</span><span class="operator">&gt;</span>creationContext()<span class="operator">,</span> <span class="keyword">this</span>);

                <span class="comment">// Make the current index available as context properties</span>
                context<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(<span class="string">&quot;index&quot;</span><span class="operator">,</span> i);
                context<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(<span class="string">&quot;modelData&quot;</span><span class="operator">,</span> i);

                <span class="comment">// Create the control from the delegate component</span>
                <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>object <span class="operator">=</span> m_delegate<span class="operator">-</span><span class="operator">&gt;</span>create(context);
                Control <span class="operator">*</span>control <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span>Control<span class="operator">*</span><span class="operator">&gt;</span>(object);

                <span class="comment">// Insert the new control into the parent container</span>
                container<span class="operator">-</span><span class="operator">&gt;</span>insert(repeaterPosition <span class="operator">+</span> i<span class="operator">,</span> control);

                <span class="comment">// Keep a reference to the control, so that we can delete it later on</span>
                m_controls<span class="operator">.</span>append(control);
            }
        } <span class="keyword">else</span> <span class="keyword">if</span> (m_model<span class="operator">.</span>type() <span class="operator">=</span><span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html">QVariant</a></span><span class="operator">::</span>List) {
            <span class="comment">/**
             * If a QVariantList was passed as model, we create a new control for each entry of the list
             * and make the value at that position available as context property.
             */</span>
            <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a></span> list <span class="operator">=</span> m_model<span class="operator">.</span>toList();

            <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> list<span class="operator">.</span>count(); <span class="operator">+</span><span class="operator">+</span>i) {
                <span class="comment">// Create a child context that is specific for this new control</span>
                <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdeclarativecontext.html">QDeclarativeContext</a></span> <span class="operator">*</span>context <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdeclarativecontext.html">QDeclarativeContext</a></span>(m_delegate<span class="operator">-</span><span class="operator">&gt;</span>creationContext()<span class="operator">,</span> <span class="keyword">this</span>);

                <span class="comment">// Make the current index and value available as context properties</span>
                context<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(<span class="string">&quot;index&quot;</span><span class="operator">,</span> i <span class="operator">+</span> <span class="number">1</span>);
                context<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(<span class="string">&quot;modelData&quot;</span><span class="operator">,</span> list<span class="operator">.</span>at(i));

                <span class="comment">// Create the control from the delegate component</span>
                <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>object <span class="operator">=</span> m_delegate<span class="operator">-</span><span class="operator">&gt;</span>create(context);
                Control <span class="operator">*</span>control <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span>Control<span class="operator">*</span><span class="operator">&gt;</span>(object);

                <span class="comment">// Insert the new control into the parent container</span>
                container<span class="operator">-</span><span class="operator">&gt;</span>insert(repeaterPosition <span class="operator">+</span> i <span class="operator">+</span> <span class="number">1</span><span class="operator">,</span> control);

                <span class="comment">// Keep a reference to the control, so that we can delete it later on</span>
                m_controls<span class="operator">.</span>append(control);
            }
        } <span class="keyword">else</span> {
            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>model <span class="operator">=</span> m_model<span class="operator">.</span>value<span class="operator">&lt;</span><span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span><span class="operator">*</span><span class="operator">&gt;</span>();
            bb<span class="operator">::</span>cascades<span class="operator">::</span>DataModel <span class="operator">*</span>dataModel <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span>bb<span class="operator">::</span>cascades<span class="operator">::</span>DataModel<span class="operator">*</span><span class="operator">&gt;</span>(model);

            <span class="keyword">if</span> (dataModel) {
                <span class="comment">/**
                 * If a DataModel was passed as model, we create a new control for each entry of the model
                 * and make all key/value pairs of the entry available as context properties.
                 */</span>
                <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> dataModel<span class="operator">-</span><span class="operator">&gt;</span>childCount(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a></span>()); <span class="operator">+</span><span class="operator">+</span>i) {
                    <span class="comment">// Create a child context that is specific for this new control</span>
                    <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdeclarativecontext.html">QDeclarativeContext</a></span> <span class="operator">*</span>context <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdeclarativecontext.html">QDeclarativeContext</a></span>(m_delegate<span class="operator">-</span><span class="operator">&gt;</span>creationContext()<span class="operator">,</span> <span class="keyword">this</span>);

                    <span class="comment">// Make the current index available as context properties</span>
                    context<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(<span class="string">&quot;index&quot;</span><span class="operator">,</span> i <span class="operator">+</span> <span class="number">1</span>);

                    <span class="comment">// Make all key/value pairs of the current model entry available as context properties</span>
                    <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantMap-typedef">QVariantMap</a></span> map <span class="operator">=</span> dataModel<span class="operator">-</span><span class="operator">&gt;</span>data(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a></span>() <span class="operator">&lt;</span><span class="operator">&lt;</span> i)<span class="operator">.</span>toMap();
                    foreach (<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> <span class="operator">&amp;</span>key<span class="operator">,</span> map<span class="operator">.</span>keys()) {
                        context<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(key<span class="operator">,</span> map<span class="operator">.</span>value(key));
                    }

                    <span class="comment">// Create the control from the delegate component</span>
                    <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>object <span class="operator">=</span> m_delegate<span class="operator">-</span><span class="operator">&gt;</span>create(context);
                    Control <span class="operator">*</span>control <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span>Control<span class="operator">*</span><span class="operator">&gt;</span>(object);

                    <span class="comment">// Insert the new control into the parent container</span>
                    container<span class="operator">-</span><span class="operator">&gt;</span>insert(repeaterPosition <span class="operator">+</span> i <span class="operator">+</span> <span class="number">1</span><span class="operator">,</span> control);

                    <span class="comment">// Keep a reference to the control, so that we can delete it later on</span>
                    m_controls<span class="operator">.</span>append(control);
                }
            }
        }
    }</pre>
<p>Inside the <tt>regenerate()</tt> method the actual magic happens. The first step is to retrieve the pointer to the parent <tt>Container</tt> of the <tt>Repeater</tt> and to find out at which position the new controls should be inserted.</p>
<p>Then we check the type of the model, which can by done by evaluating the return value of <a href="http://qt.nokia.com/doc/4.7/qvariant.html#type">type()</a> of the model value.</p>
<p>If the QML file specified a numeric value (either a static value or a bound numeric property), this value is used for iteration to create the new controls. To make the 'index' and 'modelData' properties available to the delegate we need a new <a href="http://qt.nokia.com/doc/4.7/qdeclarativecontext.html">QDeclarativeContext</a> object, that is only used by one control instance that we'll create. After we set the values for the 'index' and 'modelData' properties on this context, we pass it to the <a href="http://qt.nokia.com/doc/4.7/qdeclarativecomponent.html#create">create()</a> method of the delegate object. This will create a new C++ object that represents the QML snippet which we specified for that delegate. Now we simply insert this object (<tt>Control</tt>) in the parent <tt>Container</tt> and append it to an internal list so that we can delete it in <tt>clear()</tt> later on.</p>
<p>If the model is not a numeric value but a list of objects, the QML runtime will assign a <a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a> to the 'model' property. In this case we create the new controls like described above, just that we use the content of the <a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantList-typedef">QVariantList</a> for setting the 'modelData' property now.</p>
<p>In all other cases we check whether a <tt>DataModel</tt> has been assigned to the 'model' property. If that's the case, we iterate over the number of entries of the model (calling <tt>childCount()</tt> with empty index path) and retrieve the data for each entry. We expect the model to return a <a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantMap-typedef">QVariantMap</a> for each entry here. The <a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantMap-typedef">QVariantMap</a> is basically a list of key/value pairs, so instead of a 'modelData' property, we publish the key names and values to the context of the delegate here.</p>
</div>
<!-- @@@repeater -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Copyright 2012 Research In Motion Limited.
  <br />
    This document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
