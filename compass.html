<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- compass.qdoc -->
  <title>Cascades : Compass Example</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt-based BB10 API Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
<li><a href="http://qt.nokia.com/doc/4.7/all-examples.html">Examples</a></li>
<li>Compass Example</li>
    </ul>
  </div>
</div>
<div class="content mainContent">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#description">Description</a></li>
<li class="level1"><a href="#overview">Overview</a></li>
<li class="level1"><a href="#the-ui">The UI</a></li>
<li class="level1"><a href="#compasssensor">CompassSensor</a></li>
</ul>
</div>
<h1 class="title">Compass Example</h1>
<span class="subtitle"></span>
<!-- $$$compass-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="compass-assets-main-qml.html">compass/assets/main.qml</a></li>
<li><a href="compass-src-compasssensor-cpp.html">compass/src/CompassSensor.cpp</a></li>
<li><a href="compass-src-compasssensor-hpp.html">compass/src/CompassSensor.hpp</a></li>
<li><a href="compass-src-main-cpp.html">compass/src/main.cpp</a></li>
<li><a href="compass-compass-pro.html">compass/compass.pro</a></li>
</ul>
<a name="description"></a>
<h2>Description</h2>
<p>The Compass example demonstrates how to use sensors from the QtSensors module to implement a compass UI.</p>
<p class="centerAlign"><img src="images/compass-example.png" /></p><a name="overview"></a>
<h2>Overview</h2>
<p>In this example we'll learn how to use the QCompass, QCompassFilter and QCompassReading classes to implement a simple compass UI in Cascades.</p>
<a name="the-ui"></a>
<h2>The UI</h2>
<p>The UI of this sample application consists of an <tt>ImageView</tt> that shows the compass rose and a <tt>Label</tt> that shows the current angle in degree.</p>
<p>The business logic of the application is encapsulated in the <a href="#compasssensor">CompassSensor</a> class which is made available to the UI under the name '_compass'.</p>
<pre class="qml">            <span class="type">ImageView</span> {
                <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>
                <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Center</span>

                <span class="name">imageSource</span>: <span class="string">&quot;asset:///images/compass.png&quot;</span>
                <span class="name">rotationZ</span>: -<span class="name">_compass</span>.<span class="name">azimuth</span>

                <span class="comment">// Disable implicit animations to avoid ugly &quot;jumps&quot; when switching from 0 degrees to 360 degrees and vice versa</span>
                <span class="name">attachedObjects</span>: <span class="name">ImplicitAnimationController</span> {
                    <span class="name">propertyName</span>: <span class="string">&quot;rotationZ&quot;</span>
                    <span class="name">enabled</span>: <span class="number">false</span>
                }
            }</pre>
<p>The compass rose image is rotated according to the azimuth angle as reported by the sensor object. To avoid the implicit animation on the 0 &lt;-&gt; 360 degree switch, we disable the implicit animation for the 'rotationZ' property explicitly.</p>
<pre class="qml">                <span class="type">Label</span> {
                    <span class="name">text</span>: <span class="name">Math</span>.<span class="name">round</span>(<span class="name">_compass</span>.<span class="name">azimuth</span>) <span class="operator">+</span> <span class="string">&quot;°&quot;</span>
                    <span class="type">textStyle</span> {
                        <span class="name">base</span>: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">BigText</span>
                        <span class="name">color</span>: <span class="name">Color</span>.<span class="name">White</span>
                        <span class="name">fontWeight</span>: <span class="name">FontWeight</span>.<span class="name">Bold</span>
                    }
                }</pre>
<p>The <tt>Label</tt> shows the current azimuth angle as reported by the sensor object.</p>
<a name="compasssensor"></a>
<h2>CompassSensor</h2>
<p>The <tt>CompassSensor</tt> encapsulates the business logic of the application. It contains a QCompass object, which does the low-level communication with the compass sensor of the device, and provides a property 'azimuth' to make the retrieved sensor data available to the UI. It inherits from QCompassFilter and reimplements the 'bool filter(QCompassReading*)' method to retrieve the sensor data from the QCompass object.</p>
<pre class="cpp">    <span class="keyword">class</span> CompassSensor : <span class="keyword">public</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span><span class="operator">,</span> <span class="keyword">public</span> <span class="type">QCompassFilter</span>
    {
        Q_OBJECT

        <span class="comment">// The property to access the azimuth value of the compass sensor</span>
        Q_PROPERTY(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qreal-typedef">qreal</a></span> azimuth READ azimuth NOTIFY azimuthChanged)

    <span class="keyword">public</span>:
        CompassSensor(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent <span class="operator">=</span> <span class="number">0</span>);

        <span class="comment">// The accessor method for the azimuth property</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qreal-typedef">qreal</a></span> azimuth() <span class="keyword">const</span>;

    Q_SIGNALS:
        <span class="comment">// The change notification signal of the azimuth property</span>
        <span class="type">void</span> azimuthChanged();

    <span class="keyword">protected</span>:
        <span class="comment">/**
         * This method is reimplemented from the QCompassFilter interface and is
         * called by the QCompass whenever new values are available.
         */</span>
        <span class="type">bool</span> filter(<span class="type">QCompassReading</span> <span class="operator">*</span>reading);

    <span class="keyword">private</span>:
        <span class="comment">// The compass sensor</span>
        <span class="type">QCompass</span> m_compassSensor;

        <span class="comment">// The azimuth value</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qreal-typedef">qreal</a></span> m_azimuth;
    };</pre>
<p>Inside the constructor we try to connect the QCompass object to the hardware backend. If that's successful, we register the <a href="#compasssensor">CompassSensor</a> class as filter for the QCompass object and start the sensor to gather data.</p>
<pre class="cpp">    CompassSensor<span class="operator">::</span>CompassSensor(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent)
        : <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>(parent)
        <span class="operator">,</span> m_azimuth(<span class="number">0</span>)
    {
        <span class="comment">// We'd like to lock to the initial orientation</span>
        OrientationSupport<span class="operator">::</span>instance()<span class="operator">-</span><span class="operator">&gt;</span>setSupportedDisplayOrientation(SupportedDisplayOrientation<span class="operator">::</span>CurrentLocked);

        <span class="comment">// At first we have to connect to the sensor backend...</span>
        <span class="keyword">if</span> (<span class="operator">!</span>m_compassSensor<span class="operator">.</span>connectToBackend()) {
            <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qWarning">qWarning</a>() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;Cannot connect to compass sensor backend!&quot;</span>;
        }

        <span class="comment">// ... and then add a filter that will process the read data</span>
        m_compassSensor<span class="operator">.</span>addFilter(<span class="keyword">this</span>);

        <span class="comment">// Do not report duplicated values</span>
        m_compassSensor<span class="operator">.</span>setSkipDuplicates(<span class="keyword">true</span>);

        <span class="comment">// Start gathering the data</span>
        m_compassSensor<span class="operator">.</span>start();
    }</pre>
<p>The 'bool filter(QCompassReading*)' method is called whenever the QCompass object retrieved new data from the hardware sensor. Inside this method we update our internal azimuth property with the new value from the sensor and emit the change notification signal if the new value differs from the previous one.</p>
<pre class="cpp">    <span class="type">bool</span> CompassSensor<span class="operator">::</span>filter(<span class="type">QCompassReading</span> <span class="operator">*</span>reading)
    {
        <span class="comment">// Store the previous azimuth</span>
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qreal-typedef">qreal</a></span> oldAzimuth <span class="operator">=</span> m_azimuth;

        m_azimuth <span class="operator">=</span> reading<span class="operator">-</span><span class="operator">&gt;</span>azimuth();

        <span class="comment">// Emit changed signal if azimuth has changed</span>
        <span class="keyword">if</span> (oldAzimuth <span class="operator">!</span><span class="operator">=</span> m_azimuth)
            <span class="keyword">emit</span> azimuthChanged();

        <span class="comment">// Do no further processing of the sensor data</span>
        <span class="keyword">return</span> <span class="keyword">false</span>;
    }</pre>
</div>
<!-- @@@compass -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Copyright 2012 Research In Motion Limited.
  <br />
    This document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
