<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- imageloader.qdoc -->
  <title>Cascades : Image Loader Example</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt-based BB10 API Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
<li><a href="http://qt.nokia.com/doc/4.7/all-examples.html">Examples</a></li>
<li>Image Loader Example</li>
    </ul>
  </div>
</div>
<div class="content mainContent">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#description">Description</a></li>
<li class="level1"><a href="#overview">Overview</a></li>
<li class="level1"><a href="#the-ui">The UI</a></li>
<li class="level1"><a href="#the-app-class">The App class</a></li>
<li class="level1"><a href="#the-imageloader-class">The ImageLoader class</a></li>
<li class="level1"><a href="#the-imageprocessor-class">The ImageProcessor class</a></li>
</ul>
</div>
<h1 class="title">Image Loader Example</h1>
<span class="subtitle"></span>
<!-- $$$imageloader-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="imageloader-assets-main-qml.html">imageloader/assets/main.qml</a></li>
<li><a href="imageloader-src-app-cpp.html">imageloader/src/app.cpp</a></li>
<li><a href="imageloader-src-app-hpp.html">imageloader/src/app.hpp</a></li>
<li><a href="imageloader-src-imageloader-cpp.html">imageloader/src/imageloader.cpp</a></li>
<li><a href="imageloader-src-imageloader-hpp.html">imageloader/src/imageloader.hpp</a></li>
<li><a href="imageloader-src-imageprocessor-cpp.html">imageloader/src/imageprocessor.cpp</a></li>
<li><a href="imageloader-src-imageprocessor-hpp.html">imageloader/src/imageprocessor.hpp</a></li>
<li><a href="imageloader-src-main-cpp.html">imageloader/src/main.cpp</a></li>
<li><a href="imageloader-imageloader-pro.html">imageloader/imageloader.pro</a></li>
</ul>
<a name="description"></a>
<h2>Description</h2>
<p>The Image Loader example demonstrates how to offload work intensive tasks into seperate work threads, and than report show their results asynchronously.</p>
<p class="centerAlign"><img src="images/imageloader-example.png" /></p><a name="overview"></a>
<h2>Overview</h2>
<p>In this example we'll learn how to use <tt>QNetworkAccessManager</tt> and <tt>QThread</tt> to download an image file asynchronously from the network and then offload the time-consuming task of converting the raw data into a <a href="http://qt.nokia.com/doc/4.7/qimage.html">QImage</a> and scaling it down to a proper size into a separated worker thread.</p>
<p>The actual code for downloading and processing the images is encapsulated inside the <tt>ImageLoader</tt> class. For each image we'll have one instance of this class and all these instances are stored inside a <tt>QListDataModel</tt> to make them easily accessible to the UI.</p>
<a name="the-ui"></a>
<h2>The UI</h2>
<p>When the application is started, a <tt>Button</tt> is shown at the center of the screen. If the user clicks on it, the <tt>Button</tt> is hidden and a <tt>ListView</tt> is shown instead which covers the complete screen. Additionally the loadImages() method is invoked on the <tt>App</tt> object, which has been exported to QML under the name '_app'.</p>
<pre class="qml">            <span class="comment">// The button to start the loading of the images</span>
            <span class="type">Button</span> {
                <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>
                <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Center</span>

                <span class="name">text</span>: <span class="name">qsTr</span>(<span class="string">&quot;Load images&quot;</span>)

                <span class="name">onClicked</span>: {
                    <span class="name">_app</span>.<span class="name">loadImages</span>()
                    <span class="name">visible</span> <span class="operator">=</span> <span class="number">false</span>
                    <span class="name">listView</span>.<span class="name">visible</span> <span class="operator">=</span> <span class="number">true</span>
                }
            }</pre>
<p>The 'model' property of the <tt>App</tt> object is bound against the 'dataModel' property of the <tt>ListView</tt>, so each <tt>ImageLoader</tt> from the model is represented by one item in the <tt>ListView</tt>.</p>
<pre class="qml">            <span class="comment">// The ListView that shows the progress of loading and result images</span>
            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qml-listview.html">ListView</a></span> {
                <span class="name">id</span>: <span class="name">listView</span>

                <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Fill</span>
                <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Fill</span>

                <span class="name">visible</span>: <span class="number">false</span>

                <span class="name">dataModel</span>: <span class="name">_app</span>.<span class="name">model</span></pre>
<p>Since we want to show an <tt>ActivityIndicator</tt> while the image is downloaded and processed, an <tt>ImageView</tt> when the image is finally available or a <tt>Label</tt> that shows an error message if any occurs, we have to implement our own <tt>ListItemComponent</tt>.</p>
<p>We simply put the three controls into a <tt>Container</tt> and change their 'visible' property depending on the 'loading' and 'label' property of the <tt>ImageLoader</tt>.</p>
<pre class="qml">                <span class="name">listItemComponents</span>: <span class="name">ListItemComponent</span> {
                    <span class="name">type</span>: <span class="string">&quot;&quot;</span>
                    <span class="type">Container</span> {
                        <span class="name">preferredHeight</span>: <span class="number">500</span>
                        <span class="name">preferredWidth</span>: <span class="number">768</span>

                        <span class="name">layout</span>: <span class="name">DockLayout</span> {}

                        <span class="comment">// The ActivityIndicator that is only active and visible while the image is loading</span>
                        <span class="type">ActivityIndicator</span> {
                            <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>
                            <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Center</span>
                            <span class="name">preferredHeight</span>: <span class="number">300</span>

                            <span class="name">visible</span>: <span class="name">ListItemData</span>.<span class="name">loading</span>
                            <span class="name">running</span>: <span class="name">ListItemData</span>.<span class="name">loading</span>
                        }

                        <span class="comment">// The ImageView that shows the loaded image after loading has finished without error</span>
                        <span class="type">ImageView</span> {
                            <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Fill</span>
                            <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Fill</span>

                            <span class="name">image</span>: <span class="name">ListItemData</span>.<span class="name">image</span>
                            <span class="name">visible</span>: !<span class="name">ListItemData</span>.<span class="name">loading</span> <span class="operator">&amp;&amp;</span> <span class="name">ListItemData</span>.<span class="name">label</span> <span class="operator">==</span> <span class="string">&quot;&quot;</span>
                        }

                        <span class="comment">// The Label that shows a possible error message after loading has finished</span>
                        <span class="type">Label</span> {
                            <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>
                            <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Center</span>
                            <span class="name">preferredWidth</span>: <span class="number">500</span>

                            <span class="name">visible</span>: !<span class="name">ListItemData</span>.<span class="name">loading</span> <span class="operator">&amp;&amp;</span> !<span class="name">ListItemData</span>.<span class="name">label</span> <span class="operator">==</span> <span class="string">&quot;&quot;</span>
                            <span class="name">text</span>: <span class="name">ListItemData</span>.<span class="name">label</span>
                            <span class="name">multiline</span>: <span class="number">true</span>
                        }
                    }
                }</pre>
<a name="the-app-class"></a>
<h2>The App class</h2>
<p>The <tt>App</tt> class is the central class in this application which loads the UI and provides the interaction between C++ and QML scope throught the 'model' property and the invokable loadImages() method.</p>
<pre class="cpp">    <span class="keyword">class</span> App : <span class="keyword">public</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>
    {
        Q_OBJECT

        <span class="comment">// The model that contains the progress and image data</span>
        Q_PROPERTY(bb<span class="operator">::</span>cascades<span class="operator">::</span>DataModel<span class="operator">*</span> model READ model CONSTANT)

    <span class="keyword">public</span>:
        App(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent <span class="operator">=</span> <span class="number">0</span>);

        <span class="comment">// This method is called to start the loading of all images.</span>
        Q_INVOKABLE <span class="type">void</span> loadImages();

    <span class="keyword">private</span>:
        <span class="comment">// The accessor method for the property</span>
        bb<span class="operator">::</span>cascades<span class="operator">::</span>DataModel<span class="operator">*</span> model() <span class="keyword">const</span>;

        <span class="comment">// The model that contains the progress and image data</span>
        bb<span class="operator">::</span>cascades<span class="operator">::</span><span class="type">QListDataModel</span><span class="operator">&lt;</span><span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span><span class="operator">*</span><span class="operator">&gt;</span><span class="operator">*</span> m_model;
    };</pre>
<p>Inside the constructor the model is created and filled with 10 <tt>ImageLoader</tt> objects, each responsible to load a different image from wikimedia.org. Since we want to access the properties (e.g&#x2e; 'loading' and 'label') of the <tt>ImageLoader</tt> objects in QML, we also have to register this type to QML.</p>
<p>At the end we load the UI from the main.qml file.</p>
<pre class="cpp">    App<span class="operator">::</span>App(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent)
        : <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>(parent)
        <span class="operator">,</span> m_model(<span class="keyword">new</span> <span class="type">QListDataModel</span><span class="operator">&lt;</span><span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span><span class="operator">*</span><span class="operator">&gt;</span>())
    {
        <span class="comment">// Register custom type to QML</span>
        qmlRegisterType<span class="operator">&lt;</span>ImageLoader<span class="operator">&gt;</span>();

        m_model<span class="operator">-</span><span class="operator">&gt;</span>setParent(<span class="keyword">this</span>);

        <span class="comment">// Fill the model with data</span>
        m_model<span class="operator">-</span><span class="operator">&gt;</span>append(<span class="keyword">new</span> ImageLoader(<span class="string">&quot;http://upload.wikimedia.org/wikipedia/commons/6/62/Peace_riding_in_a_triumphal_chariot_Bosio_Carrousel_-_2012-05-28.jpg&quot;</span><span class="operator">,</span> <span class="keyword">this</span>));
        m_model<span class="operator">-</span><span class="operator">&gt;</span>append(<span class="keyword">new</span> ImageLoader(<span class="string">&quot;http://upload.wikimedia.org/wikipedia/commons/a/af/Crepuscular_rays_with_reflection_in_GGP.jpg&quot;</span><span class="operator">,</span> <span class="keyword">this</span>));
        m_model<span class="operator">-</span><span class="operator">&gt;</span>append(<span class="keyword">new</span> ImageLoader(<span class="string">&quot;http://upload.wikimedia.org/wikipedia/commons/2/2a/Anodorhynchus_hyacinthinus_-Hyacinth_Macaw_-side_of_head.jpg&quot;</span><span class="operator">,</span> <span class="keyword">this</span>));
        m_model<span class="operator">-</span><span class="operator">&gt;</span>append(<span class="keyword">new</span> ImageLoader(<span class="string">&quot;http://upload.wikimedia.org/wikipedia/commons/2/29/Bataille_Waterloo_1815_reconstitution_2011_cuirassier.jpg&quot;</span><span class="operator">,</span> <span class="keyword">this</span>));
        m_model<span class="operator">-</span><span class="operator">&gt;</span>append(<span class="keyword">new</span> ImageLoader(<span class="string">&quot;http://upload.wikimedia.org/wikipedia/commons/e/ec/Armadillo_Aerospace_Pixel_Hover.jpg&quot;</span><span class="operator">,</span> <span class="keyword">this</span>));
        m_model<span class="operator">-</span><span class="operator">&gt;</span>append(<span class="keyword">new</span> ImageLoader(<span class="string">&quot;http://upload.wikimedia.org/wikipedia/commons/f/f5/A_sculpture_at_the_entrance_to_the_palace_of_Versailles.jpg&quot;</span><span class="operator">,</span> <span class="keyword">this</span>));
        m_model<span class="operator">-</span><span class="operator">&gt;</span>append(<span class="keyword">new</span> ImageLoader(<span class="string">&quot;http://upload.wikimedia.org/wikipedia/commons/6/6d/Firehole_river_at_Upper_Geyser_Basin-2008-june.jpg&quot;</span><span class="operator">,</span> <span class="keyword">this</span>));
        m_model<span class="operator">-</span><span class="operator">&gt;</span>append(<span class="keyword">new</span> ImageLoader(<span class="string">&quot;http://upload.wikimedia.org/wikipedia/commons/7/7c/Peugeot_206_WRC.jpg&quot;</span><span class="operator">,</span> <span class="keyword">this</span>));
        m_model<span class="operator">-</span><span class="operator">&gt;</span>append(<span class="keyword">new</span> ImageLoader(<span class="string">&quot;http://upload.wikimedia.org/wikipedia/commons/9/97/Toda_Hut.JPG&quot;</span><span class="operator">,</span> <span class="keyword">this</span>));
        m_model<span class="operator">-</span><span class="operator">&gt;</span>append(<span class="keyword">new</span> ImageLoader(<span class="string">&quot;http://upload.wikimedia.org/wikipedia/commons/d/dc/Marriott_Center_1.JPG&quot;</span><span class="operator">,</span> <span class="keyword">this</span>));

        <span class="comment">// Create the UI</span>
        QmlDocument<span class="operator">*</span> qml <span class="operator">=</span> QmlDocument<span class="operator">::</span>create(<span class="string">&quot;asset:///main.qml&quot;</span>)<span class="operator">.</span>parent(<span class="keyword">this</span>);
        qml<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(<span class="string">&quot;_app&quot;</span><span class="operator">,</span> <span class="keyword">this</span>);

        AbstractPane <span class="operator">*</span>root <span class="operator">=</span> qml<span class="operator">-</span><span class="operator">&gt;</span>createRootObject<span class="operator">&lt;</span>AbstractPane<span class="operator">&gt;</span>();
        Application<span class="operator">::</span>instance()<span class="operator">-</span><span class="operator">&gt;</span>setScene(root);
    }</pre>
<p>When the user clicks on the 'Load images' button in the UI, the loadImages() method is invoked. Inside this method we simply iterate over the <tt>ImageLoader</tt> objects inside the model and call their load() method to trigger the download of the image from the network.</p>
<pre class="cpp">    <span class="type">void</span> App<span class="operator">::</span>loadImages()
    {
        <span class="comment">// Call the load() method for each ImageLoader instance inside the model</span>
        <span class="keyword">for</span> (<span class="type">int</span> row <span class="operator">=</span> <span class="number">0</span>; row <span class="operator">&lt;</span> m_model<span class="operator">-</span><span class="operator">&gt;</span>size(); <span class="operator">+</span><span class="operator">+</span>row) {
            qobject_cast<span class="operator">&lt;</span>ImageLoader<span class="operator">*</span><span class="operator">&gt;</span>(m_model<span class="operator">-</span><span class="operator">&gt;</span>value(row))<span class="operator">-</span><span class="operator">&gt;</span>load();
        }
    }</pre>
<a name="the-imageloader-class"></a>
<h2>The ImageLoader class</h2>
<p>The <tt>ImageLoader</tt> class encapsulates the loading and processing of the images. The current state is made available to the UI through the 'loading' property, any error message through 'label' and the final image data through the 'image' property.</p>
<p>To download the image the <tt>QNetworkAccessManager</tt> class is used and afterwards the raw image data are converted and scaled inside a thread. Thread contexts are represented by the <tt>QThread</tt> class.</p>
<pre class="cpp">    <span class="keyword">class</span> ImageLoader : <span class="keyword">public</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>
    {
        Q_OBJECT

        Q_PROPERTY(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html">QVariant</a></span> image READ image NOTIFY imageChanged)
        Q_PROPERTY(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> label READ label NOTIFY labelChanged)

        Q_PROPERTY(<span class="type">bool</span> loading READ loading NOTIFY loadingChanged)

    <span class="keyword">public</span>:
        <span class="comment">/*
         * Creates a new image loader.
         *
         * @param imageUrl The url to load the image from.
         */</span>
        ImageLoader(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> <span class="operator">&amp;</span>imageUrl<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span><span class="operator">*</span> parent <span class="operator">=</span> <span class="number">0</span>);

        <span class="comment">/*
         * Destroys the image loader.
         */</span>
        <span class="operator">~</span>ImageLoader();

        <span class="comment">/*
         * Loads the image.
         */</span>
        <span class="type">void</span> load();

    Q_SIGNALS:
        <span class="comment">// The change notification signals of the properties</span>
        <span class="type">void</span> imageChanged();
        <span class="type">void</span> labelChanged();
        <span class="type">void</span> loadingChanged();

    <span class="keyword">private</span> Q_SLOTS:
        <span class="comment">/*
         * Response handler for the network operation.
         */</span>
        <span class="type">void</span> onReplyFinished();

        <span class="comment">/*
         * Response handler for the image process operation.
         */</span>
        <span class="type">void</span> onImageProcessingFinished(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qimage.html">QImage</a></span> <span class="operator">&amp;</span>image);

    <span class="keyword">private</span>:
        <span class="comment">// The accessor methods of the properties</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html">QVariant</a></span> image() <span class="keyword">const</span>;
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> label() <span class="keyword">const</span>;
        <span class="type">bool</span> loading() <span class="keyword">const</span>;

        <span class="comment">// The property values</span>
        bb<span class="operator">::</span>cascades<span class="operator">::</span>Image m_image;
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> m_label;
        <span class="type">bool</span> m_loading;

        <span class="comment">// The URL of the image that should be loaded</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> m_imageUrl;

        <span class="comment">// The thread context that processes the image</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpointer.html">QPointer</a></span><span class="operator">&lt;</span><span class="type"><a href="http://qt.nokia.com/doc/4.7/qthread.html">QThread</a></span><span class="operator">&gt;</span> m_thread;
    };</pre>
<p>Inside the constructor only the member variables are initialized.</p>
<pre class="cpp">    ImageLoader<span class="operator">::</span>ImageLoader(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> <span class="operator">&amp;</span>imageUrl<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span><span class="operator">*</span> parent)
        : <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>(parent)
        <span class="operator">,</span> m_loading(<span class="keyword">false</span>)
        <span class="operator">,</span> m_imageUrl(imageUrl)
    {
    }</pre>
<p>Inside the destructor we check whether the worker thread still exists. If that's the case, we wait for it to finish execution.</p>
<pre class="cpp">    ImageLoader<span class="operator">::</span><span class="operator">~</span>ImageLoader()
    {
        <span class="keyword">if</span> (m_thread)
            m_thread<span class="operator">-</span><span class="operator">&gt;</span>wait();
    }</pre>
<p>The load() method is called to start the download operation. Inside this method we first change the value of the 'loading' property to signal that we have started our work. Afterwards the <tt>QNetworkAccessManager</tt> object is created and a GET request with the image URL is issued. We connect the finished() signal of the returned <tt>QNetworkReply</tt> to our custom onReplyFinished() slot, so that we get informed when the download is done.</p>
<pre class="cpp">    <span class="type">void</span> ImageLoader<span class="operator">::</span>load()
    {
        m_loading <span class="operator">=</span> <span class="keyword">true</span>;
        <span class="keyword">emit</span> loadingChanged();

        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qnetworkaccessmanager.html">QNetworkAccessManager</a></span><span class="operator">*</span> netManager <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qnetworkaccessmanager.html">QNetworkAccessManager</a></span>(<span class="keyword">this</span>);

        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qurl.html">QUrl</a></span> url(m_imageUrl);
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qnetworkrequest.html">QNetworkRequest</a></span> request(url);

        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qnetworkreply.html">QNetworkReply</a></span><span class="operator">*</span> reply <span class="operator">=</span> netManager<span class="operator">-</span><span class="operator">&gt;</span>get(request);
        connect(reply<span class="operator">,</span> SIGNAL(finished())<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> SLOT(onReplyFinished()));
    }</pre>
<p>Inside the onReplyFinished() slot we check whether an error occurred. If that's the case we fill the 'label' property accordingly and signal that we have finished loading.</p>
<p>If the download was successful, we read the raw image data from the <tt>QNetworkReply</tt> and store them temporarily. In the next step a new <tt>ImageProcessor</tt> object is created. This one will convert the raw image data into a <a href="http://qt.nokia.com/doc/4.7/qimage.html">QImage</a> object and scale it down to a proper size. However since this operation can take a long time, we want to offload it into the worker thread.</p>
<p>So we create a new <tt>QThread</tt> instance and move the <tt>ImageProcessor</tt> object to the worker thread. Moving a <tt>QObject</tt> based object to a <tt>QThread</tt> means that the object is associated with this thread and further slot invocations will be executed inside this thread (see <a href="http://qt-project.org/doc/qt-4.8/threads-qobject.html">http://qt-project.org/doc/qt-4.8/threads-qobject.html</a>)</p>
<p>The <tt>QThread</tt> object will emit the started() signal once the thread context is set up. We connect this signal against the start() slot of the <tt>ImageProcessor</tt> object, so that this code will be executed inside the thread context. When the <tt>QThread</tt> has finished the execution of the thread context, it emits the finished() signal. We connect it against the <tt>QThread</tt>'s own deleteLater() slot, so that it is deleted automatically.</p>
<p>When the <tt>ImageProcessor</tt> has finished its work, it emits the finished(<a href="http://qt.nokia.com/doc/4.7/qimage.html">QImage</a>) signal. We connect this signal against two slots. Once against our custom onImageProcessingFinished() slot, where we use the converted and scaled image, and once against the quit() slot of the <tt>QThread</tt> to trigger its termination.</p>
<p>In the last step we trigger the start of the <tt>QThread</tt> object.</p>
<pre class="cpp">    <span class="type">void</span> ImageLoader<span class="operator">::</span>onReplyFinished()
    {
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qnetworkreply.html">QNetworkReply</a></span><span class="operator">*</span> reply <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span><span class="type"><a href="http://qt.nokia.com/doc/4.7/qnetworkreply.html">QNetworkReply</a></span><span class="operator">*</span><span class="operator">&gt;</span>(sender());

        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> response;
        <span class="keyword">if</span> (reply) {
            <span class="keyword">if</span> (reply<span class="operator">-</span><span class="operator">&gt;</span>error() <span class="operator">=</span><span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qnetworkreply.html">QNetworkReply</a></span><span class="operator">::</span>NoError) {
                <span class="keyword">const</span> <span class="type">int</span> available <span class="operator">=</span> reply<span class="operator">-</span><span class="operator">&gt;</span>bytesAvailable();
                <span class="keyword">if</span> (available <span class="operator">&gt;</span> <span class="number">0</span>) {
                    <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qbytearray.html">QByteArray</a></span> data(reply<span class="operator">-</span><span class="operator">&gt;</span>readAll());

                    <span class="comment">// Setup the image processing thread</span>
                    ImageProcessor <span class="operator">*</span>imageProcessor <span class="operator">=</span> <span class="keyword">new</span> ImageProcessor(data);
                    m_thread <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qthread.html">QThread</a></span>(<span class="keyword">this</span>);

                    <span class="comment">// Move the image processor to the worker thread</span>
                    imageProcessor<span class="operator">-</span><span class="operator">&gt;</span>moveToThread(m_thread);

                    <span class="comment">// Invoke ImageProcessor's start() slot as soon as the worker thread has started</span>
                    connect(m_thread<span class="operator">,</span> SIGNAL(started())<span class="operator">,</span> imageProcessor<span class="operator">,</span> SLOT(start()));

                    <span class="comment">// Delete the worker thread automatically after it has finished</span>
                    connect(m_thread<span class="operator">,</span> SIGNAL(finished())<span class="operator">,</span> m_thread<span class="operator">,</span> SLOT(deleteLater()));

                    <span class="comment">/*
                     * Invoke our onProcessingFinished slot after the processing has finished.
                     * Since imageProcessor and 'this' are located in different threads we use 'QueuedConnection' to
                     * allow a cross-thread boundary invocation. In this case the QImage parameter is copied in a thread-safe way
                     * from the worker thread to the main thread.
                     */</span>
                    connect(imageProcessor<span class="operator">,</span> SIGNAL(finished(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qimage.html">QImage</a></span>))<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> SLOT(onImageProcessingFinished(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qimage.html">QImage</a></span>))<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qt.html">Qt</a></span><span class="operator">::</span>QueuedConnection);

                    <span class="comment">// Terminate the thread after the processing has finished</span>
                    connect(imageProcessor<span class="operator">,</span> SIGNAL(finished(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qimage.html">QImage</a></span>))<span class="operator">,</span> m_thread<span class="operator">,</span> SLOT(quit()));

                    m_thread<span class="operator">-</span><span class="operator">&gt;</span>start();
                }
            } <span class="keyword">else</span> {
                m_label <span class="operator">=</span> tr(<span class="string">&quot;Error: %1 status: %2&quot;</span>)<span class="operator">.</span>arg(reply<span class="operator">-</span><span class="operator">&gt;</span>errorString()<span class="operator">,</span> reply<span class="operator">-</span><span class="operator">&gt;</span>attribute(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qnetworkrequest.html">QNetworkRequest</a></span><span class="operator">::</span>HttpStatusCodeAttribute)<span class="operator">.</span>toString());
                <span class="keyword">emit</span> labelChanged();

                m_loading <span class="operator">=</span> <span class="keyword">false</span>;
                <span class="keyword">emit</span> loadingChanged();
            }

            reply<span class="operator">-</span><span class="operator">&gt;</span>deleteLater();
        } <span class="keyword">else</span> {
            m_label <span class="operator">=</span> tr(<span class="string">&quot;Download failed. Check internet connection&quot;</span>);
            <span class="keyword">emit</span> labelChanged();

            m_loading <span class="operator">=</span> <span class="keyword">false</span>;
            <span class="keyword">emit</span> loadingChanged();
        }
    }</pre>
<p>Inside the onImageProcessingFinished() slot, we convert the <a href="http://qt.nokia.com/doc/4.7/qimage.html">QImage</a> into a bb::Image object, since the <tt>ImageView</tt> in the UI can only use the latter as input. The bb::Image object is used as value for the 'image' property.</p>
<p>Furthermore we clear the content of the 'label' property and change the 'loading' property to 'false' to signal that we have finished the operation.</p>
<pre class="cpp">    <span class="type">void</span> ImageLoader<span class="operator">::</span>onImageProcessingFinished(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qimage.html">QImage</a></span> <span class="operator">&amp;</span>image)
    {
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qimage.html">QImage</a></span> swappedImage <span class="operator">=</span> image<span class="operator">.</span>rgbSwapped();
        <span class="keyword">const</span> bb<span class="operator">::</span>ImageData imageData <span class="operator">=</span> bb<span class="operator">::</span>ImageData<span class="operator">::</span>fromPixels(swappedImage<span class="operator">.</span>bits()<span class="operator">,</span> bb<span class="operator">::</span>PixelFormat<span class="operator">::</span>RGBX<span class="operator">,</span> swappedImage<span class="operator">.</span>width()<span class="operator">,</span> swappedImage<span class="operator">.</span>height()<span class="operator">,</span> swappedImage<span class="operator">.</span>bytesPerLine());

        m_image <span class="operator">=</span> bb<span class="operator">::</span>cascades<span class="operator">::</span>Image(imageData);
        <span class="keyword">emit</span> imageChanged();

        m_label<span class="operator">.</span>clear();
        <span class="keyword">emit</span> labelChanged();

        m_loading <span class="operator">=</span> <span class="keyword">false</span>;
        <span class="keyword">emit</span> loadingChanged();
    }</pre>
<a name="the-imageprocessor-class"></a>
<h2>The ImageProcessor class</h2>
<p>The <tt>ImageProcessor</tt> class encapsulates the conversion of the raw image data into a <a href="http://qt.nokia.com/doc/4.7/qimage.html">QImage</a> and the following scaling. Its API is designed to be used inside a thread by providing a start() slot, which is invoked as a result of the <tt>QThread</tt>'s started() signal, and a finished() signal, which is connected against the <tt>QThread</tt>'s quit() slot to stop the event loop inside the thread.</p>
<p>The raw image data are passed in via the constructor and the scaled down <tt>QImage</tt> object is passed back as parameter of the finished() signal.</p>
<pre class="cpp">    <span class="keyword">class</span> ImageProcessor : <span class="keyword">public</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>
    {
        Q_OBJECT

    <span class="keyword">public</span>:
        <span class="comment">/*
         * Creates a new image processor.
         *
         * @param imageData The raw image data.
         * @param parent The parent object.
         */</span>
        ImageProcessor(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qbytearray.html">QByteArray</a></span> <span class="operator">&amp;</span>imageData<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent <span class="operator">=</span> <span class="number">0</span>);

    <span class="keyword">public</span> Q_SLOTS:
        <span class="comment">/*
         * Starts the actual operation.
         */</span>
        <span class="type">void</span> start();

    Q_SIGNALS:
        <span class="comment">/*
         * This signal is emitted after the operation has finished.
         *
         * @param image The processed image.
         */</span>
        <span class="type">void</span> finished(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qimage.html">QImage</a></span> <span class="operator">&amp;</span>image);

    <span class="keyword">private</span>:
        <span class="comment">// The raw image data</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qbytearray.html">QByteArray</a></span> m_data;
    };</pre>
<p>Inside the constructor we just store the raw image data in a member variable, so that we have access to it later on in the start() slot.</p>
<pre class="cpp">    ImageProcessor<span class="operator">::</span>ImageProcessor(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qbytearray.html">QByteArray</a></span> <span class="operator">&amp;</span>imageData<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent)
        : <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>(parent)
        <span class="operator">,</span> m_data(imageData)
    {
    }</pre>
<p>The start() slot is the part of the class where the actual work happens. We first convert the raw image data into a <a href="http://qt.nokia.com/doc/4.7/qimage.html">QImage</a> object by using the loadFromData() convenience method. <a href="http://qt.nokia.com/doc/4.7/qimage.html">QImage</a> supports a wide range of image types and support for custom types can be added by implementing new plugins. In our example however we only load JPEG images, which <a href="http://qt.nokia.com/doc/4.7/qimage.html">QImage</a> supports out of the box.</p>
<p>In the second step we scale down the image to 768x500 pixels to make them fit inside the <tt>ListView</tt>.</p>
<p>In the last step we emit the finished signal to notify that we are done.</p>
<pre class="cpp">    <span class="type">void</span> ImageProcessor<span class="operator">::</span>start()
    {
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qimage.html">QImage</a></span> image;

        image<span class="operator">.</span>loadFromData(m_data);

        image <span class="operator">=</span> image<span class="operator">.</span>scaled(<span class="number">768</span><span class="operator">,</span> <span class="number">500</span><span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qt.html">Qt</a></span><span class="operator">::</span>KeepAspectRatioByExpanding);

        <span class="comment">// Image processing goes here, example could be adding water mark to the downloaded image</span>

        <span class="keyword">emit</span> finished(image);
    }</pre>
<p><b>Note:</b> Since signal/slot connections across thread boundaries are no direct method calls (unlike signal/slot connections in the same thread), but are based on event delivery, passing parameters in the signal is thread-safe, because a copy of the parameters is created and the copy is sent to the receiver thread.</p>
</div>
<!-- @@@imageloader -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Copyright 2012 Research In Motion Limited.
  <br />
    This document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
